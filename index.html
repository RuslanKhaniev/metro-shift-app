<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MetroTime Pro v88.4 (Scroll Fix)</title>

    <script type="text/javascript" >
       (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
       m[i].l=1*new Date();
       for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
       k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
       (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");

       ym(105574700, "init", {
            clickmap:true,
            trackLinks:true,
            accurateTrackBounce:true,
            webvisor:true
       });
    </script>
    <noscript><div><img src="https://mc.yandex.ru/watch/105574700" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --primary: #37474f; --accent: #ffab00; --bg: #f5f7fa; --card: #ffffff; --text: #263238;
            --nav-inactive: #90a4ae;
            --col-work-bg: #e8f5e9; --col-work-txt: #2e7d32;
            --col-sick-bg: #fff9c4; --col-sick-txt: #fbc02d; --col-sick-border: #fff59d;
            --col-donor-bg: #f3e5f5; --col-donor-txt: #ab47bc; --col-donor-border: #e1bee7;
            --col-train-bg: #e0f7fa; --col-train-txt: #006064; --col-train-border: #b2ebf2;
            --col-weekend-txt: #e53935; --col-holiday-bg: #ffebee; --col-holiday-border: #ef5350; 
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Roboto", sans-serif; background-color: var(--bg); margin: 0; padding: 0; color: var(--text); padding-bottom: 90px; padding-top: 60px; -webkit-tap-highlight-color: transparent; }
        
        body.modal-open { overflow: hidden; height: 100vh; position: fixed; width: 100%; touch-action: none; }

        /* HEADER */
        header { background-color: var(--card); color: var(--text); height: 60px; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); position: fixed; top: 0; left: 0; right: 0; z-index: 100; }
        h1 { font-size: 22px; font-weight: 800; letter-spacing: -0.5px; margin: 0; color: var(--primary); }
        .header-btn { background: #f0f2f5; border: none; cursor: pointer; color: var(--primary); padding: 10px; border-radius: 12px; transition: 0.2s; } .header-btn:active { transform: scale(0.95); } .header-btn svg { width: 24px; height: 24px; fill: currentColor; }

        /* LOADER */
        #loader { position: fixed; top:0; left:0; right:0; bottom:0; background: var(--bg); z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: opacity 0.3s; pointer-events: none; opacity: 0;}
        .spinner { width: 40px; height: 40px; border: 4px solid #cfd8dc; border-top: 4px solid var(--accent); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .loader-text { margin-top: 15px; font-weight: 600; color: var(--primary); font-size: 14px; }
        .loader-active { opacity: 1 !important; pointer-events: all !important; }

        /* PAGES */
        .page { display: none; padding: 20px; animation: fadeIn 0.3s ease; } .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* WIDGETS */
        .hero-widget { border-radius: 24px; padding: 25px; color: white; box-shadow: 0 15px 30px rgba(0,0,0,0.15); margin-bottom: 20px; position: relative; overflow: hidden; }
        .theme-work { background: linear-gradient(135deg, #263238 0%, #37474f 100%); }
        .theme-rest { background: linear-gradient(135deg, #0288d1 0%, #26c6da 100%); }
        .widget-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; opacity: 0.9; }
        .widget-title { font-size: 13px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; }
        .widget-main-value { font-size: 52px; font-weight: 800; letter-spacing: -1px; line-height: 1; margin-bottom: 5px; }
        .widget-sub-value { font-size: 15px; opacity: 0.9; font-weight: 600; background: rgba(255,255,255,0.2); padding: 4px 10px; border-radius: 8px; display: inline-block; margin-bottom: 15px;}
        .progress-track { background: rgba(255,255,255,0.2); height: 6px; border-radius: 4px; margin-top: 20px; overflow: hidden; }
        .progress-fill { height: 100%; border-radius: 4px; transition: width 1s linear; background: white; }
        .theme-work .progress-fill { background: var(--accent); }
        .progress-labels { display: flex; justify-content: space-between; margin-top: 8px; font-size: 12px; font-weight: 600; opacity: 0.9; }
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .info-card { background: white; padding: 15px; border-radius: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); text-align: center; }
        .info-label { font-size: 11px; color: #90a4ae; font-weight: 700; text-transform: uppercase; margin-bottom: 6px; }
        .info-val { font-size: 17px; font-weight: 700; color: var(--primary); }

        /* LIST & CALENDAR */
        .month-header { font-size: 14px; font-weight: 800; color: var(--nav-inactive); margin: 10px 0 15px 5px; text-transform: uppercase; letter-spacing: 1px; }
        .shift-card { background: white; border-radius: 16px; padding: 15px; margin-bottom: 12px; display: flex; align-items: center; box-shadow: 0 2px 8px rgba(0,0,0,0.04); cursor: pointer; transition: transform 0.1s; position: relative; overflow: hidden;}
        .shift-card:active { transform: scale(0.98); }
        .shift-card.today { border: 2px solid var(--accent); background-color: #fffde7; }
        .today-badge { position: absolute; top: 0; right: 0; background: var(--accent); color: white; font-size: 10px; padding: 3px 8px; border-bottom-left-radius: 10px; font-weight: bold; z-index: 10; }
        .date-box { background: #f0f2f5; min-width: 50px; height: 50px; border-radius: 12px; display: flex; flex-direction: column; align-items: center; justify-content: center; margin-right: 16px; color: var(--primary); }
        .date-day { font-size: 20px; font-weight: 800; line-height: 1; }
        .date-dow { font-size: 11px; text-transform: uppercase; margin-top: 3px; font-weight: 600; color: #78909c;}
        .shift-info { flex-grow: 1; min-width: 0; }
        .shift-title { font-weight: 700; font-size: 16px; display: flex; align-items: center; gap: 8px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .shift-sub { font-size: 13px; color: #78909c; margin-top: 4px; font-weight: 500; }
        .money-val { color: #2e7d32; font-weight: 800; font-size: 16px; }
        .money-val.future { color: #90a4ae; font-weight: 600; }

        .cal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .cal-title { font-size: 18px; font-weight: 700; }
        .cal-btn { background: none; border: none; font-size: 24px; color: var(--primary); cursor: pointer; padding: 5px 15px; }
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; width: 100%; }
        .cal-day-name { text-align: center; font-size: 11px; color: #b0bec5; font-weight: 700; padding-bottom: 10px; }
        .cal-cell { background: #f7f9fc; border-radius: 10px; height: 55px; display: flex; flex-direction: column; align-items: center; padding-top: 4px; font-size: 12px; position: relative; border: 2px solid transparent; cursor: pointer; min-width: 0; }
        .cal-num { font-weight: 700; font-size: 12px; margin-bottom: 2px; color: #546e7a; }
        .cal-shift { font-size: 9px; text-align: center; line-height: 1.1; width: 100%; overflow: hidden; text-overflow: ellipsis; padding: 0 2px; font-weight: 600;}
        .cal-cell.today { border-color: var(--accent); background: #fff; }
        .cal-cell.today .cal-num { color: var(--accent); }
        .cal-cell.weekend .cal-num { color: var(--col-weekend-txt); }
        .cal-cell.type-work { background: var(--col-work-bg); color: var(--col-work-txt); }
        .cal-cell.type-off { background: white; color: #cfd8dc; }
        .cal-cell.type-sick { background: var(--col-sick-bg) !important; color: #f9a825 !important; border-color: var(--col-sick-border); }
        .cal-cell.type-train { background: var(--col-train-bg) !important; color: var(--col-train-txt) !important; border-color: var(--col-train-border); }
        .cal-cell.type-donor { background: var(--col-donor-bg) !important; color: var(--col-donor-txt) !important; border-color: var(--col-donor-border); }
        .cal-cell.holiday { background: var(--col-holiday-bg); border-color: var(--col-holiday-border); }
        .cal-cell.holiday .cal-num { color: var(--col-weekend-txt); } 
        .cal-cell.holiday.has-shift.type-work { background: var(--col-work-bg); border-color: var(--col-holiday-border); }
        .cal-cell.holiday.has-shift.type-work .cal-num { color: var(--col-weekend-txt); font-weight: 900; }
        .cal-cell.empty { background: transparent; cursor: default; }

        .tag { font-size: 9px; padding: 3px 8px; border-radius: 6px; color: white; font-weight: bold; letter-spacing: 0.5px; display:inline-block; margin-left:2px;}
        .tag.gray { background: #90a4ae; } .tag.orange { background: var(--accent); } .tag.teal { background: #009688; } .tag.indigo { background: #5c6bc0; }
        
        .fab-container { position: fixed; bottom: 90px; right: 20px; display: flex; align-items: center; gap: 15px; z-index: 2000; pointer-events: auto; }
        .fab-main { background: var(--accent); color: white; width: 60px; height: 60px; border-radius: 50%; display: flex; justify-content: center; align-items: center; box-shadow: 0 8px 20px rgba(255, 171, 0, 0.4); cursor: pointer; border: none; transition: transform 0.2s; -webkit-tap-highlight-color: transparent; } .fab-main:active { transform: scale(0.9); } .fab-main svg { width: 30px; height: 30px; fill: white; pointer-events: none; }
        .fab-secondary { background: white; color: var(--primary); width: 50px; height: 50px; border-radius: 50%; display: flex; justify-content: center; align-items: center; box-shadow: 0 5px 15px rgba(0,0,0,0.1); cursor: pointer; border: none; transition: transform 0.2s; -webkit-tap-highlight-color: transparent;} .fab-secondary:active { transform: scale(0.9); } .fab-secondary svg { width: 24px; height: 24px; fill: currentColor; pointer-events: none; }
        
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; height: 70px; background: white; border-top: 1px solid #f0f0f0; display: flex; justify-content: space-around; align-items: center; z-index: 1000; padding-bottom: env(safe-area-inset-bottom); box-shadow: 0 -5px 20px rgba(0,0,0,0.03); }
        .nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--nav-inactive); font-size: 10px; font-weight: 600; width: 100%; height: 100%; cursor: pointer; transition: all 0.2s; } .nav-item.active { color: var(--primary); transform: translateY(-2px); } .nav-item svg { width: 26px; height: 26px; fill: currentColor; margin-bottom: 4px; }

        .chart-container { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px 0; position: relative; }
        .circular-chart { display: block; margin: 0 auto; max-width: 80%; max-height: 250px; }
        .circle-bg { fill: none; stroke: #eee; stroke-width: 3.8; }
        .circle { fill: none; stroke-width: 2.8; stroke-linecap: round; transition: stroke-dasharray 0.6s ease; }
        .chart-text-group { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -40%); text-align: center; }
        .chart-val { font-size: 32px; font-weight: 800; color: var(--primary); display: block; line-height: 1;}
        .chart-label { font-size: 12px; color: #90a4ae; font-weight: 600; text-transform: uppercase; margin-top: 5px; display: block;}
        .stat-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #f0f0f0; font-size: 14px;} .stat-row:last-child { border-bottom: none; }
        .stat-val { font-weight: 700; color: var(--primary); }
        .stat-sub-val { font-size: 12px; color:#90a4ae; font-weight: 600; margin-right: 8px;}
        .card { background: var(--card); border-radius: 20px; padding: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); margin-bottom: 15px; }
        .month-selector { display: flex; align-items: center; justify-content: center; background: #f0f2f5; border-radius: 12px; padding: 4px 8px; min-width: 160px; gap: 15px; }
        .month-btn { background: none; border: none; padding: 8px; cursor: pointer; color: var(--primary); font-size: 20px; font-weight: bold; flex-shrink: 0; display: flex; align-items: center; justify-content: center; }
        .month-display { font-size: 14px; font-weight: 700; text-align: center; white-space: nowrap; min-width: 110px; }

        input[type="text"], input[type="number"], textarea, select { width: 100%; padding: 14px; border: 1px solid #e0e0e0; border-radius: 12px; box-sizing: border-box; font-size: 16px; margin-top: 8px; background: #f9f9f9; font-family: inherit; font-weight: 500;}
        input:focus, textarea:focus, select:focus { outline: none; border-color: var(--primary); background: white; }
        label { font-size: 11px; color: #78909c; font-weight: 800; text-transform: uppercase; margin-top: 18px; display: block; letter-spacing: 0.5px;}
        
        .modal-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(38, 50, 56, 0.8); backdrop-filter: blur(4px); 
            display: none; justify-content: center; align-items: center; 
            z-index: 5000; touch-action: none;
        }
        #addModal { z-index: 6000; } 
        .modal-overlay.open { display: flex; animation: fadeIn 0.2s; }
        
        .modal-box { 
            background: white; padding: 25px; border-radius: 24px; 
            width: 90%; max-width: 360px; min-width: 300px; 
            box-shadow: 0 20px 60px rgba(0,0,0,0.4); 
            max-height: 85vh; overflow-y: auto;
            position: relative;
            z-index: 6001; 
            transform: translate3d(0,0,0);
        }
        
        .btn-row { display: flex; justify-content: flex-end; margin-top: 25px; gap: 10px; }
        .btn { padding: 12px 24px; border-radius: 12px; border: none; font-weight: 700; cursor: pointer; font-size: 15px; transition: 0.2s;} .btn:active { transform: scale(0.96); }
        .btn-cancel { background: transparent; color: #78909c; } .btn-save { background: var(--primary); color: white; } .btn-delete { background: #ffebee; color: #d32f2f; }
        .btn-text { background: none; border: none; color: var(--accent); font-size: 11px; font-weight: bold; cursor: pointer; text-decoration: underline; margin-top: 5px; display: block; text-align: right;}
        details { margin-top: 15px; border: 1px solid #eee; border-radius: 12px; padding: 15px; } summary { font-size: 13px; font-weight: 700; color: var(--primary); cursor: pointer; outline: none; }
        .detail-row { display: flex; justify-content: space-between; align-items: center; margin-top: 12px; } .detail-row label { margin: 0; font-size: 13px; color: #455a64; font-weight: 500;} .detail-row input[type="checkbox"] { width: 24px; height: 24px; margin: 0; accent-color: var(--accent);} .detail-row input[type="text"] { width: 90px; padding: 8px; font-size: 14px; margin: 0; } .line-input-row { display: flex; gap: 10px; margin-top: 5px; }
    </style>
</head>
<body>

    <div id="loader">
        <div class="spinner"></div>
        <div class="loader-text">–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è...</div>
    </div>

    <header>
        <h1 id="headerTitle">–ú–æ–∏ —Å–º–µ–Ω—ã</h1>
        <button class="header-btn" onclick="openImportModal()" title="–ò–º–ø–æ—Ä—Ç"><svg viewBox="0 0 24 24"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg></button>
    </header>

    <div id="tab-today" class="page"><div id="todayContent"></div></div>

    <div id="tab-home" class="page active">
        <div id="shiftList"></div>
        <div class="fab-container">
            <button class="fab-secondary" onclick="openCalendarModal()"><svg viewBox="0 0 24 24"><path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20a2 2 0 0 0 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V10h14v10zM9 14H7v-2h2v2zm4 0h-2v-2h2v2zm4 0h-2v-2h2v2zm-8 4H7v-2h2v2zm4 0h-2v-2h2v2zm4 0h-2v-2h2v2z"/></svg></button>
            <button class="fab-main" onclick="openModal()"><svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6V13z"/></svg></button>
        </div>
    </div>

    <div id="tab-stats" class="page">
        <div class="card">
            <h3 style="margin-top:0; color:var(--primary); display:flex; justify-content:space-between; align-items:center;">
                <span>üìä –°–≤–æ–¥–∫–∞</span>
                <div class="month-selector"><button class="month-btn" onclick="changeStatsMonth(-1)">&#8249;</button><div class="month-display" id="statsMonthDisplay"></div><button class="month-btn" onclick="changeStatsMonth(1)">&#8250;</button></div>
            </h3>
            <div class="chart-container">
                <svg viewBox="0 0 36 36" class="circular-chart"><path class="circle-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" /><path class="circle" stroke="#ffab00" stroke-dasharray="0, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" id="circlePath" /></svg>
                <div class="chart-text-group"><span class="chart-val" id="chartValue">0</span><span class="chart-label">–ß–∞—Å–æ–≤</span></div>
            </div>
            <div class="stat-row"><span>–ù–æ—Ä–º–∞ (36—á):</span> <span class="stat-val" id="st_norm">0</span></div>
            <div class="stat-row"><span>–û—Ç—Ä–∞–±–æ—Ç–∞–Ω–æ:</span> <span class="stat-val" id="st_hours">0</span></div>
            <div class="stat-row" style="background:#fff3e0; margin:0 -10px; padding:10px; border-radius:8px; margin-bottom:5px;"><span>–ü–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∞:</span> <span class="stat-val" id="st_over" style="font-size:16px;">0</span></div>
        </div>
        <div class="card">
            <h3 style="margin-top:0; color:var(--primary)">üí∞ –†–∞—Å—á–µ—Ç</h3>
            <div class="stat-row"><span>–í–µ—á–µ—Ä–Ω–∏–µ (20%):</span> <div style="text-align:right"><span class="stat-sub-val" id="st_ev_hours">0—á</span><span class="stat-val" id="st_ev_money">0 ‚ÇΩ</span></div></div>
            <div class="stat-row"><span>–ù–æ—á–Ω—ã–µ (40%):</span> <div style="text-align:right"><span class="stat-sub-val" id="st_night_hours">0—á</span><span class="stat-val" id="st_night_money">0 ‚ÇΩ</span></div></div>
            <div class="stat-row"><span>–†–∞–∑—Ä—ã–≤–Ω—ã–µ (30%):</span> <div style="text-align:right"><span class="stat-sub-val" id="st_split_hours">0—á</span><span class="stat-val" id="st_split_money">0 ‚ÇΩ</span></div></div>
            <div class="stat-row"><span>–ü–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∞ (1.5—Ö):</span> <div style="text-align:right"><span class="stat-sub-val" id="st_ot15_hours">0—á</span><span class="stat-val" id="st_ot15_money">0 ‚ÇΩ</span></div></div>
            <div class="stat-row"><span>–ü–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∞ (2.0—Ö):</span> <div style="text-align:right"><span class="stat-sub-val" id="st_ot20_hours">0—á</span><span class="stat-val" id="st_ot20_money">0 ‚ÇΩ</span></div></div>
            <div style="border-top:1px solid #eee; margin:10px 0;"></div>
            <div class="stat-row"><span id="lbl_class">–ö–ª–∞—Å—Å–Ω–æ—Å—Ç—å:</span> <span class="stat-val" id="st_class_money">0 ‚ÇΩ</span></div>
            <div class="stat-row"><span id="lbl_sen">–í—ã—Å–ª—É–≥–∞:</span> <span class="stat-val" id="st_sen_money">0 ‚ÇΩ</span></div>
            <div class="stat-row"><span id="lbl_prem">–ü—Ä–µ–º–∏—è:</span> <span class="stat-val" id="st_prem_money">0 ‚ÇΩ</span></div>
            <div class="stat-row" id="row_tech" style="display:none;"><span>–¢–µ—Ö. —É—á–µ–±–∞:</span> <span class="stat-val" id="st_tech_money">0 ‚ÇΩ</span></div>
            <div class="stat-row" id="row_senior" style="display:none;"><span id="lbl_senior">–°—Ç. –º–∞—à–∏–Ω–∏—Å—Ç:</span> <span class="stat-val" id="st_senior_money">0 ‚ÇΩ</span></div>
            <div class="stat-row" id="row_mentor" style="display:none;"><span id="lbl_mentor">–ù–∞—Å—Ç–∞–≤–Ω–∏–∫:</span> <div style="text-align:right"><span class="stat-sub-val" id="st_mentor_hours">0—á</span><span class="stat-val" id="st_mentor_money">0 ‚ÇΩ</span></div></div>
            <div style="border-top:2px solid #eee; margin:10px 0;"></div>
            <div class="stat-row"><span>–ù–∞—á–∏—Å–ª–µ–Ω–æ:</span> <span class="stat-val" id="st_dirty">0 ‚ÇΩ</span></div>
            <div class="stat-row"><span>–ü—Ä–æ—Ñ—Å–æ—é–∑ (1%):</span> <span class="stat-val" id="st_union" style="color:#e53935">0 ‚ÇΩ</span></div>
            <div class="stat-row"><span>–ù–∞–ª–æ–≥ (13%):</span> <span class="stat-val" id="st_tax" style="color:#e57373">0 ‚ÇΩ</span></div>
            <div class="stat-row" style="font-size:20px; border-top:2px solid #eee; margin-top:10px; padding-top:15px"><span>–ù–∞ —Ä—É–∫–∏:</span> <span class="stat-val" id="st_net" style="color:#2e7d32">0 ‚ÇΩ</span></div>
        </div>
    </div>

    <div id="tab-settings" class="page">
        <div class="card">
            <h3 style="margin-top:0; color:var(--primary)">‚öôÔ∏è –ü—Ä–æ—Ñ–∏–ª—å</h3>
            <label>–¢–∞—Ä–∏—Ñ (–û—Å–Ω–æ–≤–Ω–æ–π)</label><input type="text" inputmode="decimal" id="set_rate" onchange="saveAll()">
            <label>–ö–ª–∞—Å—Å –∫–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏–∏</label><select id="set_class" onchange="saveAll()"><option value="0">–ë–µ–∑ –∫–ª–∞—Å—Å–∞</option><option value="30">1 –∫–ª–∞—Å—Å (30%)</option><option value="20">2 –∫–ª–∞—Å—Å (20%)</option><option value="10">3 –∫–ª–∞—Å—Å (10%)</option></select>
            <label>–î–∞—Ç–∞ —Ç—Ä—É–¥–æ—É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</label><input type="date" id="set_start_date" onchange="saveAll()">
            <div style="font-size:13px; color:var(--primary); margin-top:8px; text-align:right; font-weight:600;" id="set_exp_text"></div>
            <label>–ü—Ä–µ–º–∏—è (%)</label><input type="text" inputmode="decimal" id="set_prem" onchange="saveAll()">
            <div style="margin-top:25px; display:flex; align-items:center; padding:12px; background:#e3f2fd; border-radius:12px;"><input type="checkbox" id="set_mentor" style="width:24px; height:24px; margin:0;" onchange="saveAll()"><span style="margin-left:12px; font-weight:700; color:#1565c0; font-size:14px;">–ù–∞—Å—Ç–∞–≤–Ω–∏–∫ (+15%)</span></div>
            <div style="margin-top:10px; display:flex; align-items:center; padding:12px; background:#e3f2fd; border-radius:12px;"><input type="checkbox" id="set_senior" style="width:24px; height:24px; margin:0;" onchange="saveAll()"><span style="margin-left:12px; font-weight:700; color:#1565c0; font-size:14px;">–°—Ç. –º–∞—à–∏–Ω–∏—Å—Ç (+10%)</span></div>
            <div style="margin-top:10px; display:flex; align-items:center; padding:12px; background:#e3f2fd; border-radius:12px;"><input type="checkbox" id="set_union" style="width:24px; height:24px; margin:0;" onchange="saveAll()"><span style="margin-left:12px; font-weight:700; color:#1565c0; font-size:14px;">–ß–ª–µ–Ω –ø—Ä–æ—Ñ—Å–æ—é–∑–∞ (-1%)</span></div>
            
            <div style="margin-top:30px; padding:15px; background:#fff3e0; border-radius:12px; text-align:center;">
                <div id="cloudStatus" style="font-size:12px; font-weight:bold; color:#f57c00; margin-bottom:10px;">–°—Ç–∞—Ç—É—Å –æ–±–ª–∞–∫–∞: –ü—Ä–æ–≤–µ—Ä–∫–∞...</div>
                <button onclick="forcePushToCloud()" style="background:#ff9800; color:white; border:none; padding:10px 15px; border-radius:10px; font-weight:bold; width:100%;">üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ –û–±–ª–∞–∫–æ</button>
                <div style="font-size:10px; color:#8d6e63; margin-top:5px;">–ù–∞–∂–º–∏, –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ –µ—Å—Ç—å, –∞ –Ω–∞ –ü–ö –Ω–µ—Ç.</div>
            </div>
        </div>
        <div style="text-align:center; font-size:11px; color:#b0bec5; margin-top:20px;">MetroTime v88.4 (Scroll Fix)</div>
    </div>

    <div class="modal-overlay" id="addModal"><div class="modal-box"><h3 style="margin-top:0; color:var(--primary)" id="modalTitle">–ù–æ–≤–∞—è —Å–º–µ–Ω–∞</h3><label>–î–∞—Ç–∞</label><input type="date" id="inpDate"><label>–¢–µ–∫—Å—Ç –∏–∑ –≥—Ä–∞—Ñ–∏–∫–∞</label><input type="text" id="inpText" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –º75 14:00-22:00" oninput="checkShiftText()"><details id="shiftDetailsBox"><summary>‚öôÔ∏è –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —ç—Ç–æ–π —Å–º–µ–Ω—ã</summary><div class="detail-row"><label>–°—Ç–∞–≤–∫–∞ (‚ÇΩ/—á–∞—Å)</label><input type="text" inputmode="decimal" id="shiftRate"></div><div class="detail-row"><label>–ü—Ä–µ–º–∏—è (%)</label><div style="text-align:right"><input type="text" inputmode="decimal" id="shiftPrem" style="width:60px"><button class="btn-text" onclick="applyPremToCurrentMonth()">–ù–∞ –≤–µ—Å—å –º–µ—Å—è—Ü</button></div></div><div class="detail-row"><label>–ö–ª–∞—Å—Å</label><select id="shiftClassSelect"><option value="0">–ë–µ–∑ –∫–ª–∞—Å—Å–∞</option><option value="30">1 –∫–ª–∞—Å—Å</option><option value="20">2 –∫–ª–∞—Å—Å</option><option value="10">3 –∫–ª–∞—Å—Å</option></select></div><div id="lineWorkContainer" style="display:none;"><div class="line-input-row" style="margin-top:15px;"><input type="time" id="lineStart"><span style="align-self:center">-</span><input type="time" id="lineEnd"></div><div style="font-size:10px; color:#90a4ae; margin-top:5px;">–í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã –Ω–∞ –ª–∏–Ω–∏–∏</div></div>
    
    <div class="detail-row" style="background:#ffebee; padding:8px; border-radius:8px; margin-top:15px; border:1px solid #ffcdd2;">
        <label style="color:#c62828; font-weight:bold; flex:1;">‚õî –ú–µ–¥. –æ—Ç–≤–æ–¥ / –°–Ω—è—Ç</label>
        <input type="checkbox" id="shiftMedical">
    </div>
    
    <div class="detail-row" style="margin-top:15px;"><label style="flex:1;">–¢–µ—Ö. —É—á–µ–±–∞ (+2—á)</label><input type="checkbox" id="shiftTech"></div><div class="detail-row"><label style="flex:1;">–ü–æ—Å–ª–µ—Ä–µ–π—Å–æ–≤—ã–π (+10 –º–∏–Ω)</label><input type="checkbox" id="shiftPostTrip"></div><div class="detail-row" style="margin-top:15px;"><label>–ù–∞—Å—Ç–∞–≤–Ω–∏–∫ (+15%)</label><input type="checkbox" id="shiftMentor"></div><div class="detail-row"><label>–°—Ç. –ú–∞—à–∏–Ω–∏—Å—Ç (+10%)</label><input type="checkbox" id="shiftSenior"></div></details><div class="btn-row"><button class="btn btn-delete" id="btnDeleteShift" onclick="deleteCurrentShift()" style="display:none; margin-right:auto;">–£–¥–∞–ª–∏—Ç—å</button><button class="btn btn-cancel" onclick="closeModal('addModal')">–û—Ç–º–µ–Ω–∞</button><button class="btn btn-save" id="btnSaveShift" onclick="addShift()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></div></div></div>
    <div class="modal-overlay" id="importModal"><div class="modal-box"><h3 style="margin-top:0; color:var(--primary)">–ò–º–ø–æ—Ä—Ç —Å–º–µ–Ω</h3><label>–í—Å—Ç–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç —Å–ø–∏—Å–∫–∞:</label><textarea id="importText" rows="8" placeholder="1.01.25 –º61 20:22-2:46..."></textarea><div class="btn-row"><button class="btn btn-cancel" onclick="closeModal('importModal')">–û—Ç–º–µ–Ω–∞</button><button class="btn btn-save" onclick="processImport()">–†–∞—Å–ø–æ–∑–Ω–∞—Ç—å</button></div></div></div>
    <div class="modal-overlay" id="calendarModal"><div class="modal-box" style="max-width: 400px;" id="calModalBox"><div class="cal-header"><button class="cal-btn" onclick="changeMonth(-1)">&#8249;</button><div class="cal-title" id="calTitle">–ù–æ—è–±—Ä—å 2025</div><button class="cal-btn" onclick="changeMonth(1)">&#8250;</button></div><div class="cal-grid" id="calGrid"></div><div class="btn-row"><button class="btn btn-cancel" onclick="closeModal('calendarModal')">–ó–∞–∫—Ä—ã—Ç—å</button></div></div></div>

    <nav class="bottom-nav">
        <div class="nav-item" id="nav-today" onclick="switchTab('today')"><svg viewBox="0 0 24 24"><path d="M13 3c-4.97 0-9 4.03-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42C8.27 19.99 10.51 21 13 21c4.97 0 9-4.03 9-9s-4.03-9-9-9zm-1 5v5l4.28 2.54.72-1.21-3.5-2.08V8H12z"/></svg><span>–°–µ–≥–æ–¥–Ω—è</span></div>
        <div class="nav-item active" id="nav-home" onclick="switchTab('home')"><svg viewBox="0 0 24 24"><path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20a2 2 0 0 0 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V10h14v10zM9 14H7v-2h2v2zm4 0h-2v-2h2v2zm4 0h-2v-2h2v2zm-8 4H7v-2h2v2zm4 0h-2v-2h2v2zm4 0h-2v-2h2v2z"/></svg><span>–ö–∞–ª–µ–Ω–¥–∞—Ä—å</span></div>
        <div class="nav-item" onclick="switchTab('stats')"><svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/></svg><span>–°–≤–æ–¥–∫–∞</span></div>
        <div class="nav-item" onclick="switchTab('settings')"><svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/></svg><span>–ü—Ä–æ—Ñ–∏–ª—å</span></div>
    </nav>

<script>
    let shifts = JSON.parse(localStorage.getItem('metro_shifts')) || [];
    let settings = JSON.parse(localStorage.getItem('metro_settings')) || { rate: 546.18, classP: 30, premP: 35, mentor: false, senior: false, startDate: "", union: true };
    let calDate = new Date();
    let statsDate = new Date();
    const tg = window.Telegram.WebApp;
    
    // FIX: Define saveData properly so saving actually works
    function saveData() {
        localStorage.setItem('metro_shifts', JSON.stringify(shifts));
        localStorage.setItem('metro_settings', JSON.stringify(settings));
        saveAllToCloud();
    }

    // SWIPE LOGIC (v88 FIX: Stopped looping, improved active tab logic)
    let touchStartX = 0;
    let touchEndX = 0;
    
    document.addEventListener('touchstart', e => {
        touchStartX = e.changedTouches[0].screenX;
    }, {passive: false});

    document.addEventListener('touchend', e => {
        touchEndX = e.changedTouches[0].screenX;
        handleSwipe();
    }, {passive: false});

    function handleSwipe() {
        // Disable swipe if modal is open
        if (document.body.classList.contains('modal-open')) return;
        
        const threshold = 70; // min distance
        const diff = touchEndX - touchStartX;
        
        if (Math.abs(diff) > threshold) {
            const tabs = ['today', 'home', 'stats', 'settings'];
            const currentTab = document.querySelector('.page.active').id.replace('tab-', '');
            let idx = tabs.indexOf(currentTab);
            
            if (diff < 0) { // Swipe Left -> Next Tab
                idx++;
                // v88: Stop at last tab (no loop)
                if (idx >= tabs.length) return; 
            } else { // Swipe Right -> Prev Tab
                idx--;
                // v88: Stop at first tab (no loop)
                if (idx < 0) return; 
            }
            switchTab(tabs[idx]);
        }
    }

    const holidaysData = {
        fixed: ["01-01", "01-02", "01-03", "01-04", "01-05", "01-06", "01-07", "01-08", "02-23", "03-08", "05-01", "05-09", "06-12", "11-04"],
        workOnWeekend: ["2024-04-27", "2024-11-02", "2024-12-28", "2025-11-01"],
        restOnWorkday: ["2024-04-29", "2024-04-30", "2024-05-10", "2024-12-30", "2024-12-31", "2025-05-02", "2025-05-08", "2025-06-13", "2025-11-03", "2025-12-31", "2026-03-09", "2026-05-11"],
        short: ["2024-02-22", "2024-03-07", "2024-05-08", "2024-06-11", "2024-11-02", "2025-03-07", "2025-04-30", "2025-06-11", "2025-11-01", "2026-04-30", "2026-05-08", "2026-06-11", "2026-11-03", "2026-12-31"]
    };

    function getIsoDate(date) { const y = date.getFullYear(); const m = String(date.getMonth() + 1).padStart(2, '0'); const d = String(date.getDate()).padStart(2, '0'); return `${y}-${m}-${d}`; }
    function fmtMoney(val) { if (isNaN(val)) return "0 ‚ÇΩ"; return Math.round(val).toLocaleString() + ' ‚ÇΩ'; }
    function safeFloat(val) { if(!val) return 0; let str = String(val).replace(/\s/g, '').replace(',', '.'); let num = parseFloat(str); return isNaN(num) ? 0 : num; }
    function getHolidays(year) { return holidaysData.fixed.map(d => `${year}-${d}`); }
    function isHoliday(dateObj) { const isoDate = getIsoDate(dateObj); const md = isoDate.slice(5); const day = dateObj.getDay(); const year = dateObj.getFullYear(); if (year >= 2024 && year <= 2026) { if (holidaysData.workOnWeekend.includes(isoDate)) return false; if (holidaysData.restOnWorkday.includes(isoDate)) return true; if (holidaysData.fixed.includes(md)) return true; if (day === 0 || day === 6) return true; return false; } if (day === 0 || day === 6) return true; if (holidaysData.fixed.includes(md)) return true; return false; }
    function getMonthNorm(year, month) { let workDays = 0; let shortDays = 0; const daysInMonth = new Date(year, month + 1, 0).getDate(); for (let d = 1; d <= daysInMonth; d++) { const current = new Date(year, month, d); if (!isHoliday(current)) { workDays++; const iso = getIsoDate(current); if (year >= 2024 && year <= 2026) { if (holidaysData.short.includes(iso)) shortDays++; else { const tomorrow = new Date(year, month, d + 1); const tomIso = getIsoDate(tomorrow).slice(5); if (holidaysData.fixed.includes(tomIso)) shortDays++; } } else { const tomorrow = new Date(year, month, d + 1); const tomIso = getIsoDate(tomorrow).slice(5); if (holidaysData.fixed.includes(tomIso)) shortDays++; } } } return parseFloat(((workDays * 7.2) - shortDays).toFixed(1)); }

    // --- –û–ë–õ–ê–ß–ù–´–ï –§–£–ù–ö–¶–ò–ò ---
    function updateCloudStatus(msg, isError = false) {
        const el = document.getElementById('cloudStatus');
        if(el) { el.innerText = "–û–±–ª–∞–∫–æ: " + msg; el.style.color = isError ? "#e53935" : "#2e7d32"; }
    }

    function init() {
        normalizeShifts(); render(); updateUI(); tg.ready(); tg.expand();
        
        // PUSH TELEGRAM ID TO YANDEX METRIKA
        if (typeof ym !== 'undefined' && tg.initDataUnsafe && tg.initDataUnsafe.user) {
            ym(105574700, 'userParams', { telegram_id: tg.initDataUnsafe.user.id });
        }

        if (tg.CloudStorage) { showLoader(); syncWithCloud(); } else { hideLoader(); }
        document.addEventListener('keydown', function(event) { if (event.key === "Escape") { closeModal('addModal'); closeModal('importModal'); closeModal('calendarModal'); } });
        
        // CALENDAR SWIPE - Specific handler for the modal calendar
        const calBox = document.getElementById('calModalBox'); let tsX = 0;
        calBox.addEventListener('touchstart', e => {
             tsX = e.changedTouches[0].screenX;
             e.stopPropagation(); // Prevent global swipe
        });
        calBox.addEventListener('touchend', e => { 
            let teX = e.changedTouches[0].screenX; 
            if(teX < tsX - 50) changeMonth(1); 
            if(teX > tsX + 50) changeMonth(-1);
            e.stopPropagation(); // Prevent global swipe
        });
        
        setInterval(updateTodayTab, 1000);
        scrollToToday();
    }

    function syncWithCloud() {
        if (!tg.CloudStorage) { hideLoader(); return; }
        tg.CloudStorage.getKeys((err, keys) => {
            if (err) { hideLoader(); updateCloudStatus("–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞", true); return; }
            if(!keys) keys = [];
            const myKeys = keys.filter(k => k === 'metro_settings' || k.startsWith('s_'));
            if (myKeys.length === 0) { saveAllToCloud(() => { hideLoader(); updateCloudStatus("–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ"); }); return; }
            tg.CloudStorage.getItems(myKeys, (err, values) => {
                hideLoader();
                if (err) { updateCloudStatus("–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è", true); return; }
                if (values['metro_settings']) { try { settings = JSON.parse(values['metro_settings']); } catch(e){} }
                let cloudShifts = [];
                for (let k in values) { if (k.startsWith('s_')) { try { const chunk = JSON.parse(values[k]); if (Array.isArray(chunk)) cloudShifts = cloudShifts.concat(chunk); } catch(e){} } }
                if (cloudShifts.length > 0) {
                    const shiftMap = new Map();
                    shifts.forEach(s => shiftMap.set(s.date, s));
                    cloudShifts.forEach(s => { let norm = s.d ? normalizeOne(s) : s; shiftMap.set(norm.date, norm); });
                    shifts = Array.from(shiftMap.values());
                    localStorage.setItem('metro_shifts', JSON.stringify(shifts));
                    localStorage.setItem('metro_settings', JSON.stringify(settings));
                    render();
                }
                updateCloudStatus("–ü–æ–¥–∫–ª—é—á–µ–Ω–æ");
            });
        });
    }

    function forcePushToCloud() {
        if (!confirm('–≠—Ç–æ –ø–µ—Ä–µ–∑–∞–ø–∏—à–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤ –æ–±–ª–∞–∫–µ –≤–∞—à–∏–º–∏ —Ç–µ–∫—É—â–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏ —Å —Ç–µ–ª–µ—Ñ–æ–Ω–∞. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?')) return;
        showLoader();
        saveAllToCloud(() => { hideLoader(); alert('–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –≤ –û–±–ª–∞–∫–æ!'); updateCloudStatus("–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤—Ä—É—á–Ω—É—é"); });
    }

    function saveAll() { saveSettings(); saveData(); }

    function saveAllToCloud(cb) {
        if (!tg.CloudStorage) { if(cb) cb(); return; }
        updateCloudStatus("–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...");
        tg.CloudStorage.setItem('metro_settings', JSON.stringify(settings), (err) => { if(err) updateCloudStatus("–û—à–∏–±–∫–∞ –Ω–∞—Å—Ç—Ä.", true); });
        const grouped = {};
        shifts.forEach(s => {
            const y = s.date.substring(0,4); const m = s.date.substring(5,7); const key = `s_${y}_${m}`;
            if (!grouped[key]) grouped[key] = [];
            const mini = { d: s.date, t: s.text };
            if(s.customRate !== undefined) mini.cr = s.customRate;
            if(s.customMentor !== undefined) mini.cm = s.customMentor;
            if(s.customSenior !== undefined) mini.cs = s.customSenior;
            if(s.customClass !== undefined) mini.cc = s.customClass;
            if(s.customSen !== undefined) mini.ce = s.customSen;
            if(s.customPrem !== undefined) mini.cp = s.customPrem;
            if(s.lineStart) mini.ls = s.lineStart;
            if(s.lineEnd) mini.le = s.lineEnd;
            if(s.isTech) mini.it = 1;
            if(s.isPostTrip) mini.ip = 1;
            if(s.isMedical) mini.im = 1; // New flag for Medical
            grouped[key].push(mini);
        });
        let keys = Object.keys(grouped); let completed = 0;
        if(keys.length === 0 && cb) cb();
        keys.forEach(k => { tg.CloudStorage.setItem(k, JSON.stringify(grouped[k]), (err) => { completed++; if (completed === keys.length) { updateCloudStatus("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ"); if(cb) cb(); } }); });
    }

    function saveLocal() { localStorage.setItem('metro_shifts', JSON.stringify(shifts)); localStorage.setItem('metro_settings', JSON.stringify(settings)); }
    function showLoader() { document.getElementById('loader').classList.add('loader-active'); }
    function hideLoader() { document.getElementById('loader').classList.remove('loader-active'); }

    function normalizeOne(s) { 
        if (s.d) { 
            return { 
                date: s.d, text: s.t, 
                customRate: s.cr, customMentor: s.cm, customSenior: s.cs, 
                customClass: s.cc, customSen: s.ce, customPrem: s.cp, 
                lineStart: s.ls, lineEnd: s.le, isTech: !!s.it, isPostTrip: !!s.ip,
                isMedical: !!s.im 
            }; 
        } 
        return s; 
    }
    function normalizeShifts() { shifts = shifts.map(s => normalizeOne(s)); }

    function updateUI() {
        document.getElementById('set_rate').value = String(settings.rate).replace('.',',');
        document.getElementById('set_class').value = settings.classP;
        document.getElementById('set_prem').value = String(settings.premP).replace('.',',');
        document.getElementById('set_mentor').checked = settings.mentor;
        document.getElementById('set_senior').checked = settings.senior || false;
        document.getElementById('set_start_date').value = settings.startDate || "";
        document.getElementById('set_union').checked = settings.union !== false;
        calcExpDisplay();
    }

    function scrollToToday() { setTimeout(() => { const todayEl = document.querySelector('.shift-card.today'); if (todayEl) todayEl.scrollIntoView({ block: 'center', behavior: 'auto' }); }, 100); }
    
    // v88: REFACTORED switchTab to handle programmatical switching correctly
    function switchTab(tabName) { 
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active')); 
        document.getElementById('tab-' + tabName).classList.add('active'); 
        
        // NEW: Set active class based on INDEX, not on 'this'
        const tabs = ['today', 'home', 'stats', 'settings'];
        const targetIdx = tabs.indexOf(tabName);
        document.querySelectorAll('.nav-item').forEach((el, idx) => {
            if(idx === targetIdx) el.classList.add('active');
            else el.classList.remove('active');
        });

        if(tabName==='home') { scrollToToday(); } 
        
        const titles = { 'today':'–°–µ–≥–æ–¥–Ω—è', 'home': '–ú–æ–∏ —Å–º–µ–Ω—ã', 'stats': '–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞', 'settings': '–ü—Ä–æ—Ñ–∏–ª—å' }; 
        document.getElementById('headerTitle').innerText = titles[tabName]; 
        document.querySelector('header .header-btn').style.display = (tabName === 'home') ? 'flex' : 'none'; 
        if(tabName==='today') updateTodayTab(); 
        if(tabName==='stats') renderStats(); 
    }

    function updateTodayTab() {
        if(!document.getElementById('tab-today').classList.contains('active')) return;
        const now = new Date(); const nowTs = now.getTime();
        let currentShift = null, nextShift = null, prevShiftEnd = 0;
        const sorted = [...shifts].sort((a,b) => new Date(a.date) - new Date(b.date));
        for (let i = 0; i < sorted.length; i++) {
            const s = sorted[i]; let times = [...s.text.matchAll(/(\d{1,2}[:\.]\d{2})/g)]; if (times.length < 2) continue;
            const baseDate = new Date(s.date); const [sh, sm] = times[0][0].replace('.',':').split(':').map(Number); const [eh, em] = times[1][0].replace('.',':').split(':').map(Number);
            const startDate = new Date(baseDate); startDate.setHours(sh, sm, 0, 0); const endDate = new Date(baseDate); if (eh < sh) endDate.setDate(endDate.getDate() + 1); endDate.setHours(eh, em, 0, 0);
            if (nowTs >= startDate.getTime() && nowTs < endDate.getTime()) { currentShift = { data: s, start: startDate, end: endDate }; }
            if (!currentShift && !nextShift && startDate.getTime() > nowTs) { nextShift = { data: s, start: startDate }; }
            if (endDate.getTime() < nowTs) { prevShiftEnd = endDate.getTime(); }
        }
        const container = document.getElementById('todayContent'); let html = '';
        if (currentShift) {
            const totalMs = currentShift.end - currentShift.start; const elapsedMs = now - currentShift.start; const percent = Math.min(100, (elapsedMs / totalMs) * 100);
            const res = calcShift(currentShift.data); let unionFee = settings.union ? (res.dirty * 0.01) : 0; let tax = res.dirty * 0.13; let netTotal = res.dirty - tax - unionFee; const currentEarned = (elapsedMs / totalMs) * netTotal;
            html = `<div class="hero-widget theme-work"><div class="widget-header"><div class="widget-title">–°–ï–ô–ß–ê–° –ù–ê –°–ú–ï–ù–ï</div><div class="widget-icon">üöÖ</div></div><div class="widget-main-value">${Math.floor(currentEarned)} ‚ÇΩ</div><div class="widget-sub-value">–∏–∑ ${Math.round(netTotal)} ‚ÇΩ</div><div class="progress-track"><div class="progress-fill" style="width: ${percent}%"></div></div><div class="progress-labels"><span>${currentShift.start.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</span><span>–ö–æ–Ω–µ—Ü: ${currentShift.end.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</span></div></div><div class="info-grid"><div class="info-card"><div class="info-label">–ú–∞—Ä—à—Ä—É—Ç</div><div class="info-val">${currentShift.data.text.split(' ')[0]}</div></div><div class="info-card"><div class="info-label">–û—Å—Ç–∞–ª–æ—Å—å</div><div class="info-val">${msToTime(currentShift.end - now)}</div></div></div>`;
        } else {
            let restText = "–ù/–î", percentRest = 0, label = "–û–¢–î–´–•", fullRestDesc = "";
            if (prevShiftEnd > 0) {
                if (nextShift) { label = "–ú–ï–ñ–°–ú–ï–ù–ù–´–ô –û–¢–î–´–•"; const totalRestMs = nextShift.start.getTime() - prevShiftEnd; const passedRestMs = nowTs - prevShiftEnd; percentRest = Math.min(100, (passedRestMs / totalRestMs) * 100); restText = msToTime(totalRestMs); const prevEndDate = new Date(prevShiftEnd); const prevEndStr = prevEndDate.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}) + ` (${prevEndDate.getDate()}.${prevEndDate.getMonth()+1})`; const nextStartStr = nextShift.start.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}) + ` (${nextShift.start.getDate()}.${nextShift.start.getMonth()+1})`; fullRestDesc = `<div class="widget-sub-value" style="font-size:13px; margin-top:10px;">–° ${prevEndStr}</div><div class="widget-sub-value" style="font-size:13px;">–î–æ ${nextStartStr}</div><div style="margin-top:20px; font-size:12px; opacity:0.8">–£–∂–µ –ø—Ä–æ—à–ª–æ: ${msToTime(passedRestMs)}</div>`; } 
                else { const passed = nowTs - prevShiftEnd; restText = msToTime(passed); fullRestDesc = `<div class="widget-sub-value">–ø—Ä–æ—à–ª–æ —Å –ø—Ä–æ—à–ª–æ–π —Å–º–µ–Ω—ã</div>`; }
            }
            html = `<div class="hero-widget theme-rest"><div class="widget-header"><div class="widget-title">${label}</div><div class="widget-icon">üõãÔ∏è</div></div><div class="widget-main-value">${restText}</div>${fullRestDesc}${nextShift ? `<div class="progress-track"><div class="progress-fill" style="width: ${percentRest}%"></div></div>` : ''}</div>`;
            if (nextShift) { const timeToStart = nextShift.start - now; html += `<div class="info-grid"><div class="info-card"><div class="info-label">–°–ª–µ–¥—É—é—â–∞—è</div><div class="info-val">${nextShift.start.getDate()}.${nextShift.start.getMonth()+1}</div></div><div class="info-card"><div class="info-label">–î–æ —Å–º–µ–Ω—ã</div><div class="info-val" style="color:var(--accent)">${msToTime(timeToStart)}</div></div></div>`; }
        }
        container.innerHTML = html;
    }
    function msToTime(duration) { let minutes = Math.floor((duration / (1000 * 60)) % 60); let hours = Math.floor((duration / (1000 * 60 * 60))); return hours + "—á " + minutes + "–º"; }
    function getSeniorityPercent(d) { if(!d) return 0; const s = new Date(d); const n = new Date(); if (s > n) return 0; const y = (n - s) / (1000 * 60 * 60 * 24 * 365.25); if (y >= 20) return 30; if (y >= 15) return 25; if (y >= 10) return 20; if (y >= 5) return 15; if (y >= 3) return 10; if (y >= 1) return 5; return 0; }
    function calcExpDisplay() { const d = document.getElementById('set_start_date').value; const t = document.getElementById('set_exp_text'); if(!d) { t.innerText = "–°—Ç–∞–∂ –Ω–µ —É–∫–∞–∑–∞–Ω"; return; } const s = new Date(d); const n = new Date(); const y = Math.floor((n - s) / (1000 * 60 * 60 * 24 * 365.25)); const p = getSeniorityPercent(d); t.innerText = `–°—Ç–∞–∂: ~${y} –ª–µ—Ç (–í—ã—Å–ª—É–≥–∞ ${p}%)`; }
    function parseTime(s) { let m = s.match(/(\d{1,2})[:\.](\d{2})/); return m ? parseInt(m[1])*60 + parseInt(m[2]) : null; }
    function getShiftTimes(shift) { let times = [...shift.text.matchAll(/(\d{1,2}[:\.]\d{2})/g)]; if (times.length < 2) return null; let startHM = times[0][0].replace('.',':').split(':').map(Number); let endHM = times[1][0].replace('.',':').split(':').map(Number); let start = new Date(shift.date); start.setHours(startHM[0], startHM[1], 0, 0); let end = new Date(shift.date); end.setHours(endHM[0], endHM[1], 0, 0); if (end <= start) { end.setDate(end.getDate() + 1); } return { start, end }; }
    function calculateRestIntervals() { shifts.sort((a,b) => { let tA = getShiftTimes(a), tB = getShiftTimes(b); if(!tA) return 1; if(!tB) return -1; return tA.start - tB.start; }); shifts.forEach(s => s.autoSplit = false); for (let i = 0; i < shifts.length - 1; i++) { let curr = shifts[i]; let next = shifts[i+1]; let tCurr = getShiftTimes(curr); let tNext = getShiftTimes(next); if (tCurr && tNext) { let diffMs = tNext.start - tCurr.end; let diffHours = diffMs / (1000 * 60 * 60); if (diffHours > 0 && diffHours < 8) { curr.autoSplit = true; next.autoSplit = true; } } } }

    function calcShift(shift) {
        let text = shift.text.toLowerCase();
        let rateStr = (shift.customRate !== undefined) ? shift.customRate : settings.rate;
        let rate = safeFloat(rateStr); if (rate === 0) rate = 546.18; 
        let sClass = (shift.customClass !== undefined) ? shift.customClass : settings.classP;
        let sSen = (shift.customSen !== undefined) ? shift.customSen : getSeniorityPercent(settings.startDate);
        let sPremStr = (shift.customPrem !== undefined) ? shift.customPrem : settings.premP;
        let sPrem = safeFloat(sPremStr);
        let k = (1 + sPrem / 100);

        // v88.2 FIX: RESTORED "RICH" FORMULA FOR TRAINING FROM v85
        if (text.includes('—É–ø—Ü') || text.includes('—É—á–µ–±–∞')) {
            let hours = 8;
            let nakedTariff = hours * rate; // Full rate * 8 hours
            let valClass = nakedTariff * (sClass / 100);
            let valSen = nakedTariff * (sSen / 100);
            let valSenior = 0; 
            let baseSum = nakedTariff + valClass + valSen + valSenior;
            let valPrem = baseSum * (sPrem / 100);
            let total = baseSum + valPrem;

            return {
                net: Math.round(total * 0.87), dirty: total, hours: hours,
                isRes: false, isFull: false, night: 0, ev: 0, isSplit: false, isTrain: true,
                evBonus: 0, nightBonus: 0, splitBonus: 0, techBonus: 0,
                valClass: valClass, valSen: valSen, valPrem: valPrem, valSenior: valSenior, valMentor: 0,
                mentorHours: 0
            };
        }

        if(text.includes('–±–ª') || text.includes('–¥–æ–Ω–æ—Ä') || text.includes('–≤—ã—Ö')) return null;

        let isMentor = (shift.customMentor !== undefined) ? shift.customMentor : settings.mentor;
        let isSenior = (shift.customSenior !== undefined) ? shift.customSenior : (settings.senior || false);
        let isTech = (shift.isTech === true);
        let isPostTrip = (shift.isPostTrip === true);
        let isMedical = (shift.isMedical === true);
        let isSplit = (shift.autoSplit === true);
        let isRes = text.includes('—Ä–µ–∑');
        if (isRes && shift.customRate === undefined) { rate = (rate / 1.12) * 1.08; }
        
        // MEDICAL OVERRIDE
        if (isMedical) {
             rate = rate / 1.12; // Remove ~12% harmfulness
             isSenior = false;   // No driving
             isMentor = false;
             isSplit = false;    // No split for sitting
        }

        let times = [...text.matchAll(/(\d{1,2}[:\.]\d{2})/g)];
        if (times.length < 2) return null;
        let s = parseTime(times[0][0]), e = parseTime(times[1][0]); if (e < s) e += 24*60;
        if (isPostTrip) { e += 10; }

        let totalHours = (e - s) / 60;
        let totalNight = 0; let totalEv = 0;
        for (let m=s; m<e; m++) { let t=m%1440; if(t>=1320||t<360) totalNight++; else if(t>=960&&t<1320) totalEv++; }
        let payAsFullNight = (totalNight / (e-s)) >= 0.5;
        let nightHoursToPay = payAsFullNight ? totalHours : (totalNight / 60);
        let evHoursToPay = payAsFullNight ? 0 : (totalEv / 60);

        let nakedTariff = totalHours * rate;
        let bonusClass = nakedTariff * (sClass / 100); 
        let bonusSen = nakedTariff * (sSen / 100); 
        let bonusSenior = isSenior ? nakedTariff * 0.10 : 0;
        let bonusMentor = isMentor ? nakedTariff * 0.15 : 0;
        let bonusSplit = isSplit ? nakedTariff * 0.30 : 0;
        let bonusTech = 0; if (isTech) { let baseRate = rate / 1.245; bonusTech = baseRate * 2; }

        let evMoney = evHoursToPay * rate * 0.20;
        let nightMoney = nightHoursToPay * rate * 0.40;
        let totalAccrued = nakedTariff + bonusClass + bonusSen + bonusSenior + bonusMentor + bonusSplit + evMoney + nightMoney;
        let final = totalAccrued * k + bonusTech;

        return { 
            net: Math.round(final*0.87), dirty: final, hours: totalHours, isRes: isRes, isFull: payAsFullNight, 
            night: nightHoursToPay, ev: evHoursToPay, isSplit: isSplit, isTrain: false, isTech: isTech,
            splitBonus: bonusSplit * k, evBonus: evMoney * k, nightBonus: nightMoney * k, techBonus: bonusTech, 
            valClass: bonusClass * k, valSen: bonusSen * k, valSenior: bonusSenior * k, valMentor: bonusMentor * k, valPrem: totalAccrued * (sPrem / 100),
            mentorHours: isMentor ? totalHours : 0
        };
    }

    function drawProgress(percent, labelValue) { const circle = document.getElementById('circlePath'); const textVal = document.getElementById('chartValue'); let drawPercent = percent; if (drawPercent < 0) drawPercent = 0; if (drawPercent > 100) drawPercent = 100; circle.style.strokeDasharray = `${drawPercent}, 100`; textVal.innerText = labelValue.toFixed(1); }
    function changeStatsMonth(dir) { statsDate.setMonth(statsDate.getMonth() + dir); renderStats(); }

    function renderStats() {
        calculateRestIntervals();
        const year = statsDate.getFullYear(); const month = statsDate.getMonth();
        const monthNames = ["–Ø–Ω–≤–∞—Ä—å", "–§–µ–≤—Ä–∞–ª—å", "–ú–∞—Ä—Ç", "–ê–ø—Ä–µ–ª—å", "–ú–∞–π", "–ò—é–Ω—å", "–ò—é–ª—å", "–ê–≤–≥—É—Å—Ç", "–°–µ–Ω—Ç—è–±—Ä—å", "–û–∫—Ç—è–±—Ä—å", "–ù–æ—è–±—Ä—å", "–î–µ–∫–∞–±—Ä—å"];
        document.getElementById('statsMonthDisplay').innerText = `${monthNames[month]} ${year}`;
        const monthlyShifts = shifts.filter(s => { const d = new Date(s.date); return d.getFullYear() === year && d.getMonth() === month; });
        let st = { count: 0, hours: 0, night: 0, ev: 0, res: 0, dirty: 0, sick: 0, donor: 0, net: 0, union: 0, tax: 0, splitBonus: 0, evBonus: 0, nightBonus: 0, techBonus: 0, splitHours: 0, sumClass: 0, sumSen: 0, sumPrem: 0, sumSenior: 0, sumMentor: 0, ot15Hours: 0, ot15Money: 0, ot20Hours: 0, ot20Money: 0, mentorHours: 0 };
        let sickDeduction = 0;

        monthlyShifts.forEach(s => {
            let text = s.text.toLowerCase();
            if (text.includes('–±–ª') || text.includes('–æ—Ç–ø—É—Å–∫')) { const d = new Date(s.date); if (!isHoliday(d)) { sickDeduction += 7.2; } if (text.includes('–±–ª')) st.sick++; }
            if (text.includes('–¥–æ–Ω–æ—Ä')) st.donor++;
            let res = calcShift(s);
            if (res) {
                st.count++; st.hours += res.hours; st.night += res.night; st.ev += (res.ev || 0); if (res.isRes) st.res++;
                st.dirty += res.dirty; st.splitBonus += (res.splitBonus || 0); st.evBonus += (res.evBonus || 0); st.nightBonus += (res.nightBonus || 0); st.techBonus += (res.techBonus || 0);
                if(res.isSplit) st.splitHours += res.hours;
                st.sumClass += (res.valClass || 0); st.sumSen += (res.valSen || 0); st.sumSenior += (res.valSenior || 0); st.sumMentor += (res.valMentor || 0); st.sumPrem += (res.valPrem || 0); st.mentorHours += (res.mentorHours || 0);
            }
        });

        let norm = getMonthNorm(year, month); let displayNorm = norm + ' —á';
        if (sickDeduction > 0) { norm -= sickDeduction; norm = parseFloat(norm.toFixed(1)); displayNorm = `${norm} —á (—Å–Ω–∏–∂–µ–Ω–∞ –Ω–∞ ${sickDeduction.toFixed(1)})`; }
        const overtime = st.hours - norm; let percent = (norm > 0) ? (st.hours / norm) * 100 : 0; drawProgress(percent, st.hours);

        if (overtime > 0) {
            let rate = settings.rate; let premRate = settings.premP;
            if (overtime <= 2) { st.ot15Hours = overtime; let base15 = st.ot15Hours * rate * 0.5; st.ot15Money = base15 * (1 + premRate / 100); } 
            else { st.ot15Hours = 2; let base15 = 2 * rate * 0.5; st.ot15Money = base15 * (1 + premRate / 100); st.ot20Hours = overtime - 2; let base20 = st.ot20Hours * rate * 1.0; st.ot20Money = base20 * (1 + premRate / 100); }
            st.dirty += st.ot15Money + st.ot20Money;
        }

        st.union = settings.union ? (st.dirty * 0.01) : 0; st.tax = st.dirty * 0.13; st.net = st.dirty - st.tax - st.union;

        document.getElementById('st_norm').innerText = displayNorm; document.getElementById('st_hours').innerText = st.hours.toFixed(1) + ' —á';
        const overEl = document.getElementById('st_over');
        if (overtime > 0) { overEl.innerText = "+" + overtime.toFixed(1) + " —á"; overEl.style.color = "#2e7d32"; } 
        else if (overtime < 0) { overEl.innerText = overtime.toFixed(1) + " —á"; overEl.style.color = "#c62828"; } 
        else { overEl.innerText = "0 —á"; overEl.style.color = "var(--primary)"; }

        document.getElementById('st_ev_hours').innerText = st.ev.toFixed(1) + '—á'; document.getElementById('st_ev_money').innerText = '+' + fmtMoney(st.evBonus);
        document.getElementById('st_night_hours').innerText = st.night.toFixed(1) + '—á'; document.getElementById('st_night_money').innerText = '+' + fmtMoney(st.nightBonus);
        document.getElementById('st_split_hours').innerText = st.splitHours.toFixed(1) + '—á'; document.getElementById('st_split_money').innerText = '+' + fmtMoney(st.splitBonus);
        document.getElementById('st_ot15_hours').innerText = (st.ot15Hours > 0 ? '+' : '') + st.ot15Hours.toFixed(1) + '—á'; document.getElementById('st_ot15_money').innerText = '+' + fmtMoney(st.ot15Money);
        document.getElementById('st_ot20_hours').innerText = (st.ot20Hours > 0 ? '+' : '') + st.ot20Hours.toFixed(1) + '—á'; document.getElementById('st_ot20_money').innerText = '+' + fmtMoney(st.ot20Money);
        document.getElementById('lbl_class').innerText = `–ö–ª–∞—Å—Å–Ω–æ—Å—Ç—å (${settings.classP}%):`; document.getElementById('lbl_sen').innerText = `–í—ã—Å–ª—É–≥–∞ (${getSeniorityPercent(settings.startDate)}%):`; document.getElementById('lbl_prem').innerText = `–ü—Ä–µ–º–∏—è (${settings.premP}%):`;
        document.getElementById('lbl_senior').innerText = `–°—Ç. –º–∞—à–∏–Ω–∏—Å—Ç (${settings.senior?10:0}%):`;
        document.getElementById('st_class_money').innerText = '+' + fmtMoney(st.sumClass); document.getElementById('st_sen_money').innerText = '+' + fmtMoney(st.sumSen); document.getElementById('st_prem_money').innerText = '+' + fmtMoney(st.sumPrem);
        document.getElementById('row_tech').style.display = st.techBonus > 0 ? 'flex' : 'none'; document.getElementById('st_tech_money').innerText = '+' + fmtMoney(st.techBonus);
        document.getElementById('row_senior').style.display = st.sumSenior > 0 ? 'flex' : 'none'; document.getElementById('st_senior_money').innerText = '+' + fmtMoney(st.sumSenior);
        document.getElementById('row_mentor').style.display = st.sumMentor > 0 ? 'flex' : 'none'; document.getElementById('st_mentor_hours').innerText = st.mentorHours.toFixed(1) + '—á'; document.getElementById('st_mentor_money').innerText = '+' + fmtMoney(st.sumMentor);
        document.getElementById('st_dirty').innerText = fmtMoney(st.dirty); document.getElementById('st_union').innerText = '-' + fmtMoney(st.union); document.getElementById('st_tax').innerText = '-' + fmtMoney(st.tax); document.getElementById('st_net').innerText = fmtMoney(st.net);
    }

    function render() {
        calculateRestIntervals();
        const list = document.getElementById('shiftList'); list.innerHTML = '';
        shifts.sort((a,b) => new Date(a.date) - new Date(b.date));
        
        // FIX: Use local date for "Today" calculation instead of UTC
        const todayStr = getIsoDate(new Date());
        
        let currentMonthStr = "";
        shifts.forEach((s) => {
            const shiftDate = new Date(s.date); const monthYear = shiftDate.toLocaleString('ru', { month: 'long', year: 'numeric' }); const monthYearCap = monthYear.charAt(0).toUpperCase() + monthYear.slice(1);
            if(monthYearCap !== currentMonthStr) { currentMonthStr = monthYearCap; const divider = document.createElement('div'); divider.className = 'month-header'; divider.innerText = currentMonthStr; list.appendChild(divider); }
            let res = calcShift(s); let title = s.text.split(' ')[0]; let details = s.text.substring(title.length).trim();
            if (res && res.hours > 0) details += ` (${res.hours.toFixed(1)}—á)`;
            let tags = ''; if (res) { if (res.isTrain) tags += '<span class="tag teal">–û–ë–£–ß–ï–ù–ò–ï</span> '; if (res.isRes) tags += '<span class="tag gray">–†–ï–ó–ï–†–í</span> '; if (s.lineStart) tags += '<span class="tag orange">–í–´–ï–ó–î</span> '; if (res.isTech) tags += '<span class="tag teal">+–£–ß–ï–ë–ê</span> '; }
            let div = document.createElement('div'); div.className = 'shift-card'; if(s.date === todayStr) { div.classList.add('today'); div.innerHTML = `<div class="today-badge">–°–ï–ì–û–î–ù–Ø</div>`; }
            div.onclick = () => openDayModal(s.date);
            div.id = 'card-' + s.date; // ADD ID for SCROLLING
            let moneyHTML = ''; if (res) { const moneyClass = (new Date(s.date) > new Date()) ? 'money-val future' : 'money-val'; moneyHTML = `<div class="${moneyClass}">+${res.net}</div>`; }
            let d = new Date(s.date);
            div.innerHTML += `<div class="date-box"><span class="date-day">${d.getDate()}</span><span class="date-dow">${d.toLocaleString('ru',{weekday:'short'})}</span></div><div class="shift-info"><div class="shift-title">${title} ${tags}</div><div class="shift-sub">${details}</div></div><div style="text-align:right">${moneyHTML}</div>`;
            list.appendChild(div);
        });
        renderStats();
    }
    
    function openModal() { document.body.classList.add('modal-open'); document.getElementById('addModal').classList.add('open'); setAutoDate(); document.getElementById('inpText').value = ''; document.getElementById('modalTitle').innerText = '–ù–æ–≤–∞—è —Å–º–µ–Ω–∞'; document.getElementById('btnSaveShift').innerText = '–î–æ–±–∞–≤–∏—Ç—å'; document.getElementById('btnDeleteShift').style.display = 'none'; document.getElementById('shiftRate').value = String(settings.rate).replace('.',','); document.getElementById('shiftMentor').checked = settings.mentor; document.getElementById('shiftSenior').checked = settings.senior || false; document.getElementById('shiftTech').checked = false; document.getElementById('shiftPostTrip').checked = false; document.getElementById('shiftClassSelect').value = settings.classP; document.getElementById('shiftPrem').value = String(settings.premP).replace('.',','); checkShiftText(); document.getElementById('inpText').focus(); }
    function openDayModal(dateStr) { document.body.classList.add('modal-open'); document.getElementById('inpDate').value = dateStr; const shift = shifts.find(s => s.date === dateStr); const delBtn = document.getElementById('btnDeleteShift'); const saveBtn = document.getElementById('btnSaveShift'); const title = document.getElementById('modalTitle'); document.getElementById('lineStart').value = ''; document.getElementById('lineEnd').value = ''; if (shift) { document.getElementById('inpText').value = shift.text; let effectiveRate = shift.customRate; if(effectiveRate === undefined) { effectiveRate = shift.text.toLowerCase().includes('—Ä–µ–∑') ? (settings.rate / 1.12) * 1.08 : settings.rate; } document.getElementById('shiftRate').value = String(effectiveRate).replace('.',','); document.getElementById('shiftMentor').checked = shift.customMentor !== undefined ? shift.customMentor : settings.mentor; document.getElementById('shiftSenior').checked = shift.customSenior !== undefined ? shift.customSenior : (settings.senior || false); document.getElementById('shiftTech').checked = shift.isTech !== undefined ? shift.isTech : false; document.getElementById('shiftPostTrip').checked = shift.isPostTrip !== undefined ? shift.isPostTrip : false; document.getElementById('shiftMedical').checked = shift.isMedical !== undefined ? shift.isMedical : false; document.getElementById('shiftClassSelect').value = (shift.customClass !== undefined) ? shift.customClass : settings.classP; document.getElementById('shiftPrem').value = (shift.customPrem !== undefined) ? shift.customPrem : settings.premP; if (shift.customPrem === undefined) document.getElementById('shiftPrem').value = String(settings.premP).replace('.',','); else document.getElementById('shiftPrem').value = String(shift.customPrem).replace('.',','); if (shift.lineStart) document.getElementById('lineStart').value = shift.lineStart; if (shift.lineEnd) document.getElementById('lineEnd').value = shift.lineEnd; title.innerText = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ'; saveBtn.innerText = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å'; delBtn.style.display = 'block'; } else { document.getElementById('inpText').value = ''; document.getElementById('shiftRate').value = String(settings.rate).replace('.',','); document.getElementById('shiftMentor').checked = settings.mentor; document.getElementById('shiftSenior').checked = settings.senior || false; document.getElementById('shiftTech').checked = false; document.getElementById('shiftPostTrip').checked = false; document.getElementById('shiftMedical').checked = false; document.getElementById('shiftClassSelect').value = settings.classP; document.getElementById('shiftPrem').value = String(settings.premP).replace('.',','); title.innerText = '–ù–æ–≤–∞—è —Å–º–µ–Ω–∞'; saveBtn.innerText = '–î–æ–±–∞–≤–∏—Ç—å'; delBtn.style.display = 'none'; } checkShiftText(); document.getElementById('addModal').classList.add('open'); document.getElementById('inpText').focus(); }
    function checkShiftText() { const txt = document.getElementById('inpText').value.toLowerCase(); const details = document.getElementById('shiftDetailsBox'); const lineBlock = document.getElementById('lineWorkContainer'); if (txt.includes('–≤—ã—Ö') || txt.includes('–±–ª') || txt.includes('–¥–æ–Ω–æ—Ä')) { details.style.display = 'none'; } else { details.style.display = 'block'; } const rateInput = document.getElementById('shiftRate'); const mainRate = safeFloat(settings.rate); if (txt.includes('—Ä–µ–∑')) { const resRate = (mainRate / 1.12) * 1.08; if(document.activeElement.id === 'inpText') { rateInput.value = String(resRate.toFixed(2)).replace('.',','); } lineBlock.style.display = 'block'; } else { if (details.style.display !== 'none' && document.activeElement.id === 'inpText') { rateInput.value = String(mainRate).replace('.',','); } lineBlock.style.display = 'none'; } }
    function applyPremToCurrentMonth() { const newPrem = safeFloat(document.getElementById('shiftPrem').value); const dateStr = document.getElementById('inpDate').value; if (!dateStr) return; const targetDate = new Date(dateStr); const targetMonth = targetDate.getMonth(); const targetYear = targetDate.getFullYear(); let count = 0; shifts.forEach(s => { const d = new Date(s.date); if (d.getMonth() === targetMonth && d.getFullYear() === targetYear) { s.customPrem = newPrem; count++; } }); saveData(); alert(`–ü—Ä–µ–º–∏—è ${newPrem}% –ø—Ä–∏–º–µ–Ω–µ–Ω–∞ –∫ ${count} —Å–º–µ–Ω–∞–º.`); render(); }
    function deleteCurrentShift() { const d = document.getElementById('inpDate').value; if(confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É —Å–º–µ–Ω—É?')) { shifts = shifts.filter(s => s.date !== d); saveData(); render(); renderCalendar(); closeModal('addModal'); } }
    function openImportModal() { document.body.classList.add('modal-open'); document.getElementById('importModal').classList.add('open'); }
    function closeModal(id) { document.body.classList.remove('modal-open'); document.getElementById(id).classList.remove('open'); }
    function saveAllSettings() { settings.rate = safeFloat(document.getElementById('set_rate').value); settings.classP = parseInt(document.getElementById('set_class').value); settings.premP = safeFloat(document.getElementById('set_prem').value); settings.mentor = document.getElementById('set_mentor').checked; settings.senior = document.getElementById('set_senior').checked; settings.startDate = document.getElementById('set_start_date').value; settings.union = document.getElementById('set_union').checked; saveData(); calcExpDisplay(); render(); }
    window.saveAll = saveAllSettings;

    function processImport() { const text = document.getElementById('importText').value; if(!text) return; const lines = text.split('\n'); let addedCount = 0; const defRate = settings.rate; const defMent = settings.mentor; const defSen = settings.senior || false; const defClass = settings.classP; const defExp = getSeniorityPercent(settings.startDate); const defPrem = settings.premP; lines.forEach(line => { line = line.trim(); if(!line) return; const dateMatch = line.match(/^(\d{1,2})\.(\d{2})\.(\d{2})/); if(dateMatch) { const day = dateMatch[1].padStart(2, '0'); const month = dateMatch[2]; const year = '20' + dateMatch[3]; const isoDate = `${year}-${month}-${day}`; let desc = line.replace(dateMatch[0], '').trim(); shifts = shifts.filter(s => s.date !== isoDate); let impRate = defRate; if(desc.toLowerCase().includes('—Ä–µ–∑')) { impRate = (safeFloat(defRate) / 1.12) * 1.08; } shifts.push({ date: isoDate, text: desc, customRate: impRate, customMentor: defMent, customSenior: defSen, customClass: defClass, customSen: defExp, customPrem: defPrem }); addedCount++; } }); if(addedCount > 0) { saveData(); render(); closeModal('importModal'); alert(`–£—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ: ${addedCount}`); } else { alert('–û—à–∏–±–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞.'); } }
    
    // UPDATED ADDSHIFT WITH SCROLL FIX
    function addShift() { 
        let d = document.getElementById('inpDate').value; 
        let t = document.getElementById('inpText').value; 
        let sRate = safeFloat(document.getElementById('shiftRate').value); 
        let sMentor = document.getElementById('shiftMentor').checked; 
        let sSenior = document.getElementById('shiftSenior').checked; 
        let lStart = document.getElementById('lineStart').value; 
        let lEnd = document.getElementById('lineEnd').value; 
        let sClass = parseInt(document.getElementById('shiftClassSelect').value); 
        let sSen = getSeniorityPercent(settings.startDate); 
        let sPrem = safeFloat(document.getElementById('shiftPrem').value); 
        let sTech = document.getElementById('shiftTech').checked; 
        let sPost = document.getElementById('shiftPostTrip').checked; 
        let sMedical = document.getElementById('shiftMedical').checked; 
        
        if(d && t) { 
            shifts = shifts.filter(s => s.date !== d); 
            shifts.push({ date:d, text:t, customRate: sRate, customMentor: sMentor, customSenior: sSenior, customClass: sClass, customSen: sSen, customPrem: sPrem, lineStart: lStart, lineEnd: lEnd, isTech: sTech, isPostTrip: sPost, isMedical: sMedical }); 
            saveData(); 
            render(); 
            if(document.getElementById('calendarModal').classList.contains('open')) renderCalendar(); 
            closeModal('addModal'); 
            
            // SCROLL TO THE EDITED CARD
            setTimeout(() => {
                const el = document.getElementById('card-' + d);
                if(el) el.scrollIntoView({block: "center", behavior: "smooth"});
            }, 100);
        } 
    }
    
    function renderCalendar() { const grid = document.getElementById('calGrid'); grid.innerHTML = ''; ['–ü–ù','–í–¢','–°–†','–ß–¢','–ü–¢','–°–ë','–í–°'].forEach(d => grid.innerHTML += `<div class="cal-day-name">${d}</div>`); const year = calDate.getFullYear(); const month = calDate.getMonth(); const monthNames = ["–Ø–Ω–≤–∞—Ä—å", "–§–µ–≤—Ä–∞–ª—å", "–ú–∞—Ä—Ç", "–ê–ø—Ä–µ–ª—å", "–ú–∞–π", "–ò—é–Ω—å", "–ò—é–ª—å", "–ê–≤–≥—É—Å—Ç", "–°–µ–Ω—Ç—è–±—Ä—å", "–û–∫—Ç—è–±—Ä—å", "–ù–æ—è–±—Ä—å", "–î–µ–∫–∞–±—Ä—å"]; document.getElementById('calTitle').innerText = `${monthNames[month]} ${year}`; const currentYearHolidays = getHolidays(year); let firstDay = new Date(year, month, 1).getDay(); firstDay = (firstDay === 0 ? 6 : firstDay - 1); const daysInMonth = new Date(year, month + 1, 0).getDate(); 
    
    // FIX: Use local date for "Today" highlighting in calendar too
    const todayStr = getIsoDate(new Date());
    
    for (let i = 0; i < firstDay; i++) grid.innerHTML += `<div class="cal-cell empty"></div>`; for (let d = 1; d <= daysInMonth; d++) { const currentIso = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`; const shift = shifts.find(s => s.date === currentIso); const dateObj = new Date(currentIso); const dayOfWeek = dateObj.getDay(); const isWeekend = (dayOfWeek === 0 || dayOfWeek === 6); const isHoliday = isHolidayFunc(dateObj); let cellClass = ''; if (isWeekend || isHoliday) cellClass += ' weekend'; if (isHoliday) cellClass += ' holiday'; let content = `<div class="cal-num">${d}</div>`; if (shift) { let text = shift.text.toLowerCase(); let typeClass = 'type-work'; if(text.includes('–±–ª')) typeClass = 'type-sick'; else if(text.includes('–¥–æ–Ω–æ—Ä')) typeClass = 'type-donor'; else if(text.includes('–≤—ã—Ö')) typeClass = 'type-off'; else if(text.includes('—É–ø—Ü') || text.includes('—É—á–µ–±–∞')) typeClass = 'type-train'; cellClass += ` has-shift ${typeClass}`; let title = shift.text.split(' ')[0]; if(title.length > 5) title = title.substr(0,4)+'.'; content += `<div class="cal-shift">${title}</div>`; } if (currentIso === todayStr) cellClass += ' today'; let cellHTML = `<div class="cal-cell ${cellClass}" onclick="openDayModal('${currentIso}')">${content}</div>`; grid.innerHTML += cellHTML; } }
    
    function isHolidayFunc(d) { return isHoliday(d); }
    function changeMonth(dir) { calDate.setMonth(calDate.getMonth() + dir); renderCalendar(); }
    function openCalendarModal() { document.body.classList.add('modal-open'); document.getElementById('calendarModal').classList.add('open'); renderCalendar(); }
    function setAutoDate() { if (shifts.length === 0) { document.getElementById('inpDate').valueAsDate = new Date(); return; } let maxTime = 0; shifts.forEach(s => { let time = new Date(s.date).getTime(); if (time > maxTime) maxTime = time; }); let nextDay = new Date(maxTime); nextDay.setDate(nextDay.getDate() + 1); document.getElementById('inpDate').valueAsDate = nextDay; }

    init();
</script>

</body>
</html>