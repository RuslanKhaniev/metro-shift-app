<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ì—Ä–∞—Ñ–∏–∫–ë—Ä–æ v1.0</title>

    <script type="text/javascript" >
       (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
       m[i].l=1*new Date();
       for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
       k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
       (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");

       ym(105574700, "init", {
           clickmap:true,
           trackLinks:true,
           accurateTrackBounce:true,
           webvisor:true
       });
    </script>
    <noscript><div><img src="https://mc.yandex.ru/watch/105574700" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <script>
        if (!window.Telegram || !window.Telegram.WebApp || !window.Telegram.WebApp.initData) {
            console.warn("‚ö†Ô∏è –ó–ê–ü–£–°–ö –í –ë–†–ê–£–ó–ï–†–ï: –í–∫–ª—é—á–µ–Ω —Ä–µ–∂–∏–º —ç–º—É–ª—è—Ü–∏–∏ Telegram.");
            window.Telegram = {
                WebApp: {
                    initData: "user_id=123&first_name=Tester",
                    initDataUnsafe: { user: { id: 999999, first_name: "BrowserUser", username: "tester" } },
                    colorScheme: 'light',
                    themeParams: { bg_color: "#ffffff", text_color: "#000000" },
                    isExpanded: true,
                    viewportHeight: window.innerHeight,
                    ready: function() { console.log('[MockTG] App Ready'); },
                    expand: function() { console.log('[MockTG] App Expanded'); },
                    close: function() { console.log('[MockTG] Close command'); },
                    CloudStorage: {
                        getItem: function(key, callback) { setTimeout(() => { const val = localStorage.getItem('mock_cloud_' + key); if (callback) callback(null, val); }, 100); },
                        setItem: function(key, value, callback) { setTimeout(() => { localStorage.setItem('mock_cloud_' + key, value); if (callback) callback(null, true); }, 100); },
                        getItems: function(keys, callback) { setTimeout(() => { const result = {}; keys.forEach(k => { const v = localStorage.getItem('mock_cloud_' + k); if (v) result[k] = v; }); if (callback) callback(null, result); }, 100); },
                        getKeys: function(callback) { setTimeout(() => { const keys = []; for (let i = 0; i < localStorage.length; i++) { const k = localStorage.key(i); if (k.startsWith('mock_cloud_')) { keys.push(k.replace('mock_cloud_', '')); } } if (callback) callback(null, keys); }, 100); }
                    }
                }
            };
        }
    </script>
    <style>
        :root {
            --primary: #37474f; --accent: #ffab00; --bg: #f5f7fa; --card: #ffffff; --text: #263238;
            --nav-inactive: #90a4ae;
            --col-work-bg: #e8f5e9; --col-work-txt: #2e7d32;
            --col-sick-bg: #fff9c4; --col-sick-txt: #fbc02d; --col-sick-border: #fff59d;
            --col-donor-bg: #f3e5f5; --col-donor-txt: #ab47bc; --col-donor-border: #e1bee7;
            --col-train-bg: #e0f7fa; --col-train-txt: #006064; --col-train-border: #b2ebf2;
            --col-weekend-txt: #e53935; --col-holiday-bg: #ffebee; --col-holiday-border: #ef5350; 
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Roboto", sans-serif; background-color: var(--bg); margin: 0; padding: 0; color: var(--text); padding-bottom: 90px; padding-top: 60px; -webkit-tap-highlight-color: transparent; }
        
        /* –ò–°–ü–†–ê–í–õ–ï–ù–û: –£–±—Ä–∞–Ω–æ position: fixed, –∫–æ—Ç–æ—Ä–æ–µ —Å–±—Ä–∞—Å—ã–≤–∞–ª–æ —Å–∫—Ä–æ–ª–ª */
        body.modal-open { overflow: hidden; touch-action: none; }

        header { background-color: var(--card); color: var(--text); height: 60px; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); position: fixed; top: 0; left: 0; right: 0; z-index: 100; }
        h1 { font-size: 22px; font-weight: 800; letter-spacing: -0.5px; margin: 0; color: var(--primary); }
        .header-btn { background: #f0f2f5; border: none; cursor: pointer; color: var(--primary); padding: 10px; border-radius: 12px; transition: 0.2s; } .header-btn:active { transform: scale(0.95); } .header-btn svg { width: 24px; height: 24px; fill: currentColor; }
        #loader { position: fixed; top:0; left:0; right:0; bottom:0; background: var(--bg); z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: opacity 0.3s; pointer-events: none; opacity: 0;}
        .spinner { width: 40px; height: 40px; border: 4px solid #cfd8dc; border-top: 4px solid var(--accent); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .loader-text { margin-top: 15px; font-weight: 600; color: var(--primary); font-size: 14px; }
        .loader-active { opacity: 1 !important; pointer-events: all !important; }
        .page { display: none; padding: 20px; animation: fadeIn 0.3s ease; } .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .hero-widget { border-radius: 24px; padding: 25px; color: white; box-shadow: 0 15px 30px rgba(0,0,0,0.15); margin-bottom: 20px; position: relative; overflow: hidden; }
        .theme-work { background: linear-gradient(135deg, #263238 0%, #37474f 100%); }
        .theme-rest { background: linear-gradient(135deg, #0288d1 0%, #26c6da 100%); }
        .widget-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; opacity: 0.9; }
        .widget-title { font-size: 13px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; }
        .widget-main-value { font-size: 52px; font-weight: 800; letter-spacing: -1px; line-height: 1; margin-bottom: 5px; }
        .widget-sub-value { font-size: 15px; opacity: 0.9; font-weight: 600; background: rgba(255,255,255,0.2); padding: 4px 10px; border-radius: 8px; display: inline-block; margin-bottom: 15px;}
        .progress-track { background: rgba(255,255,255,0.2); height: 6px; border-radius: 4px; margin-top: 20px; overflow: hidden; }
        .progress-fill { height: 100%; border-radius: 4px; transition: width 1s linear; background: white; }
        .theme-work .progress-fill { background: var(--accent); }
        .progress-labels { display: flex; justify-content: space-between; margin-top: 8px; font-size: 12px; font-weight: 600; opacity: 0.9; }
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .info-card { background: white; padding: 15px; border-radius: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); text-align: center; }
        .info-label { font-size: 11px; color: #90a4ae; font-weight: 700; text-transform: uppercase; margin-bottom: 6px; }
        .info-val { font-size: 17px; font-weight: 700; color: var(--primary); }
        .month-header { font-size: 14px; font-weight: 800; color: var(--nav-inactive); margin: 10px 0 15px 5px; text-transform: uppercase; letter-spacing: 1px; }
        .shift-card { background: white; border-radius: 16px; padding: 15px; margin-bottom: 12px; display: flex; align-items: center; box-shadow: 0 2px 8px rgba(0,0,0,0.04); cursor: pointer; transition: transform 0.1s; position: relative; overflow: hidden;}
        .shift-card:active { transform: scale(0.98); }
        .shift-card.today { border: 2px solid var(--accent); background-color: #fffde7; }
        .today-badge { position: absolute; top: 0; right: 0; background: var(--accent); color: white; font-size: 10px; padding: 3px 8px; border-bottom-left-radius: 10px; font-weight: bold; z-index: 10; }
        .date-box { background: #f0f2f5; min-width: 50px; height: 50px; border-radius: 12px; display: flex; flex-direction: column; align-items: center; justify-content: center; margin-right: 16px; color: var(--primary); }
        .date-day { font-size: 20px; font-weight: 800; line-height: 1; }
        .date-dow { font-size: 11px; text-transform: uppercase; margin-top: 3px; font-weight: 600; color: #78909c;}
        .shift-info { flex-grow: 1; min-width: 0; }
        .shift-title { font-weight: 700; font-size: 16px; display: flex; align-items: center; gap: 8px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .shift-sub { font-size: 13px; color: #78909c; margin-top: 4px; font-weight: 500; }
        .money-val { color: #2e7d32; font-weight: 800; font-size: 16px; }
        .money-val.future { color: #90a4ae; font-weight: 600; }
        .cal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .cal-title { font-size: 18px; font-weight: 700; }
        .cal-btn { background: none; border: none; font-size: 24px; color: var(--primary); cursor: pointer; padding: 5px 15px; }
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; width: 100%; }
        .cal-day-name { text-align: center; font-size: 11px; color: #b0bec5; font-weight: 700; padding-bottom: 10px; }
        .cal-cell { background: #f7f9fc; border-radius: 10px; height: 55px; display: flex; flex-direction: column; align-items: center; padding-top: 4px; font-size: 12px; position: relative; border: 2px solid transparent; cursor: pointer; min-width: 0; }
        .cal-num { font-weight: 700; font-size: 12px; margin-bottom: 2px; color: #546e7a; }
        .cal-shift { font-size: 9px; text-align: center; line-height: 1.1; width: 100%; overflow: hidden; text-overflow: ellipsis; padding: 0 2px; font-weight: 600;}
        .cal-cell.today { border-color: var(--accent); background: #fff; }
        .cal-cell.today .cal-num { color: var(--accent); }
        .cal-cell.weekend .cal-num { 
        color: var(--col-weekend-txt); 
        }
        .cal-cell.state-holiday { 
        background: var(--col-holiday-bg); 
        border-color: var(--col-holiday-border) !important; /* !important —á—Ç–æ–±—ã –ø–µ—Ä–µ–±–∏—Ç—å —Ä–∞–º–∫—É –æ–±—ã—á–Ω—ã—Ö –¥–Ω–µ–π */
        }
        .cal-cell.state-holiday.has-shift.type-work { 
        background: var(--col-work-bg); 
        border-color: var(--col-holiday-border); 
        }
        .cal-cell.state-holiday.has-shift.type-work .cal-num { 
        color: var(--col-weekend-txt); 
        font-weight: 900; 
        }
        .cal-cell.state-holiday.today {
        border-color: var(--accent) !important;
        box-shadow: 0 0 10px rgba(255, 171, 0, 0.4); /* –î–æ–±–∞–≤–∏–º —Å–≤–µ—á–µ–Ω–∏–µ, —Ä–∞–∑ —É–∂ –ø—Ä–∞–∑–¥–Ω–∏–∫ */
        }
        .cal-cell.type-work { background: var(--col-work-bg); color: var(--col-work-txt); }
        .cal-cell.type-off { background: white; color: #cfd8dc; }
        .cal-cell.type-sick { background: var(--col-sick-bg) !important; color: #f9a825 !important; border-color: var(--col-sick-border); }
        .cal-cell.type-train { background: var(--col-train-bg) !important; color: var(--col-train-txt) !important; border-color: var(--col-train-border); }
        .cal-cell.type-donor { background: var(--col-donor-bg) !important; color: var(--col-donor-txt) !important; border-color: var(--col-donor-border); }
        .cal-cell.holiday { background: var(--col-holiday-bg); border-color: var(--col-holiday-border); }
        .cal-cell.holiday .cal-num { color: var(--col-weekend-txt); } 
        .cal-cell.holiday.has-shift.type-work { background: var(--col-work-bg); border-color: var(--col-holiday-border); }
        .cal-cell.holiday.has-shift.type-work .cal-num { color: var(--col-weekend-txt); font-weight: 900; }
        .cal-cell.empty { background: transparent; cursor: default; }
        .tag { font-size: 9px; padding: 3px 8px; border-radius: 6px; color: white; font-weight: bold; letter-spacing: 0.5px; display:inline-block; margin-left:2px;}
        .tag.gray { background: #90a4ae; } .tag.orange { background: var(--accent); } .tag.teal { background: #009688; } .tag.indigo { background: #5c6bc0; } .tag.red { background: #e53935; } .tag.purple { background: #7e57c2; }
        .fab-container { position: fixed; bottom: 90px; right: 20px; display: flex; align-items: center; gap: 15px; z-index: 2000; pointer-events: auto; }
        .fab-main { background: var(--accent); color: white; width: 60px; height: 60px; border-radius: 50%; display: flex; justify-content: center; align-items: center; box-shadow: 0 8px 20px rgba(255, 171, 0, 0.4); cursor: pointer; border: none; transition: transform 0.2s; -webkit-tap-highlight-color: transparent; } .fab-main:active { transform: scale(0.9); } .fab-main svg { width: 30px; height: 30px; fill: white; pointer-events: none; }
        .fab-secondary { background: white; color: var(--primary); width: 50px; height: 50px; border-radius: 50%; display: flex; justify-content: center; align-items: center; box-shadow: 0 5px 15px rgba(0,0,0,0.1); cursor: pointer; border: none; transition: transform 0.2s; -webkit-tap-highlight-color: transparent;} .fab-secondary:active { transform: scale(0.9); } .fab-secondary svg { width: 24px; height: 24px; fill: currentColor; pointer-events: none; }
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; height: 70px; background: white; border-top: 1px solid #f0f0f0; display: flex; justify-content: space-around; align-items: center; z-index: 1000; padding-bottom: env(safe-area-inset-bottom); box-shadow: 0 -5px 20px rgba(0,0,0,0.03); }
        .nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--nav-inactive); font-size: 10px; font-weight: 600; width: 100%; height: 100%; cursor: pointer; transition: all 0.2s; } .nav-item.active { color: var(--primary); transform: translateY(-2px); } .nav-item svg { width: 26px; height: 26px; fill: currentColor; margin-bottom: 4px; }
        .chart-container { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px 0; position: relative; }
        .circular-chart { display: block; margin: 0 auto; max-width: 80%; max-height: 250px; }
        .circle-bg { 
            fill: none; 
            stroke: #eee; 
            stroke-width: 3.8; 
        }
        .circle { 
            fill: none; 
            stroke-width: 3.8;
            stroke-linecap: butt;
            transition: stroke-dasharray 0.6s ease; 
        }
        .chart-text-group { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -40%); text-align: center; }
        .chart-val { font-size: 32px; font-weight: 800; color: var(--primary); display: block; line-height: 1;}
        .chart-label { font-size: 12px; color: #90a4ae; font-weight: 600; text-transform: uppercase; margin-top: 5px; display: block;}
        .stat-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #f0f0f0; font-size: 14px;} .stat-row:last-child { border-bottom: none; }
        .stat-val { font-weight: 700; color: var(--primary); }
        .stat-sub-val { font-size: 12px; color:#90a4ae; font-weight: 600; margin-right: 8px;}
        .card { background: var(--card); border-radius: 20px; padding: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); margin-bottom: 15px; }
        .month-selector { display: flex; align-items: center; justify-content: center; background: #f0f2f5; border-radius: 12px; padding: 4px 8px; min-width: 160px; gap: 15px; }
        .month-btn { background: none; border: none; padding: 8px; cursor: pointer; color: var(--primary); font-size: 20px; font-weight: bold; flex-shrink: 0; display: flex; align-items: center; justify-content: center; }
        .month-display { font-size: 14px; font-weight: 700; text-align: center; white-space: nowrap; min-width: 110px; }
        input[type="text"], input[type="number"], textarea, select { width: 100%; padding: 14px; border: 1px solid #e0e0e0; border-radius: 12px; box-sizing: border-box; font-size: 16px; margin-top: 8px; background: #f9f9f9; font-family: inherit; font-weight: 500;}
        input:focus, textarea:focus, select:focus { outline: none; border-color: var(--primary); background: white; }
        label { font-size: 11px; color: #78909c; font-weight: 800; text-transform: uppercase; margin-top: 18px; display: block; letter-spacing: 0.5px;}
        .modal-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(38, 50, 56, 0.8); backdrop-filter: blur(4px); 
            display: none; justify-content: center; align-items: center; 
            z-index: 5000; touch-action: none;
        }
        #addModal { z-index: 6000; }
        #confirmModal { z-index: 7000; }
        .modal-overlay.open { display: flex; animation: fadeIn 0.2s; }
        .modal-box { 
            background: white; padding: 25px; border-radius: 24px; 
            width: 90%; max-width: 360px; min-width: 300px; 
            box-shadow: 0 20px 60px rgba(0,0,0,0.4); 
            max-height: 85vh; overflow-y: auto;
            position: relative;
            z-index: 6001; 
            transform: translate3d(0,0,0);
        }
        .btn-row { display: flex; justify-content: flex-end; margin-top: 25px; gap: 10px; }
        .btn { padding: 12px 24px; border-radius: 12px; border: none; font-weight: 700; cursor: pointer; font-size: 15px; transition: 0.2s;} .btn:active { transform: scale(0.96); }
        .btn-cancel { background: transparent; color: #78909c; } .btn-save { background: var(--primary); color: white; } .btn-delete { background: #ffebee; color: #d32f2f; }
        .btn-text { background: none; border: none; color: var(--accent); font-size: 11px; font-weight: bold; cursor: pointer; text-decoration: underline; margin-top: 5px; display: block; text-align: right;}
        details { margin-top: 15px; border: 1px solid #eee; border-radius: 12px; padding: 15px; } summary { font-size: 13px; font-weight: 700; color: var(--primary); cursor: pointer; outline: none; }
        .detail-row { display: flex; justify-content: space-between; align-items: center; margin-top: 12px; } .detail-row label { margin: 0; font-size: 13px; color: #455a64; font-weight: 500;} .detail-row input[type="checkbox"] { width: 24px; height: 24px; margin: 0; accent-color: var(--accent);} .detail-row input[type="text"] { width: 90px; padding: 8px; font-size: 14px; margin: 0; } .line-input-row { display: flex; gap: 10px; margin-top: 5px; }
        /* --- –°–¢–ò–õ–ò –î–õ–Ø –ó–ê–ú–ï–¢–û–ö --- */
        
    
/* –í–∞—Ä–∏–∞–Ω—Ç: –ö–†–£–ì–õ–ê–Ø –¢–û–ß–ö–ê */
.cal-cell.has-note::after {
    content: ''; 
    position: absolute; 
    top: 4px;      /* –û—Ç—Å—Ç—É–ø —Å–≤–µ—Ä—Ö—É */
    right: 4px;    /* –û—Ç—Å—Ç—É–ø —Å–ø—Ä–∞–≤–∞ */
    width: 8px;    /* –†–∞–∑–º–µ—Ä —Ç–æ—á–∫–∏ */
    height: 8px;
    background-color: #ff1744; /* –ö—Ä–∞—Å–Ω—ã–π —Ü–≤–µ—Ç */
    border-radius: 50%;        /* –î–µ–ª–∞–µ—Ç –∫—Ä—É–≥ */
    box-shadow: 0 0 0 1px #fff; /* –ë–µ–ª–∞—è –æ–±–≤–æ–¥–∫–∞, —á—Ç–æ–±—ã –æ—Ç–¥–µ–ª—è—Ç—å –æ—Ç —Ñ–æ–Ω–∞ */
    border: none;
}
    /* –ò–∫–æ–Ω–∫–∞ –≤ —Å–ø–∏—Å–∫–µ —Å–º–µ–Ω */
    .note-icon {
    font-size: 14px;
    margin-left: 6px;
    cursor: help;
    text-decoration: none;
    }
    /* –°—Ç–∏–ª—å –¥–ª—è –æ—Ç–ø—É—Å–∫–∞ (–ì–æ–ª—É–±–æ–π) */
    .cal-cell.type-vacation { 
            background: #fff3e0 !important; /* –°–≤–µ—Ç–ª–æ-–æ—Ä–∞–Ω–∂–µ–≤—ã–π —Ñ–æ–Ω */
            color: #e65100 !important;      /* –¢–µ–º–Ω–æ-–æ—Ä–∞–Ω–∂–µ–≤—ã–π —Ç–µ–∫—Å—Ç */
            border-color: #ffe0b2 !important; /* –†–∞–º–∫–∞ —á—É—Ç—å —Ç–µ–º–Ω–µ–µ —Ñ–æ–Ω–∞ */
        }
        /* –¶–≤–µ—Ç —Ü–∏—Ñ—Ä—ã —á–∏—Å–ª–∞ */
        .cal-cell.type-vacation .cal-num { 
            color: #ef6c00 !important; 
        }
    </style>
</head>
<body>

    <div id="loader">
        <div class="spinner"></div>
        <div class="loader-text">–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è...</div>
    </div>

    <header>
        <h1 id="headerTitle">–ú–æ–∏ —Å–º–µ–Ω—ã</h1>
        <button class="header-btn" onclick="openImportModal()" title="–ò–º–ø–æ—Ä—Ç"><svg viewBox="0 0 24 24"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg></button>
    </header>

    <div id="tab-today" class="page"><div id="todayContent"></div></div>

    <div id="tab-home" class="page active">
        <div id="shiftList"></div>
        <div class="fab-container">
            <button class="fab-secondary" onclick="openCalendarModal()"><svg viewBox="0 0 24 24"><path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20a2 2 0 0 0 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V10h14v10zM9 14H7v-2h2v2zm4 0h-2v-2h2v2zm4 0h-2v-2h2v2zm-8 4H7v-2h2v2zm4 0h-2v-2h2v2zm4 0h-2v-2h2v2z"/></svg></button>
            <button class="fab-main" onclick="openModal()"><svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6V13z"/></svg></button>
        </div>
    </div>
    
    <div id="tab-stats" class="page">
        <div class="card">
            <h3 style="margin-top:0; color:var(--primary); display:flex; justify-content:space-between; align-items:center;">
                <span>üìä –°–≤–æ–¥–∫–∞</span>
                

<div class="month-selector">
    <button class="month-btn" onclick="changeStatsMonth(-1)">&#8249;</button>
    <div class="month-display" id="statsMonthDisplay"></div>
    <button class="month-btn" onclick="changeStatsMonth(1)">&#8250;</button>
    <button class="month-btn" style="color: #e53935; margin-left: 5px;" onclick="wipeCurrentMonth()" title="–û—á–∏—Å—Ç–∏—Ç—å –º–µ—Å—è—Ü">üóëÔ∏è</button>
</div>
            </h3>
            <div class="chart-container">
                <svg viewBox="0 0 36 36" class="circular-chart">
                    <path class="circle-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                    <path class="circle" stroke="#ffab00" stroke-dasharray="0, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" id="circlePath" />
                    <path class="circle" stroke="#00c853" stroke-dasharray="0, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" id="circlePathOver" style="display:none;" />
                </svg>
                <div class="chart-text-group"><span class="chart-val" id="chartValue">0</span><span class="chart-label">–ß–∞—Å–æ–≤</span></div>
            </div>
            <div class="stat-row"><span>–ù–æ—Ä–º–∞ (36—á):</span> <span class="stat-val" id="st_norm">0</span></div>
            <div class="stat-row"><span>–û—Ç—Ä–∞–±–æ—Ç–∞–Ω–æ:</span> <span class="stat-val" id="st_hours">0</span></div>
            <div class="stat-row" style="background:#fff3e0; margin:0 -10px; padding:10px; border-radius:8px; margin-bottom:5px;"><span>–ü–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∞:</span> <span class="stat-val" id="st_over" style="font-size:16px;">0</span></div>
        </div>
        <div class="card">
            <h3 style="margin-top:0; color:var(--primary)">üí∞ –†–∞—Å—á–µ—Ç</h3>

            <div class="stat-row" id="row_tariff"><span>–û–ø–ª–∞—Ç–∞ –ø–æ —Ç–∞—Ä–∏—Ñ—É:</span> <span class="stat-val" id="st_tariff_money">0 ‚ÇΩ</span></div>
            <div class="stat-row" id="row_res"><span>–†–µ–∑–µ—Ä–≤:</span> <span class="stat-val" id="st_res_money">0 ‚ÇΩ</span></div>
           
            <div class="stat-row" id="row_ev"><span>–í–µ—á–µ—Ä–Ω–∏–µ (20%):</span> <div style="text-align:right"><span class="stat-sub-val" id="st_ev_hours">0—á</span><span class="stat-val" id="st_ev_money">0 ‚ÇΩ</span></div></div>
            <div class="stat-row" id="row_night"><span>–ù–æ—á–Ω—ã–µ (40%):</span> <div style="text-align:right"><span class="stat-sub-val" id="st_night_hours">0—á</span><span class="stat-val" id="st_night_money">0 ‚ÇΩ</span></div></div>
            <div class="stat-row" id="row_split"><span>–†–∞–∑—Ä—ã–≤–Ω—ã–µ (30%):</span> <div style="text-align:right"><span class="stat-sub-val" id="st_split_hours">0—á</span><span class="stat-val" id="st_split_money">0 ‚ÇΩ</span></div></div>
            <div class="stat-row" id="row_prem"><span id="lbl_prem">–ü—Ä–µ–º–∏—è:</span> <span class="stat-val" id="st_prem_money">0 ‚ÇΩ</span></div>
            <div class="stat-row" id="row_holiday" style="display:none;"><span>–ü—Ä–∞–∑–¥–Ω–∏—á–Ω—ã–µ (x2):</span> <div style="text-align:right"><span class="stat-sub-val" id="st_holiday_hours">0—á</span><span class="stat-val" id="st_holiday_money">0 ‚ÇΩ</span></div></div>
            <div class="stat-row" id="row_ot15"><span>–ü–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∞ (1.5—Ö):</span> <div style="text-align:right"><span class="stat-sub-val" id="st_ot15_hours">0—á</span><span class="stat-val" id="st_ot15_money">0 ‚ÇΩ</span></div></div>
            <div class="stat-row" id="row_ot20"><span>–ü–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∞ (2.0—Ö):</span> <div style="text-align:right"><span class="stat-sub-val" id="st_ot20_hours">0—á</span><span class="stat-val" id="st_ot20_money">0 ‚ÇΩ</span></div></div>

            <div style="margin-top:5px;"></div> 

            <div class="stat-row" id="row_sick" style="display:none;">
                <span>üöë –ë–æ–ª—å–Ω–∏—á–Ω—ã–π:</span> 
                <div style="text-align:right">
                    <span class="stat-sub-val" id="st_sick_days">0 –¥–Ω.</span>
                    <span class="stat-val" id="st_sick_money">0 ‚ÇΩ</span>
                </div>
            </div>
            <div class="stat-row" id="row_vacation" style="display:none;"><span>üèñÔ∏è –û—Ç–ø—É—Å–∫–Ω—ã–µ:</span> <span class="stat-val" id="st_vacation_money">0 ‚ÇΩ</span></div>
            <div class="stat-row" id="row_donor" style="display:none;"><span>ü©∏ –î–æ–Ω–æ—Ä—Å–∫–∏–µ:</span> <span class="stat-val" id="st_donor_money">0 ‚ÇΩ</span></div>
            <div class="stat-row" id="row_med" style="display:none;"><span>ü©∫ –ú–µ–¥. –∫–æ–º–∏—Å—Å–∏—è:</span> <span class="stat-val" id="st_med_money">0 ‚ÇΩ</span></div>
            <div class="stat-row" id="row_study" style="display:none;"><span>üéì –£—á–µ–±–∞ (–£–ü–¶):</span> <span class="stat-val" id="st_study_money">0 ‚ÇΩ</span></div>

            <div style="border-top:1px solid #eee; margin:8px 0;"></div>

            <div class="stat-row" id="row_class"><span id="lbl_class">–ö–ª–∞—Å—Å–Ω–æ—Å—Ç—å:</span> <span class="stat-val" id="st_class_money">0 ‚ÇΩ</span></div>
            <div class="stat-row" id="row_sen"><span id="lbl_sen">–í—ã—Å–ª—É–≥–∞:</span> <span class="stat-val" id="st_sen_money">0 ‚ÇΩ</span></div>
            <div class="stat-row" id="row_senior" style="display:none;"><span id="lbl_senior">–°—Ç. –º–∞—à–∏–Ω–∏—Å—Ç:</span> <span class="stat-val" id="st_senior_money">0 ‚ÇΩ</span></div>
            <div class="stat-row" id="row_mentor" style="display:none;"><span id="lbl_mentor">–ù–∞—Å—Ç–∞–≤–Ω–∏–∫:</span> <div style="text-align:right"><span class="stat-sub-val" id="st_mentor_hours">0—á</span><span class="stat-val" id="st_mentor_money">0 ‚ÇΩ</span></div></div>

            <div class="stat-row" id="row_tech" style="display:none;"><span>–¢–µ—Ö. —É—á–µ–±–∞:</span> <span class="stat-val" id="st_tech_money">0 ‚ÇΩ</span></div>
            
            <div style="border-top:2px solid #eee; margin:10px 0;"></div>

            <div class="stat-row"><span>–ù–∞—á–∏—Å–ª–µ–Ω–æ:</span> <span class="stat-val" id="st_dirty">0 ‚ÇΩ</span></div>
            <div class="stat-row"><span>–ü—Ä–æ—Ñ—Å–æ—é–∑ (1%):</span> <span class="stat-val" id="st_union" style="color:#e53935">0 ‚ÇΩ</span></div>
            <div class="stat-row"><span id="lbl_tax">–ù–∞–ª–æ–≥ (13%):</span> <span class="stat-val" id="st_tax" style="color:#e57373">0 ‚ÇΩ</span></div>
            <div id="rich_alert" style="text-align:right; font-size:10px; color:#d32f2f; font-weight:800; display:none; margin-top:-8px; margin-bottom:8px; opacity:0.8;"></div>

            <div class="stat-row" id="row_bonus_base">
                <span style="color:#90a4ae;">üè¶ –°—É–º–º–∞ –¥–ª—è –≥–æ–¥–æ–≤–æ–π –ø—Ä–µ–º–∏–∏:</span> 
                <span class="stat-val" id="st_bonus_base">0 ‚ÇΩ</span>
            </div>

            <div class="stat-row" style="font-size:20px; border-top:2px solid #eee; margin-top:10px; padding-top:15px"><span>–ù–∞ —Ä—É–∫–∏:</span> <span class="stat-val" id="st_net" style="color:#2e7d32">0 ‚ÇΩ</span></div>
        </div>
    </div>

    <div id="tab-settings" class="page">
        <div class="card">
            <h3 style="margin-top:0; color:var(--primary)">‚öôÔ∏è –ü—Ä–æ—Ñ–∏–ª—å</h3>
            <label>–¢–∞—Ä–∏—Ñ (–û—Å–Ω–æ–≤–Ω–æ–π)</label><input type="text" inputmode="decimal" id="set_rate" onchange="saveAll()">
            <label>–ö–ª–∞—Å—Å –∫–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏–∏</label><select id="set_class" onchange="saveAll()"><option value="0">–ë–µ–∑ –∫–ª–∞—Å—Å–∞</option><option value="30">1 –∫–ª–∞—Å—Å (30%)</option><option value="20">2 –∫–ª–∞—Å—Å (20%)</option><option value="10">3 –∫–ª–∞—Å—Å (10%)</option></select>
            <label>–î–∞—Ç–∞ —Ç—Ä—É–¥–æ—É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</label><input type="date" id="set_start_date" onchange="saveAll()">
            <div style="font-size:13px; color:var(--primary); margin-top:8px; text-align:right; font-weight:600;" id="set_exp_text"></div>
            <label>–ü—Ä–µ–º–∏—è (%)</label><input type="text" inputmode="decimal" id="set_prem" onchange="saveAll()">
            <div style="margin-top:25px; display:flex; align-items:center; padding:12px; background:#e3f2fd; border-radius:12px;"><input type="checkbox" id="set_mentor" style="width:24px; height:24px; margin:0;" onchange="saveAll()"><span style="margin-left:12px; font-weight:700; color:#1565c0; font-size:14px;">–ù–∞—Å—Ç–∞–≤–Ω–∏–∫ (+15%)</span></div>
            <div style="margin-top:10px; display:flex; align-items:center; padding:12px; background:#e3f2fd; border-radius:12px;"><input type="checkbox" id="set_senior" style="width:24px; height:24px; margin:0;" onchange="saveAll()"><span style="margin-left:12px; font-weight:700; color:#1565c0; font-size:14px;">–°—Ç. –º–∞—à–∏–Ω–∏—Å—Ç (+10%)</span></div>
            <div style="margin-top:10px; display:flex; align-items:center; padding:12px; background:#e3f2fd; border-radius:12px;"><input type="checkbox" id="set_union" style="width:24px; height:24px; margin:0;" onchange="saveAll()"><span style="margin-left:12px; font-weight:700; color:#1565c0; font-size:14px;">–ß–ª–µ–Ω –ø—Ä–æ—Ñ—Å–æ—é–∑–∞ (-1%)</span></div>
            
            <div style="margin-top:30px; padding:15px; background:#fff3e0; border-radius:12px; text-align:center;">
                <div id="cloudStatus" style="font-size:12px; font-weight:bold; color:#f57c00; margin-bottom:10px;">–°—Ç–∞—Ç—É—Å –æ–±–ª–∞–∫–∞: –ü—Ä–æ–≤–µ—Ä–∫–∞...</div>
                <button onclick="forcePushToCloud()" style="background:#ff9800; color:white; border:none; padding:10px 15px; border-radius:10px; font-weight:bold; width:100%;">üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ –û–±–ª–∞–∫–æ</button>
                <div style="font-size:10px; color:#8d6e63; margin-top:5px;">–ù–∞–∂–º–∏, –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ –µ—Å—Ç—å, –∞ –Ω–∞ –ü–ö –Ω–µ—Ç.</div>
            </div>
        </div>
        <div class="card" style="background: linear-gradient(135deg, #263238 0%, #37474f 100%); color: white; text-align: center; margin-top: 15px;">
    <h3 style="margin-top:0; margin-bottom: 8px; color:white; font-size: 16px;">ü§ù –†–∞–∑–≤–∏—Ç–∏–µ –ø—Ä–æ–µ–∫—Ç–∞</h3>
    <div style="font-size:12px; opacity:0.8; margin-bottom:15px; line-height: 1.4;">
        –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –±–µ—Å–ø–ª–∞—Ç–Ω–æ–µ. –ï—Å–ª–∏ –æ–Ω–æ –ø–æ–º–æ–≥–∞–µ—Ç –≤ —Ä–∞–±–æ—Ç–µ ‚Äî –±—É–¥—É –±–ª–∞–≥–æ–¥–∞—Ä–µ–Ω –∑–∞ –ø–æ–¥–¥–µ—Ä–∂–∫—É (–æ–ø–ª–∞—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π).
    </div>
    <button onclick="openDonation()" style="background: var(--accent); color: white; border: none; padding: 12px 20px; border-radius: 12px; font-weight: 800; width: 100%; font-size: 14px; box-shadow: 0 4px 15px rgba(255, 171, 0, 0.3);">
        –ü–æ–¥–¥–µ—Ä–∂–∞—Ç—å
    </button>
</div>
        <div style="text-align:center; font-size:11px; color:#b0bec5; margin-top:20px;">–ì—Ä–∞—Ñ–∏–∫–ë—Ä–æ v1.1 (Clean)</div>
    </div>

    
</div>
    
    
</div>
    </div>

    <div class="modal-overlay" id="addModal">
	<div class="modal-box">
            <h3 style="margin-top:0; color:var(--primary)" id="modalTitle">–ù–æ–≤–∞—è —Å–º–µ–Ω–∞</h3>
            <label>–î–∞—Ç–∞</label>
            <input type="date" id="inpDate">
            <label>–¢–µ–∫—Å—Ç –∏–∑ –≥—Ä–∞—Ñ–∏–∫–∞</label>
            <div style="position: relative; display: flex; align-items: center;">
                <input type="text" id="inpText" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –º75 14:00-22:00 –∏–ª–∏ –ë–õ" oninput="checkShiftText()" style="padding-right: 40px; margin-top: 8px;">
                <button onclick="pasteFromClipboard()" title="–í—Å—Ç–∞–≤–∏—Ç—å" style="position: absolute; right: 5px; top: 50%; transform: translateY(-30%); background: none; border: none; cursor: pointer; font-size: 18px; padding: 5px; z-index: 10;">
                    üìã
                </button>
            </div>
            <label>–ó–∞–º–µ—Ç–∫–∞</label>
            <textarea id="inpNote" rows="2" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –∑–∞–π—Ç–∏ –≤ –∫–∞–¥—Ä—ã, –Ω–æ–º–µ—Ä–∞ –≤–∞–≥–æ–Ω–æ–≤..."></textarea>

            <div id="sickDetailsBox" style="display:none; background:#e8f5e9; padding:15px; border-radius:12px; margin-top:15px; border:1px solid #c8e6c9;">
                <h4 style="margin:0 0 10px 0; color:#2e7d32;">üöë –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –±–æ–ª—å–Ω–∏—á–Ω–æ–≥–æ</h4>
                <label id="lbl_year_1">–î–æ—Ö–æ–¥ –∑–∞ –ø—Ä–æ—à–ª—ã–π –≥–æ–¥</label>
                <input type="text" inputmode="decimal" id="sickInc1" placeholder="–°—É–º–º–∞ –∏–∑ 2-–ù–î–§–õ (–∫–æ–¥ 2000)">
                <label id="lbl_year_2">–î–æ—Ö–æ–¥ –∑–∞ –ø–æ–∑–∞–ø—Ä–æ—à–ª—ã–π –≥–æ–¥</label>
                <input type="text" inputmode="decimal" id="sickInc2" placeholder="–°—É–º–º–∞ –∏–∑ 2-–ù–î–§–õ (–∫–æ–¥ 2000)">
                <label>–°—Ç–∞–∂ (–ø—Ä–æ—Ü–µ–Ω—Ç –æ–ø–ª–∞—Ç—ã)</label>
                <select id="sickPercent">
                    <option value="100">100% (8+ –ª–µ—Ç —Å—Ç–∞–∂–∞)</option>
                    <option value="80">80% (5-8 –ª–µ—Ç —Å—Ç–∞–∂–∞)</option>
                    <option value="60">60% (–¥–æ 5 –ª–µ—Ç —Å—Ç–∞–∂–∞)</option>
                </select>
                <div style="margin-top:10px; font-size:11px; color:#558b2f;">* –°—É–º–º—ã —Å–æ—Ö—Ä–∞–Ω—è—Ç—Å—è –¥–ª—è –≤—Å–µ—Ö –ë–õ –≤ —ç—Ç–æ–º –≥–æ–¥—É</div>
            </div>

            <details id="shiftDetailsBox">
                <summary>‚öôÔ∏è –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —ç—Ç–æ–π —Å–º–µ–Ω—ã</summary>
                <div class="detail-row">
    <label>–°—Ç–∞–≤–∫–∞ (‚ÇΩ/—á–∞—Å)</label>
    <div style="text-align: right;">
        <input type="text" inputmode="decimal" id="shiftRate">
        <div id="rateHint" style="display:none; font-size:9px; color:#ef6c00; margin-top:4px; font-weight:700;">
            üìâ –†–µ–∑–µ—Ä–≤ (–≤—Ä–µ–¥–Ω–æ—Å—Ç—å 8%)
        </div>
    </div>
</div>

<div class="detail-row">
    <label>–ü—Ä–µ–º–∏—è (%)</label>
    <input type="text" inputmode="decimal" id="shiftPrem">
</div>
                <div class="detail-row"><label>–ö–ª–∞—Å—Å</label><select id="shiftClassSelect"><option value="0">–ë–µ–∑ –∫–ª–∞—Å—Å–∞</option><option value="30">1 –∫–ª–∞—Å—Å</option><option value="20">2 –∫–ª–∞—Å—Å</option><option value="10">3 –∫–ª–∞—Å—Å</option></select></div>
                <div id="lineWorkContainer" style="display:none;"><div class="line-input-row" style="margin-top:15px;"><input type="time" id="lineStart"><span style="align-self:center">-</span><input type="time" id="lineEnd"></div><div style="font-size:10px; color:#90a4ae; margin-top:5px;">–í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã –Ω–∞ –ª–∏–Ω–∏–∏</div></div>
               <div style="margin-top:15px; background:#e3f2fd; padding:10px; border-radius:12px; border:1px solid #bbdefb;">
    <label style="color:#1565c0; margin-top:0; font-size:12px; font-weight:800; display:block; margin-bottom:5px;">üè• –¢–µ—Ä–∞–ø–µ–≤—Ç–∏—á–µ—Å–∫–∏–π –ø—É–Ω–∫—Ç / –û—Ç—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ</label>
    
    <div class="line-input-row">
        <input type="time" id="tpStart" placeholder="–ù–∞—á–∞–ª–æ">
        <span style="align-self:center; color:#1565c0; font-weight:bold;">-</span>
        <input type="time" id="tpEnd" placeholder="–ö–æ–Ω–µ—Ü">
    </div>
    
    <div class="detail-row" style="margin-top:8px;">
        <label style="color:#c62828; font-weight:bold; font-size:12px;">‚õî –ù–µ –¥–æ–ø—É—Å–∫ (–ü–æ–ª–Ω–æ–µ —Å–Ω—è—Ç–∏–µ)</label>
        <input type="checkbox" id="shiftFullMedical" style="width:20px; height:20px; margin:0;">
    </div>
</div>
               <div class="detail-row" style="margin-top:15px;"><label style="flex:1;">–¢–µ—Ö. —É—á–µ–±–∞ (2—á)</label><input type="checkbox" id="shiftTech"></div><div class="detail-row"><label style="flex:1;">–ü–æ—Å–ª–µ—Ä–µ–π—Å–æ–≤—ã–π (+10 –º–∏–Ω)</label><input type="checkbox" id="shiftPostTrip"></div><div class="detail-row" style="margin-top:15px;"><label>–ù–∞—Å—Ç–∞–≤–Ω–∏–∫ (+15%)</label><input type="checkbox" id="shiftMentor"></div><div class="detail-row"><label>–°—Ç. –ú–∞—à–∏–Ω–∏—Å—Ç (+10%)</label><input type="checkbox" id="shiftSenior"></div>
            </details>

            <div class="btn-row">
                <button class="btn btn-delete" id="btnDeleteShift" onclick="deleteCurrentShift()" style="display:none; margin-right:auto;">–£–¥–∞–ª–∏—Ç—å</button>
                <button class="btn btn-cancel" onclick="closeModal('addModal')">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn btn-save" id="btnSaveShift" onclick="addShift()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>
    <div class="modal-overlay" id="confirmModal">
        <div class="modal-box">
            <h3 style="margin-top:0; color:var(--primary)">–£–¥–∞–ª–µ–Ω–∏–µ</h3>
            <div style="margin-bottom:20px; font-size:15px;">–í—ã —Ç–æ—á–Ω–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É —Å–º–µ–Ω—É –Ω–∞–≤—Å–µ–≥–¥–∞?</div>
            <div class="btn-row">
                <button class="btn btn-cancel" onclick="closeModal('confirmModal')">–ù–µ—Ç</button>
                <button class="btn btn-delete" onclick="commitDelete()">–î–∞, —É–¥–∞–ª–∏—Ç—å</button>
            </div>
        </div>
    </div>
    <div class="modal-overlay" id="importModal"><div class="modal-box"><h3 style="margin-top:0; color:var(--primary)">–ò–º–ø–æ—Ä—Ç —Å–º–µ–Ω</h3><label>–í—Å—Ç–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç —Å–ø–∏—Å–∫–∞:</label><textarea id="importText" rows="8" placeholder="1.01.25 –º61 20:22-2:46..."></textarea><div class="btn-row"><button class="btn btn-cancel" onclick="closeModal('importModal')">–û—Ç–º–µ–Ω–∞</button><button class="btn btn-save" onclick="processImport()">–†–∞—Å–ø–æ–∑–Ω–∞—Ç—å</button></div></div></div>
    <div class="modal-overlay" id="calendarModal"><div class="modal-box" style="max-width: 400px;" id="calModalBox"><div class="cal-header"><button class="cal-btn" onclick="changeMonth(-1)">&#8249;</button><div class="cal-title" id="calTitle">–ù–æ—è–±—Ä—å 2025</div><button class="cal-btn" onclick="changeMonth(1)">&#8250;</button></div><div class="cal-grid" id="calGrid"></div><div class="btn-row"><button class="btn btn-cancel" onclick="closeModal('calendarModal')">–ó–∞–∫—Ä—ã—Ç—å</button></div></div></div>

    <nav class="bottom-nav">
        <div class="nav-item" id="nav-today" onclick="switchTab('today')"><svg viewBox="0 0 24 24"><path d="M13 3c-4.97 0-9 4.03-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42C8.27 19.99 10.51 21 13 21c4.97 0 9-4.03 9-9s-4.03-9-9-9zm-1 5v5l4.28 2.54.72-1.21-3.5-2.08V8H12z"/></svg><span>–°–µ–≥–æ–¥–Ω—è</span></div>
        <div class="nav-item active" id="nav-home" onclick="switchTab('home')"><svg viewBox="0 0 24 24"><path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20a2 2 0 0 0 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V10h14v10zM9 14H7v-2h2v2zm4 0h-2v-2h2v2zm4 0h-2v-2h2v2zm-8 4H7v-2h2v2zm4 0h-2v-2h2v2zm4 0h-2v-2h2v2z"/></svg><span>–ö–∞–ª–µ–Ω–¥–∞—Ä—å</span></div>
        <div class="nav-item" onclick="switchTab('stats')"><svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/></svg><span>–°–≤–æ–¥–∫–∞</span></div>
        <div class="nav-item" onclick="switchTab('settings')"><svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/></svg><span>–ü—Ä–æ—Ñ–∏–ª—å</span></div>
    </nav>

    <script src="calc_logic.js"></script>
    <script src="calculator.js"></script>

<script>
    

    let shifts = JSON.parse(localStorage.getItem('metro_shifts')) || [];
    let settings = JSON.parse(localStorage.getItem('metro_settings')) || { 
    rate: 546.18, classP: false, premP: 35, mentor: false, senior: false, 
    startDate: "", union: true, sickData: {}, sickPercent: 100 
    };
    // --- 1. –ù–û–í–ê–Ø –ü–ï–†–ï–ú–ï–ù–ù–ê–Ø –î–õ–Ø –ú–ï–¢–ê–î–ê–ù–ù–´–• ---
let syncMeta = JSON.parse(localStorage.getItem('metro_sync_meta')) || {};

// --- 2. –§–£–ù–ö–¶–ò–Ø –û–ë–ù–û–í–õ–ï–ù–ò–Ø –í–†–ï–ú–ï–ù–ò (–í—ã–∑—ã–≤–∞—Ç—å –ø—Ä–∏ –ª—é–±–æ–º –∏–∑–º–µ–Ω–µ–Ω–∏–∏) ---
function touchMeta(key) {
    syncMeta[key] = new Date().getTime();
    localStorage.setItem('metro_sync_meta', JSON.stringify(syncMeta));
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è: –ø–æ–ª—É—á–∏—Ç—å –∫–ª—é—á –º–µ—Å—è—Ü–∞ –ø–æ –¥–∞—Ç–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä "2025-11-01" -> "s_2025_11")
function getMonthKey(dateStr) {
    if (!dateStr) return null;
    const y = dateStr.substring(0, 4);
    const m = dateStr.substring(5, 7);
    return `s_${y}_${m}`;
}
    let calDate = new Date();
    let statsDate = new Date();
    let preventRender = false;
    let isFirstLoad = true;
    const tg = window.Telegram.WebApp;
    
    function saveData() {
        // --- –ê–í–¢–û–ß–ò–°–¢–ö–ê –î–£–ë–õ–ï–ô (FIX) ---
        const uniqueMap = new Map();
        shifts.forEach(s => {
            if (s.date && s.date.length >= 10) {
                const cleanDate = s.date.trim().substring(0, 10);
                s.date = cleanDate;
                uniqueMap.set(cleanDate, s);
            }
        });
        shifts = Array.from(uniqueMap.values());
        // -------------------------------

        localStorage.setItem('metro_shifts', JSON.stringify(shifts));
        localStorage.setItem('metro_settings', JSON.stringify(settings));
        saveAllToCloud();
    }
    
    function saveSettings() {
        settings.rate = safeFloat(document.getElementById('set_rate').value);
        settings.classP = parseInt(document.getElementById('set_class').value);
        settings.premP = safeFloat(document.getElementById('set_prem').value);
        settings.mentor = document.getElementById('set_mentor').checked;
        settings.senior = document.getElementById('set_senior').checked;
        settings.startDate = document.getElementById('set_start_date').value;
        settings.union = document.getElementById('set_union').checked;
        touchMeta('metro_settings');
        calcExpDisplay();
    }

    let touchStartX = 0;
    let touchStartY = 0; // 1. –î–æ–±–∞–≤–∏–ª–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—É Y
    let touchEndX = 0;
    let touchEndY = 0;   // 2. –î–æ–±–∞–≤–∏–ª–∏ –∫–æ–Ω–µ—á–Ω—É—é Y

    // –ó–∞–ø–æ–º–∏–Ω–∞–µ–º –Ω–∞—á–∞–ª–æ –∫–∞—Å–∞–Ω–∏—è (–∏ X, –∏ Y)
    document.addEventListener('touchstart', e => { 
        touchStartX = e.changedTouches[0].screenX; 
        touchStartY = e.changedTouches[0].screenY; 
    }, {passive: false});

    // –ó–∞–ø–æ–º–∏–Ω–∞–µ–º –∫–æ–Ω–µ—Ü –∫–∞—Å–∞–Ω–∏—è
    document.addEventListener('touchend', e => { 
        touchEndX = e.changedTouches[0].screenX; 
        touchEndY = e.changedTouches[0].screenY; 
        handleSwipe(); 
    }, {passive: false});

    function handleSwipe() {
        if (document.body.classList.contains('modal-open')) return;
        
        const threshold = 70; // –ß—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å–≤–∞–π–ø–∞
        const diffX = touchEndX - touchStartX;
        const diffY = touchEndY - touchStartY; // –†–∞–∑–Ω–∏—Ü–∞ –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏

        // === –ì–õ–ê–í–ù–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï ===
        // –ï—Å–ª–∏ –¥–≤–∏–∂–µ–Ω–∏–µ –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏ –±–æ–ª—å—à–µ, —á–µ–º –ø–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–∏ ‚Äî —ç—Ç–æ —Å–∫—Ä–æ–ª–ª.
        // –ú—ã –ø—Ä–æ—Å—Ç–æ –≤—ã—Ö–æ–¥–∏–º –∏ –Ω–∏—á–µ–≥–æ –Ω–µ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º.
        if (Math.abs(diffY) > Math.abs(diffX)) return;
        // ===========================

        if (Math.abs(diffX) > threshold) {
            const tabs = ['today', 'home', 'stats', 'settings'];
            const currentTab = document.querySelector('.page.active').id.replace('tab-', '');
            let idx = tabs.indexOf(currentTab);
            
            if (diffX < 0) { // –°–≤–∞–π–ø –≤–ª–µ–≤–æ (—Å–ª–µ–¥—É—é—â–∞—è –≤–∫–ª–∞–¥–∫–∞)
                idx++; 
                if (idx >= tabs.length) return; 
            } else { // –°–≤–∞–π–ø –≤–ø—Ä–∞–≤–æ (–ø—Ä–µ–¥—ã–¥—É—â–∞—è –≤–∫–ª–∞–¥–∫–∞)
                idx--; 
                if (idx < 0) return; 
            }
            switchTab(tabs[idx]);
        }
    }


    function safeFloat(val) {
        if (!val) return 0;
        let str = String(val).replace(/\s/g, '').replace(',', '.');
        const n = parseFloat(str);
        if (isNaN(n) || !isFinite(n)) return 0;
        return n;
    }

    function getIsoDate(dateObj) { 
        if (!dateObj || !(dateObj instanceof Date) || isNaN(dateObj.getTime())) return "";
        const y = dateObj.getFullYear(); 
        const m = String(dateObj.getMonth() + 1).padStart(2, '0'); 
        const d = String(dateObj.getDate()).padStart(2, '0'); 
        return `${y}-${m}-${d}`; 
    }

    function fmtMoney(val) { if (isNaN(val)) return "0 ‚ÇΩ"; return Math.round(val).toLocaleString() + ' ‚ÇΩ'; }
    
    function updateCloudStatus(msg, isError = false) {
        const el = document.getElementById('cloudStatus');
        if(el) { el.innerText = "–û–±–ª–∞–∫–æ: " + msg; el.style.color = isError ? "#e53935" : "#2e7d32"; }
    }
	
    

    function init() {
        // --- –ñ–ï–õ–ï–ó–ù–ê–Ø –ß–ò–°–¢–ö–ê –î–£–ë–õ–ï–ô –ü–†–ò –ó–ê–ü–£–°–ö–ï (FIX) ---
        if (shifts && shifts.length > 0) {
            const uniqueMap = new Map();
            shifts.forEach(s => {
                // –í–ê–ñ–ù–û: –û—Ç—Ä–µ–∑–∞–µ–º –º—É—Å–æ—Ä (–ø—Ä–æ–±–µ–ª—ã) –∏ –±–µ—Ä–µ–º —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–µ 10 —Å–∏–º–≤–æ–ª–æ–≤ –¥–∞—Ç—ã
                if (s.date && s.date.length >= 10) {
                    const cleanDate = s.date.trim().substring(0, 10);
                    s.date = cleanDate; // –ò—Å–ø—Ä–∞–≤–ª—è–µ–º —Å–∞–º—É —Å–º–µ–Ω—É
                    uniqueMap.set(cleanDate, s); // –ü–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ–º (–æ—Å—Ç–∞–Ω–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –æ–¥–Ω–∞)
                }
            });
            shifts = Array.from(uniqueMap.values());
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —á–∏—Å—Ç—É—é –±–∞–∑—É —Å—Ä–∞–∑—É
            localStorage.setItem('metro_shifts', JSON.stringify(shifts));
        }

        normalizeShifts(); 
        render(); 
        updateUI(); 
        tg.ready(); 
        tg.expand();
        if (typeof ym !== 'undefined' && tg.initDataUnsafe && tg.initDataUnsafe.user) {
            ym(105574700, 'userParams', { telegram_id: tg.initDataUnsafe.user.id });
        }
        if (tg.CloudStorage) { showLoader(); syncWithCloud(); } else { hideLoader(); }
        document.addEventListener('keydown', function(event) { if (event.key === "Escape") { closeModal('addModal'); closeModal('importModal'); closeModal('calendarModal'); } });
        const calBox = document.getElementById('calModalBox'); let tsX = 0;
        calBox.addEventListener('touchstart', e => { tsX = e.changedTouches[0].screenX; e.stopPropagation(); });
        calBox.addEventListener('touchend', e => { let teX = e.changedTouches[0].screenX; if(teX < tsX - 50) changeMonth(1); if(teX > tsX + 50) changeMonth(-1); e.stopPropagation(); });
        setInterval(updateTodayTab, 1000);
        scrollToToday();
    }
    
	
    function syncWithCloud() {
    if (!tg.CloudStorage) { hideLoader(); return; }
    
    // 1. –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∫–ª—é—á–µ–π
    tg.CloudStorage.getKeys((err, keys) => {
        if (err) { hideLoader(); updateCloudStatus("–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞", true); return; }
        if (!keys) keys = [];
        
        // –§–∏–ª—å—Ç—Ä—É–µ–º –Ω–∞—à–∏ –∫–ª—é—á–∏ + –¥–æ–±–∞–≤–ª—è–µ–º 'metro_sync_meta'
        // –ù–∞–º –Ω—É–∂–Ω–æ —Å–∫–∞—á–∞—Ç—å –ú–ï–¢–£ –∏–∑ –æ–±–ª–∞–∫–∞, —á—Ç–æ–±—ã —Å—Ä–∞–≤–Ω–∏—Ç—å
        const metaKey = 'metro_sync_meta';
        const dataKeys = keys.filter(k => k.startsWith('s_') || k === 'metro_settings');
        
        if (dataKeys.length === 0 && !keys.includes(metaKey)) {
            // –û–±–ª–∞–∫–æ –ø—É—Å—Ç–æ–µ -> –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤—Å—ë –Ω–∞—à–µ —Ç—É–¥–∞
            saveAllToCloud(() => { hideLoader(); updateCloudStatus("–û–±–ª–∞–∫–æ —Å–æ–∑–¥–∞–Ω–æ"); });
            return;
        }

        // 2. –°–∫–∞—á–∏–≤–∞–µ–º –û–±–ª–∞—á–Ω—É—é –ú–ï–¢–£ –∏ –î–∞–Ω–Ω—ã–µ
        const allKeysToFetch = [...dataKeys, metaKey];
        
        tg.CloudStorage.getItems(allKeysToFetch, (err, values) => {
            hideLoader();
            if (err) { updateCloudStatus("–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è", true); return; }

            const cloudMeta = values[metaKey] ? JSON.parse(values[metaKey]) : {};
            let hasChanges = false;
            let keysToPush = [];
            
            // --- –õ–û–ì–ò–ö–ê –°–õ–ò–Ø–ù–ò–Ø ---
            
            // –ê. –û–±—Ä–∞–±–æ—Ç–∫–∞ –ù–ê–°–¢–†–û–ï–ö
            if (values['metro_settings']) {
                const cloudTime = cloudMeta['metro_settings'] || 0;
                const localTime = syncMeta['metro_settings'] || 0;
                
                if (cloudTime > localTime) {
                    // –û–±–ª–∞–∫–æ –Ω–æ–≤–µ–µ -> –ë–µ—Ä–µ–º –∏–∑ –æ–±–ª–∞–∫–∞
                    try { 
                        settings = JSON.parse(values['metro_settings']); 
                        syncMeta['metro_settings'] = cloudTime; // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –≤—Ä–µ–º—è
                        hasChanges = true;
                    } catch(e){}
                } else if (localTime > cloudTime) {
                    // –¢–µ–ª–µ—Ñ–æ–Ω –Ω–æ–≤–µ–µ -> –ë—É–¥–µ–º –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –≤ –æ–±–ª–∞–∫–æ
                    keysToPush.push('metro_settings');
                }
            }

            // –ë. –û–±—Ä–∞–±–æ—Ç–∫–∞ –ú–ï–°–Ø–¶–ï–í (–°–ú–ï–ù)
            // –°–æ–±–∏—Ä–∞–µ–º –º–Ω–æ–∂–µ—Å—Ç–≤–æ –≤—Å–µ—Ö –∫–ª—é—á–µ–π –º–µ—Å—è—Ü–µ–≤ (–∏ –ª–æ–∫–∞–ª—å–Ω—ã—Ö, –∏ –æ–±–ª–∞—á–Ω—ã—Ö)
            const allMonthKeys = new Set([...Object.keys(syncMeta).filter(k=>k.startsWith('s_')), ...dataKeys.filter(k=>k.startsWith('s_'))]);
            
            let newShifts = [...shifts]; // –ö–æ–ø–∏—è —Ç–µ–∫—É—â–∏—Ö —Å–º–µ–Ω

            allMonthKeys.forEach(key => {
                const cloudTime = cloudMeta[key] || 0;
                const localTime = syncMeta[key] || 0;
                
                if (cloudTime > localTime) {
                    // –í –û–ë–õ–ê–ö–ï –°–í–ï–ñ–ï–ï (–∏–ª–∏ –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ –≤–æ–æ–±—â–µ –Ω–µ—Ç —ç—Ç–æ–≥–æ –º–µ—Å—è—Ü–∞) -> –ó–ê–ì–†–£–ñ–ê–ï–ú
                    // 1. –£–¥–∞–ª—è–µ–º –≤—Å–µ –ª–æ–∫–∞–ª—å–Ω—ã–µ —Å–º–µ–Ω—ã —ç—Ç–æ–≥–æ –º–µ—Å—è—Ü–∞
                    const [_, y, m] = key.split('_'); // s_2025_11
                    const prefix = `${y}-${m}`;
                    newShifts = newShifts.filter(s => !s.date.startsWith(prefix));
                    
                    // 2. –î–æ–±–∞–≤–ª—è–µ–º —Å–º–µ–Ω—ã –∏–∑ –æ–±–ª–∞–∫–∞
                    if (values[key]) {
                        try {
                            const chunk = JSON.parse(values[key]);
                            if (Array.isArray(chunk)) {
                                chunk.forEach(mini => newShifts.push(normalizeOne(mini)));
                            }
                        } catch(e) {}
                    }
                    // 3. –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—É—é –º–µ—Ç–∫—É –≤—Ä–µ–º–µ–Ω–∏, —á—Ç–æ–±—ã –∑–Ω–∞—Ç—å, —á—Ç–æ –º—ã –∞–∫—Ç—É–∞–ª—å–Ω—ã
                    syncMeta[key] = cloudTime;
                    hasChanges = true;
                    
                } else if (localTime > cloudTime) {
                    // –ù–ê –¢–ï–õ–ï–§–û–ù–ï –°–í–ï–ñ–ï–ï (—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–ª –æ—Ñ—Ñ–ª–∞–π–Ω) -> –û–¢–ü–†–ê–í–õ–Ø–ï–ú
                    keysToPush.push(key);
                }
            });

            if (hasChanges) {
                shifts = newShifts;
                localStorage.setItem('metro_shifts', JSON.stringify(shifts));
                localStorage.setItem('metro_settings', JSON.stringify(settings));
                localStorage.setItem('metro_sync_meta', JSON.stringify(syncMeta));
                render();
            }

            // 3. –ï—Å–ª–∏ –µ—Å—Ç—å —á—Ç–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å (—Ç–æ, —á—Ç–æ –Ω–æ–≤–µ–µ –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ) - –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º
            if (keysToPush.length > 0) {
                pushSpecificKeys(keysToPush, cloudMeta);
            } else {
                updateCloudStatus("–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ");
            }
        });
    });
}

// –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω—ã—Ö –∫–ª—é—á–µ–π + –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–µ—Ç—ã –≤ –æ–±–ª–∞–∫–µ
function pushSpecificKeys(keysToPush, currentCloudMeta) {
    updateCloudStatus("–û—Ç–ø—Ä–∞–≤–∫–∞...");
    
    // –ì–æ—Ç–æ–≤–∏–º –¥–∞–Ω–Ω—ã–µ
    const grouped = groupShiftsByMonth(); // –§—É–Ω–∫—Ü–∏—è –Ω–∏–∂–µ
    
    keysToPush.forEach(key => {
        // –û–±–Ω–æ–≤–ª—è–µ–º –º–µ—Ç—É, –∫–æ—Ç–æ—Ä—É—é –æ—Ç–ø—Ä–∞–≤–∏–º –≤ –æ–±–ª–∞–∫–æ
        currentCloudMeta[key] = syncMeta[key];
        
        let valueStr = "";
        if (key === 'metro_settings') {
            valueStr = JSON.stringify(settings);
        } else {
            // –≠—Ç–æ –º–µ—Å—è—Ü. –ï—Å–ª–∏ —Å–º–µ–Ω –Ω–µ—Ç (–º—ã —É–¥–∞–ª–∏–ª–∏ –≤—Å–µ), –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤ "[]"
            valueStr = JSON.stringify(grouped[key] || []);
        }
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ
        tg.CloudStorage.setItem(key, valueStr, (err)=>{});
    });
    
    // –í –∫–æ–Ω—Ü–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π —Ñ–∞–π–ª –ú–ï–¢–ê–î–ê–ù–ù–´–•
    tg.CloudStorage.setItem('metro_sync_meta', JSON.stringify(currentCloudMeta), (err) => {
        if (!err) updateCloudStatus("–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ");
    });
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è: –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ —Å–º–µ–Ω –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
function groupShiftsByMonth() {
    const grouped = {};
    shifts.forEach(s => {
        const key = getMonthKey(s.date);
        if (!grouped[key]) grouped[key] = [];
        
        // –ú–∏–Ω–∏—Ñ–∏–∫–∞—Ü–∏—è
        const mini = { d: s.date, t: s.text };
        if(s.note) mini.n = s.note;
        if(s.customRate !== undefined) mini.cr = s.customRate;
        if(s.customMentor !== undefined) mini.cm = s.customMentor;
        if(s.customSenior !== undefined) mini.cs = s.customSenior;
        if(s.customClass !== undefined) mini.cc = s.customClass;
        if(s.customSen !== undefined) mini.ce = s.customSen;
        if(s.customPrem !== undefined) mini.cp = s.customPrem;
        
        if(s.lineStart) mini.ls = s.lineStart;
        if(s.lineEnd) mini.le = s.lineEnd;
        
        // –ù–æ–≤—ã–µ –ø–æ–ª—è
        if(s.tpStart) mini.tps = s.tpStart;
        if(s.tpEnd) mini.tpe = s.tpEnd;

        // –§–ª–∞–≥–∏
        if(s.isTech) mini.it = 1;
        if(s.isPostTrip) mini.ip = 1;
        
        // –í–û–¢ –≠–¢–û–ô –°–¢–†–û–ß–ö–ò –ù–ï –•–í–ê–¢–ê–õ–û:
        if(s.isFullMedical) mini.ifm = 1; 
        
        // –°—Ç–∞—Ä–æ–µ (–Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π, –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
        if(s.isMedical) mini.im = 1; 
        
        grouped[key].push(mini);
    });
    return grouped;
}

// –§—É–Ω–∫—Ü–∏—è "—Ç–∏—Ö–æ–≥–æ" —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è (–æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ç–æ–ª—å–∫–æ —Ç–æ, —á—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å –Ω–µ–¥–∞–≤–Ω–æ)
function saveAllToCloud(cb) {
    if (!tg.CloudStorage) { if(cb) cb(); return; }
    
    // –ò—â–µ–º –∫–ª—é—á–∏, –∫–æ—Ç–æ—Ä—ã–µ –º–µ–Ω—è–ª–∏—Å—å –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 —Å–µ–∫—É–Ω–¥
    const changedKeys = Object.keys(syncMeta).filter(k => {
        return (new Date().getTime() - (syncMeta[k] || 0)) < 10000;
    });

    // –ï—Å–ª–∏ –µ—Å—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏—Ö —á–µ—Ä–µ–∑ —É–º–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é pushSpecificKeys
    if (changedKeys.length > 0) {
        // –ù–∞–º –Ω—É–∂–Ω–∞ "—Ç–µ–∫—É—â–∞—è" –º–µ—Ç–∞ –∏–∑ –æ–±–ª–∞–∫–∞, –Ω–æ —É –Ω–∞—Å –µ—ë –Ω–µ—Ç –ø–æ–¥ —Ä—É–∫–æ–π –≤ "—Ç–∏—Ö–æ–º" —Ä–µ–∂–∏–º–µ.
        // –ü–æ—ç—Ç–æ–º—É –ø–µ—Ä–µ–¥–∞–µ–º –ø—É—Å—Ç–æ–π –æ–±—ä–µ–∫—Ç {} - pushSpecificKeys —Å–∞–º–∞ —Ä–∞–∑–±–µ—Ä–µ—Ç—Å—è –∏ –ø–µ—Ä–µ–∑–∞–ø–∏—à–µ—Ç –º–µ—Ç—É.
        // (–≠—Ç–æ —É–ø—Ä–æ—â–µ–Ω–∏–µ –¥–æ–ø—É—Å—Ç–∏–º–æ, —Ç–∞–∫ –∫–∞–∫ pushSpecificKeys –≤ —Ç–≤–æ–µ–º –∫–æ–¥–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç currentCloudMeta)
        // –ù–û –õ–£–ß–®–ï –≤—ã–∑–≤–∞—Ç—å –ø–æ–ª–Ω—É—é —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏, –µ—Å–ª–∏ –ª–æ–≥–∏–∫–∞ —Å–ª–æ–∂–Ω–∞—è.
        // –í —Ç–≤–æ–µ–º —Å–ª—É—á–∞–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º pushSpecificKeys —Å –ª–æ–∫–∞–ª—å–Ω–æ–π –º–µ—Ç–æ–π:
        pushSpecificKeys(changedKeys, { ...syncMeta }); 
    }
    
    if(cb) cb();
}


// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä—É—á–Ω–æ–π –∫–Ω–æ–ø–∫–∏ "–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ –æ–±–ª–∞–∫–æ" (Force Push)
// === –ó–ê–ú–ï–ù–ò–¢–¨ –≠–¢–ò–ú –§–£–ù–ö–¶–ò–ò forcePushToCloud –∏ saveAll ===

function forcePushToCloud() {
        const btn = document.querySelector('#tab-settings button'); // –ù–∞—Ö–æ–¥–∏–º –∫–Ω–æ–ø–∫—É
        const originalText = btn.innerText;
        const originalColor = btn.style.background;

        if (shifts.length === 0) {
            // –û—à–∏–±–∫–∞: –ü—É—Å—Ç–æ
            btn.innerText = "–û—à–∏–±–∫–∞: –°–º–µ–Ω –Ω–µ—Ç! ‚ö†Ô∏è";
            btn.style.background = "#e53935";
            setTimeout(() => {
                btn.innerText = originalText;
                btn.style.background = originalColor;
            }, 2000);
            return;
        }
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É –º–æ–ª—á–∞ (–∏–ª–∏ –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –¥–≤–æ–π–Ω–æ–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ, –Ω–æ –æ–±—ã—á–Ω–æ —Ç—É—Ç –æ–Ω–æ –ª–∏—à–Ω–µ–µ)
        showLoader();
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –º–µ—Ç—É
        const now = new Date().getTime();
        Object.keys(syncMeta).forEach(k => syncMeta[k] = now);
        touchMeta('metro_settings');
        
        syncWithCloud();
        
        // –ü–∏—à–µ–º –Ω–∞ –∫–Ω–æ–ø–∫–µ "–ì–æ—Ç–æ–≤–æ"
        setTimeout(() => {
            hideLoader(); // –ù–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π, –µ—Å–ª–∏ —Å–∏–Ω–∫ –±—ã—Å—Ç—Ä—ã–π
            btn.innerText = "–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ ‚úÖ";
            btn.style.background = "#4caf50";
            setTimeout(() => {
                btn.innerText = originalText;
                btn.style.background = originalColor;
            }, 2000);
        }, 500);
    }

function saveAll() { 
    saveSettings(); 
    saveData(); 
    render(); 
}

    // 1. –ü—Ä–æ—Å—Ç–æ –æ—Ç–∫—Ä—ã–≤–∞–µ–º –Ω–∞—à–µ –Ω–æ–≤–æ–µ –∫—Ä–∞—Å–∏–≤–æ–µ –æ–∫–Ω–æ
    function deleteCurrentShift() {
        document.body.classList.add('modal-open');
        document.getElementById('confirmModal').classList.add('open');
    }

    // 2. –ê —ç—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç, –∫–æ–≥–¥–∞ –Ω–∞–∂–∞–ª–∏ "–î–∞, —É–¥–∞–ª–∏—Ç—å"
    function commitDelete() {
        const d = document.getElementById('inpDate').value; 
        
        // –£–¥–∞–ª—è–µ–º –∏–∑ –º–∞—Å—Å–∏–≤–∞
        shifts = shifts.filter(s => s.date !== d);
        
        // –ü–æ–º–µ—á–∞–µ–º –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
        touchMeta(getMonthKey(d));

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º
        localStorage.setItem('metro_shifts', JSON.stringify(shifts));
        saveAllToCloud();

        // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
        render();
        renderCalendar();
        
        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –û–ë–ê –æ–∫–Ω–∞ (–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ, –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–º–µ–Ω—ã)
        closeModal('confirmModal');
        closeModal('addModal');
        
        // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —É–¥–∞–ª–µ–Ω–∏—è –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π
        document.getElementById('btnDeleteShift').style.display = 'none';
    }

    function showLoader() { document.getElementById('loader').classList.add('loader-active'); }
    function hideLoader() { document.getElementById('loader').classList.remove('loader-active'); }

    function normalizeOne(s) { 
        if (s.d) { 
            // –≠—Ç–æ —Å–∂–∞—Ç—ã–π —Ñ–æ—Ä–º–∞—Ç (–∏–∑ –æ–±–ª–∞–∫–∞ –∏–ª–∏ –ø–∞–º—è—Ç–∏)
            let obj = { 
                date: s.d, text: s.t, note: s.n, 
                customRate: s.cr, customMentor: s.cm, customSenior: s.cs, 
                customClass: s.cc, customSen: s.ce, customPrem: s.cp, 
                lineStart: s.ls, lineEnd: s.le, isTech: !!s.it, isPostTrip: !!s.ip,
                
                // –ù–æ–≤—ã–µ –ø–æ–ª—è
                tpStart: s.tps, tpEnd: s.tpe, isFullMedical: !!s.ifm
            }; 
            
            // üî• –°–ü–ê–°–ï–ù–ò–ï –°–¢–ê–†–´–• –î–ê–ù–ù–´–•
            // –ï—Å–ª–∏ –µ—Å—Ç—å —Å—Ç–∞—Ä—ã–π —Ñ–ª–∞–≥ 'im' (—Å—Ç–∞—Ä—ã–π –º–µ–¥.–æ—Ç–≤–æ–¥), –ø—Ä–µ–≤—Ä–∞—â–∞–µ–º –µ–≥–æ –≤ –Ω–æ–≤—ã–π
            if (s.im) obj.isFullMedical = true;
            
            return obj;
        } 
        
        // –≠—Ç–æ –æ–±—ã—á–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç
        // –ï—Å–ª–∏ –≤—Å—Ç—Ä–µ—Ç–∏–ª–∏ —Å—Ç–∞—Ä—ã–π isMedical ‚Äî –æ–±–Ω–æ–≤–ª—è–µ–º –µ–≥–æ –Ω–∞ –Ω–æ–≤—ã–π –ª–∞–¥
        if (s.isMedical) {
            s.isFullMedical = true;
            delete s.isMedical; // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä–æ–µ, —á—Ç–æ–±—ã –Ω–µ –º—É—Å–æ—Ä–∏—Ç—å
        }

        return s; 
    }
    function normalizeShifts() { shifts = shifts.map(s => normalizeOne(s)); }

    function updateUI() {
        document.getElementById('set_rate').value = String(settings.rate).replace('.',',');
        document.getElementById('set_class').value = settings.classP;
        document.getElementById('set_prem').value = String(settings.premP).replace('.',',');
        document.getElementById('set_mentor').checked = settings.mentor;
        document.getElementById('set_senior').checked = settings.senior || false;
        document.getElementById('set_start_date').value = settings.startDate || "";
        document.getElementById('set_union').checked = settings.union !== false;
        calcExpDisplay();
    }

    function scrollToToday() { 
        setTimeout(() => { 
            const todayEl = document.querySelector('.shift-card.today'); 
            // –ë—ã–ª–æ: behavior: 'smooth' (–ø–ª–∞–≤–Ω–æ/–¥–æ–ª–≥–æ)
            // –°—Ç–∞–ª–æ: behavior: 'auto' (–º–≥–Ω–æ–≤–µ–Ω–Ω–æ)
            if (todayEl) todayEl.scrollIntoView({ block: 'center', behavior: 'auto' }); 
        }, 100); // –ú–æ–∂–Ω–æ –¥–∞–∂–µ —É–º–µ–Ω—å—à–∏—Ç—å —Ç–∞–π–º–µ—Ä —Å 200 –¥–æ 100, —á—Ç–æ–±—ã —Å—Ä–∞–±–∞—Ç—ã–≤–∞–ª–æ –±—ã—Å—Ç—Ä–µ–µ
    }
    
    function switchTab(tabName) { 
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active')); 
        document.getElementById('tab-' + tabName).classList.add('active'); 
        const tabs = ['today', 'home', 'stats', 'settings'];
        const targetIdx = tabs.indexOf(tabName);
        document.querySelectorAll('.nav-item').forEach((el, idx) => {
            if(idx === targetIdx) el.classList.add('active');
            else el.classList.remove('active');
        });
        if(tabName==='home') { scrollToToday(); } 
        const titles = { 'today':'–°–µ–≥–æ–¥–Ω—è', 'home': '–ú–æ–∏ —Å–º–µ–Ω—ã', 'stats': '–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞', 'settings': '–ü—Ä–æ—Ñ–∏–ª—å' }; 
        document.getElementById('headerTitle').innerText = titles[tabName]; 
        document.querySelector('header .header-btn').style.display = (tabName === 'home') ? 'flex' : 'none'; 
        if(tabName==='today') updateTodayTab(); 
        if(tabName==='stats') renderStats(); 
    }

    function updateTodayTab() {
        if(!document.getElementById('tab-today').classList.contains('active')) return;
        const now = new Date(); const nowTs = now.getTime();
        let currentShift = null, nextShift = null, prevShiftEnd = 0;
        const sorted = [...shifts].sort((a,b) => new Date(a.date) - new Date(b.date));
        for (let i = 0; i < sorted.length; i++) {
            const s = sorted[i]; let times = [...s.text.matchAll(/(\d{1,2}[:\.]\d{2})/g)]; if (times.length < 2) continue;
            const baseDate = new Date(s.date); const [sh, sm] = times[0][0].replace('.',':').split(':').map(Number); const [eh, em] = times[1][0].replace('.',':').split(':').map(Number);
            const startDate = new Date(baseDate); startDate.setHours(sh, sm, 0, 0); const endDate = new Date(baseDate); if (eh < sh) endDate.setDate(endDate.getDate() + 1); endDate.setHours(eh, em, 0, 0);
            if (nowTs >= startDate.getTime() && nowTs < endDate.getTime()) { currentShift = { data: s, start: startDate, end: endDate }; }
            if (!currentShift && !nextShift && startDate.getTime() > nowTs) { nextShift = { data: s, start: startDate }; }
            if (endDate.getTime() < nowTs) { prevShiftEnd = endDate.getTime(); }
        }
        const container = document.getElementById('todayContent'); let html = '';
        if (currentShift) {
            const totalMs = currentShift.end - currentShift.start; const elapsedMs = now - currentShift.start; const percent = Math.min(100, (elapsedMs / totalMs) * 100);
            const res = calcShift(currentShift.data); let unionFee = settings.union ? (res.dirty * 0.01) : 0; let tax = res.dirty * 0.13; let netTotal = res.dirty - tax - unionFee; const currentEarned = (elapsedMs / totalMs) * netTotal;
            html = `<div class="hero-widget theme-work"><div class="widget-header"><div class="widget-title">–°–ï–ô–ß–ê–° –ù–ê –°–ú–ï–ù–ï</div><div class="widget-icon">üöÖ</div></div><div class="widget-main-value">${Math.floor(currentEarned)} ‚ÇΩ</div><div class="widget-sub-value">–∏–∑ ${Math.round(netTotal)} ‚ÇΩ</div><div class="progress-track"><div class="progress-fill" style="width: ${percent}%"></div></div><div class="progress-labels"><span>${currentShift.start.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</span><span>–ö–æ–Ω–µ—Ü: ${currentShift.end.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</span></div></div><div class="info-grid"><div class="info-card"><div class="info-label">–ú–∞—Ä—à—Ä—É—Ç</div><div class="info-val">${currentShift.data.text.split(' ')[0]}</div></div><div class="info-card"><div class="info-label">–û—Å—Ç–∞–ª–æ—Å—å</div><div class="info-val">${msToTime(currentShift.end - now)}</div></div></div>`;
        } else {
            let restText = "–ù/–î", percentRest = 0, label = "–û–¢–î–´–•", fullRestDesc = "";
            if (prevShiftEnd > 0) {
                if (nextShift) { label = "–ú–ï–ñ–°–ú–ï–ù–ù–´–ô –û–¢–î–´–•"; const totalRestMs = nextShift.start.getTime() - prevShiftEnd; const passedRestMs = nowTs - prevShiftEnd; percentRest = Math.min(100, (passedRestMs / totalRestMs) * 100); restText = msToTime(totalRestMs); const prevEndDate = new Date(prevShiftEnd); const prevEndStr = prevEndDate.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}) + ` (${prevEndDate.getDate()}.${prevEndDate.getMonth()+1})`; const nextStartStr = nextShift.start.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}) + ` (${nextShift.start.getDate()}.${nextShift.start.getMonth()+1})`; fullRestDesc = `<div class="widget-sub-value" style="font-size:13px; margin-top:10px;">–° ${prevEndStr}</div><div class="widget-sub-value" style="font-size:13px;">–î–æ ${nextStartStr}</div><div style="margin-top:20px; font-size:12px; opacity:0.8">–£–∂–µ –ø—Ä–æ—à–ª–æ: ${msToTime(passedRestMs)}</div>`; } 
                else { const passed = nowTs - prevShiftEnd; restText = msToTime(passed); fullRestDesc = `<div class="widget-sub-value">–ø—Ä–æ—à–ª–æ —Å –ø—Ä–æ—à–ª–æ–π —Å–º–µ–Ω—ã</div>`; }
            }
            html = `<div class="hero-widget theme-rest"><div class="widget-header"><div class="widget-title">${label}</div><div class="widget-icon">üõãÔ∏è</div></div><div class="widget-main-value">${restText}</div>${fullRestDesc}${nextShift ? `<div class="progress-track"><div class="progress-fill" style="width: ${percentRest}%"></div></div>` : ''}</div>`;
            if (nextShift) { const timeToStart = nextShift.start - now; html += `<div class="info-grid"><div class="info-card"><div class="info-label">–°–ª–µ–¥—É—é—â–∞—è</div><div class="info-val">${nextShift.start.getDate()}.${nextShift.start.getMonth()+1}</div></div><div class="info-card"><div class="info-label">–î–æ —Å–º–µ–Ω—ã</div><div class="info-val" style="color:var(--accent)">${msToTime(timeToStart)}</div></div></div>`; }
        }
        container.innerHTML = html;
    }
    function msToTime(duration) { let minutes = Math.floor((duration / (1000 * 60)) % 60); let hours = Math.floor((duration / (1000 * 60 * 60))); return hours + "—á " + minutes + "–º"; }
    
    function getSeniorityPercent(d) { 
        if(!d) return 0; 
        const s = new Date(d); 
        if (isNaN(s.getTime())) return 0;
        const n = new Date(); 
        if (s > n) return 0; 
        
        const y = (n - s) / (1000 * 60 * 60 * 24 * 365.25); 

        if (y >= 20) return 30; 
        if (y >= 15) return 25; 
        if (y >= 10) return 20; 
        if (y >= 5) return 15; 
        if (y >= 3) return 10; 
        
        // –†–ê–ù–¨–®–ï: if (y >= 1) return 5; else return 0;
        
        // –¢–ï–ü–ï–†–¨: –í—Å–µ–º –Ω–æ–≤–∏—á–∫–∞–º (–æ—Ç 0 –¥–æ 3 –ª–µ—Ç) —Å—Ä–∞–∑—É –¥–∞–µ–º 5%
        return 5; 
    }

    function calcExpDisplay() { 
        const d = document.getElementById('set_start_date').value; 
        const t = document.getElementById('set_exp_text'); 
        
        if(!d) { t.innerText = "–°—Ç–∞–∂ –Ω–µ —É–∫–∞–∑–∞–Ω"; return; } 
        
        const s = new Date(d); 
        if(isNaN(s.getTime())) { t.innerText = "–û—à–∏–±–∫–∞ –¥–∞—Ç—ã"; return; }
        
        const n = new Date(); 
        // –°—á–∏—Ç–∞–µ–º —Ç–æ—á–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ª–µ—Ç (—Å –¥—Ä–æ–±–Ω–æ–π —á–∞—Å—Ç—å—é –¥–ª—è —Ç–æ—á–Ω–æ—Å—Ç–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏)
        const yearsFloat = (n - s) / (1000 * 60 * 60 * 24 * 365.25);
        const yFull = Math.floor(yearsFloat); 
        
        const p = getSeniorityPercent(d); 
        
        // –ï—Å–ª–∏ —Å—Ç–∞–∂ –º–µ–Ω—å—à–µ 1 –≥–æ–¥–∞, –Ω–æ –ø—Ä–æ—Ü–µ–Ω—Ç —É–∂–µ 5 ‚Äî –∑–Ω–∞—á–∏—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∞
        if (yearsFloat < 1 && p === 5) {
            t.innerHTML = `–°—Ç–∞–∂: < 1 –≥–æ–¥–∞ <span style="color:#2e7d32; font-weight:800;">(–ü–æ–¥–¥–µ—Ä–∂–∫–∞ 5% üî•)</span>`;
        } else {
            t.innerText = `–°—Ç–∞–∂: ~${yFull} –ª–µ—Ç (–í—ã—Å–ª—É–≥–∞ ${p}%)`; 
        }
    }

    
// === 1. –†–ê–°–ß–ï–¢ –°–†–ï–î–ù–ï–ì–û –î–ù–ï–í–ù–û–ì–û (–ß–ï–°–¢–ù–´–ô, –ü–û –§–ê–ö–¢–£ –û–¢–†–ê–ë–û–¢–ê–ù–ù–û–ì–û) ===
    function calculateAverageDaily(targetDateStr) {
    const targetDate = new Date(targetDateStr);
    
    // 1. –û–ø—Ä–µ–¥–µ–ª—è–µ–º –≥—Ä–∞–Ω–∏—Ü—ã (–º–∞–∫—Å–∏–º—É–º 12 –º–µ—Å—è—Ü–µ–≤ –Ω–∞–∑–∞–¥)
    let minDateLimit = new Date(targetDate);
    minDateLimit.setFullYear(minDateLimit.getFullYear() - 1);
    minDateLimit.setDate(1); // –ü–µ—Ä–≤–æ–µ —á–∏—Å–ª–æ –º–µ—Å—è—Ü–∞ –≥–æ–¥ –Ω–∞–∑–∞–¥

    // 2. –ò—â–µ–º —Å–∞–º—É—é —Ä–∞–Ω–Ω—é—é –í–ê–õ–ò–î–ù–£–Æ —Å–º–µ–Ω—É (–Ω–µ –ë–õ/–û—Ç–ø—É—Å–∫), —á—Ç–æ–±—ã –ø–æ–Ω—è—Ç—å —Å—Ç–∞—Ä—Ç –æ—Ç—Å—á–µ—Ç–∞
    let validShifts = shifts.filter(s => {
        const txt = s.text.toLowerCase();
        return !txt.includes('–±–ª') && !txt.includes('–±–æ–ª—å–Ω–∏—á–Ω—ã–π') && 
               !txt.includes('–æ—Ç–ø—É—Å–∫') && !txt.includes('–æ—Ç–ø') && !txt.includes('–¥–æ–Ω–æ—Ä');
    });

    if (validShifts.length === 0) return 0; // –°–æ–≤—Å–µ–º –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö

    // –ù–∞—Ö–æ–¥–∏–º –¥–∞—Ç—É –ø–µ—Ä–≤–æ–π —Å–º–µ–Ω—ã
    let earliestDate = validShifts.reduce((min, s) => {
        const d = new Date(s.date);
        return d < min ? d : min;
    }, new Date(targetDate));

    // –ï—Å–ª–∏ –ø–µ—Ä–≤–∞—è —Å–º–µ–Ω–∞ –±—ã–ª–∞ —Ä–∞–Ω—å—à–µ —á–µ–º –≥–æ–¥ –Ω–∞–∑–∞–¥, –æ–±—Ä–µ–∑–∞–µ–º –≥–æ–¥–æ–º.
    let startDate = (earliestDate < minDateLimit) ? minDateLimit : new Date(earliestDate);
    startDate.setDate(1); // –°—á–∏—Ç–∞–µ–º –≤—Å–µ–≥–¥–∞ —Å 1 —á–∏—Å–ª–∞ –º–µ—Å—è—Ü–∞ –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã

    let totalMoney = 0;
    let totalDaysCoef = 0; 
    
    // –ö—É—Ä—Å–æ—Ä –±–µ–∂–∏—Ç –ø–æ –º–µ—Å—è—Ü–∞–º –æ—Ç —Å—Ç–∞—Ä—Ç–∞ –¥–æ –¥–∞—Ç—ã –æ—Ç–ø—É—Å–∫–∞
    let cursor = new Date(startDate);
    
    while (cursor < targetDate) {
        // –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ–±—ã –Ω–µ –≤—ã–π—Ç–∏ –∑–∞ —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü –æ—Ç–ø—É—Å–∫–∞
        if (cursor.getFullYear() === targetDate.getFullYear() && cursor.getMonth() === targetDate.getMonth()) break;
        
        const y = cursor.getFullYear();
        const m = cursor.getMonth();
        const daysInMonth = new Date(y, m + 1, 0).getDate(); // –°–∫–æ–ª—å–∫–æ –¥–Ω–µ–π –≤ —ç—Ç–æ–º –º–µ—Å—è—Ü–µ (30, 31, 28)

        // –°–æ–±–∏—Ä–∞–µ–º —Å–º–µ–Ω—ã –∑–∞ —ç—Ç–æ—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –º–µ—Å—è—Ü
        const monthShifts = shifts.filter(s => {
            const d = new Date(s.date);
            return d.getFullYear() === y && d.getMonth() === m;
        });

        let excludedDays = 0;
        let monthMoney = 0;

        // 1. –°—á–∏—Ç–∞–µ–º –¥–µ–Ω—å–≥–∏ (—Ç–æ–ª—å–∫–æ —Å —Ä–∞–±–æ—á–∏—Ö —Å–º–µ–Ω) –∏ –∏—Å–∫–ª—é—á–∞–µ–º—ã–µ –¥–Ω–∏
        monthShifts.forEach(s => {
            const txt = s.text.toLowerCase();
            // –ï—Å–ª–∏ —ç—Ç–æ —Ä–∞–±–æ—á–∏–π –¥–µ–Ω—å (–Ω–µ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ)
            if (!txt.includes('–±–ª') && !txt.includes('–±–æ–ª—å–Ω–∏—á–Ω—ã–π') && 
                !txt.includes('–æ—Ç–ø—É—Å–∫') && !txt.includes('–¥–æ–Ω–æ—Ä')) {
                
                let res = calcShift(s, true); // true = —Ä–µ–∂–∏–º —Ä–∞—Å—á–µ—Ç–∞ —Å—Ä–µ–¥–Ω–µ–≥–æ
                if (res && res.dirty > 0) {
                    monthMoney += res.dirty;
                }
            }
            // –ï—Å–ª–∏ —ç—Ç–æ –∏—Å–∫–ª—é—á–∞–µ–º—ã–π –¥–µ–Ω—å - –∑–∞–ø–æ–º–∏–Ω–∞–µ–º –¥–ª—è –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–∞
            if (txt.includes('–±–ª') || txt.includes('–±–æ–ª—å–Ω–∏—á–Ω—ã–π') || 
                txt.includes('–æ—Ç–ø—É—Å–∫') || txt.includes('–æ—Ç–ø') || txt.includes('–¥–æ–Ω–æ—Ä')) {
                excludedDays++;
            }
        });

        // 2. –°—á–∏—Ç–∞–µ–º –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –¥–Ω–µ–π (29.3)
        if (excludedDays === 0 && monthMoney > 0) {
            // –ü–æ–ª–Ω—ã–π –º–µ—Å—è—Ü
            totalDaysCoef += 29.3;
        } else {
            // –ù–µ–ø–æ–ª–Ω—ã–π –º–µ—Å—è—Ü
            const workedDays = daysInMonth - excludedDays;
            if (workedDays > 0) {
                totalDaysCoef += (29.3 / daysInMonth) * workedDays;
            }
        }

        totalMoney += monthMoney;
        cursor.setMonth(cursor.getMonth() + 1); // –°–ª–µ–¥—É—é—â–∏–π –º–µ—Å—è—Ü
    }

    if (totalDaysCoef === 0) return 0;
    return totalMoney / totalDaysCoef;
}

    // === 2. –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –†–ê–°–ß–ï–¢ –°–†–ï–î–ù–ï–ì–û –ß–ê–°–û–í–û–ì–û (–î–õ–Ø –î–û–ù–û–†–ê/–ö–û–ú–ê–ù–î–ò–†–û–í–ö–ò) ===
    // –î–µ–ª–∏–º –î–µ–Ω—å–≥–∏ –Ω–∞ –†–µ–∞–ª—å–Ω–æ –û—Ç—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ –ß–∞—Å—ã
    function calculateAverageHourly(targetDateStr) {
    const targetDate = new Date(targetDateStr);
    // –ë–µ—Ä–µ–º –ø–µ—Ä–∏–æ–¥ 12 –º–µ—Å—è—Ü–µ–≤ –Ω–∞–∑–∞–¥
    let minDate = new Date(targetDate);
    minDate.setFullYear(minDate.getFullYear() - 1);
    
    let totalMoney = 0;
    let totalHours = 0;

    shifts.forEach(s => {
        const sDate = new Date(s.date);
        // –ë–µ—Ä–µ–º —Å–º–µ–Ω—ã –∑–∞ –ø—Ä–æ—à–ª—ã–π –≥–æ–¥, –Ω–æ –î–û —Ç–µ–∫—É—â–µ–π –¥–∞—Ç—ã
        if (sDate < minDate || sDate >= targetDate) return;

        let txt = s.text.toLowerCase();
        
        // 1. –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –î–æ–±–∞–≤–∏–ª –ø—Ä–æ–≤–µ—Ä–∫—É –Ω–∞ "–æ—Ç–ø"
        if (txt.includes('–±–ª') || txt.includes('–±–æ–ª—å–Ω–∏—á–Ω—ã–π') || 
            txt.includes('–æ—Ç–ø—É—Å–∫') || txt.includes('–æ—Ç–ø') || txt.includes('–¥–æ–Ω–æ—Ä')) return;

        // –°—á–∏—Ç–∞–µ–º –¥–µ–Ω—å–≥–∏ –∏ –ß–ê–°–´ –∑–∞ —ç—Ç—É —Å–º–µ–Ω—É
        let res = calcShift(s, true); 
        
        // 2. –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ò—Å–ø–æ–ª—å–∑—É–µ–º res.duration –≤–º–µ—Å—Ç–æ res.hours
        // res.hours –º–æ–∂–µ—Ç –±—ã—Ç—å 0, –µ—Å–ª–∏ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞ –≤ –ø—Ä–∞–∑–¥–Ω–∏–∫ (1 –º–∞—è),
        // –Ω–æ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏ —á–∞—Å—ã –±—ã–ª–∏ –æ—Ç—Ä–∞–±–æ—Ç–∞–Ω—ã, –∏ –Ω–∞ –Ω–∏—Ö –Ω—É–∂–Ω–æ –¥–µ–ª–∏—Ç—å.
        if (res && res.dirty > 0 && res.duration > 0) {
            totalMoney += res.dirty;
            totalHours += res.duration; 
        }
    });

    if (totalHours === 0) return 0;
    return totalMoney / totalHours;
}
    
// === –§–£–ù–ö–¶–ò–Ø-–î–ò–°–ü–ï–¢–ß–ï–† ===
    function calcShift(shiftRaw, isAvgCalc = false) {
        if (!shiftRaw || !shiftRaw.text) return null;
        
        // 1. –ü–∞—Ä—Å–∏–º —á–µ—Ä–µ–∑ Logic
        let parsed = Logic.parseShift(shiftRaw.text, shiftRaw.date);
        
        // =========================================================
        // –ë–õ–û–ö 1: –°–†–ï–î–ù–ò–ô –ó–ê–†–ê–ë–û–¢–û–ö (–û—Ç–ø—É—Å–∫, –ë–æ–ª—å–Ω–∏—á–Ω—ã–π, –î–æ–Ω–æ—Ä)
        // =========================================================
        if (parsed.type === 'VACATION') {
            if (isAvgCalc) return null;
            let avgDaily = calculateAverageDaily(shiftRaw.date); 
            if (avgDaily === 0) avgDaily = (settings.rate || 546.18) * 8; 
            let unionFee = settings.union ? (avgDaily * 0.01) : 0;
            return { dirty: avgDaily, net: Math.round(avgDaily * 0.87 - unionFee), hours: 0, duration: 0, isRes: false, isNonWork: true, vacationMoney: avgDaily };
        }

        if (parsed.type === 'SICK') {
            if (isAvgCalc) return null;
            const d = new Date(shiftRaw.date);
            const y = d.getFullYear();
            const years = [y - 2, y - 1];
            const FSS_LIMITS = { 2023: 1917000, 2024: 2225000, 2025: 2753000 };
            const limit1 = FSS_LIMITS[years[0]] || 2225000;
            const limit2 = FSS_LIMITS[years[1]] || 2753000;
            let inc1 = (settings.sickData && settings.sickData[years[0]]) || 0;
            let inc2 = (settings.sickData && settings.sickData[years[1]]) || 0;
            inc1 = Math.min(inc1, limit1); inc2 = Math.min(inc2, limit2);
            const avgByIncome = (inc1 + inc2) / 730;
            const MROT = (y === 2024) ? 19242 : 22440;
            const avgByMrot = (MROT * 24) / 730;
            let averageDaily = Math.max(avgByIncome, avgByMrot);
            let percent = (settings.sickPercent || 100) / 100;
            let dailyDirty = averageDaily * percent;
            const daysInMonth = new Date(y, d.getMonth() + 1, 0).getDate();
            const minDayPayment = MROT / daysInMonth;
            if (dailyDirty < minDayPayment) dailyDirty = minDayPayment;
            return { dirty: dailyDirty, net: Math.round(dailyDirty * 0.87), hours: 0, duration: 0, isRes: false, isNonWork: true, sickMoney: dailyDirty };
        }

        if (parsed.type === 'DONOR') {
            if (isAvgCalc) return null;
            let payHours = 7.2; 
            let avgHourly = calculateAverageHourly(shiftRaw.date);
            let totalDirty = (avgHourly > 0) ? (avgHourly * payHours) : ((settings.rate || 0) * payHours * 1.35);
            let unionFee = settings.union ? (totalDirty * 0.01) : 0;
            return { dirty: totalDirty, net: Math.round(totalDirty * 0.87 - unionFee), hours: 0, duration: 0, isRes: false, isNonWork: true, donorMoney: totalDirty };
        }

        // =========================================================
        // –ë–õ–û–ö 2: –°–ü–ï–¶. –†–ê–ë–û–¢–ê
        // =========================================================
        if (parsed.type === 'TRAINING' || parsed.type === 'MED_CHECK') {
            if (parsed.paidDuration === 0) {
                parsed.paidDuration = (parsed.type === 'MED_CHECK') ? (6.0 * 60) : (7.2 * 60);
            }
        }

        // =========================================================
        // –ë–õ–û–ö 3: –û–ë–´–ß–ù–ê–Ø –†–ê–ë–û–¢–ê –ò –†–ï–ó–ï–†–í
        // =========================================================
        if (isAvgCalc && parsed.type !== 'WORK' && parsed.type !== 'RESERVE' && parsed.type !== 'TRAINING' && parsed.type !== 'MED_CHECK') return null;

        const allSorted = [...shifts].sort((a,b) => new Date(a.date) - new Date(b.date));
        const idx = allSorted.findIndex(s => s.date === shiftRaw.date);
        
        if (idx !== -1) {
            let miniBatchRaw = [];
            if (idx > 0) miniBatchRaw.push(allSorted[idx - 1]);
            miniBatchRaw.push(allSorted[idx]);
            if (idx < allSorted.length - 1) miniBatchRaw.push(allSorted[idx + 1]);
            
            let miniBatchParsed = miniBatchRaw.map(s => Logic.parseShift(s.text, s.date));
            Logic.processShiftSequence(miniBatchParsed);
            
            const updatedCurr = miniBatchParsed.find(s => s.date === shiftRaw.date);
            if (updatedCurr) parsed = updatedCurr;
        }

        let effectiveSettings = JSON.parse(JSON.stringify(settings));
        if (shiftRaw.customRate !== undefined) effectiveSettings.rate = shiftRaw.customRate;
        if (shiftRaw.customClass !== undefined) effectiveSettings.classP = shiftRaw.customClass;
        if (shiftRaw.customPrem !== undefined) effectiveSettings.premP = shiftRaw.customPrem;
        
        parsed.isTech = (shiftRaw.isTech === true);
        parsed.isPostTrip = (shiftRaw.isPostTrip === true);
        parsed.isFullMedical = (shiftRaw.isFullMedical === true);
        
        // === –í–ê–ñ–ù–û–ï –î–û–ë–ê–í–õ–ï–ù–ò–ï: –ü–µ—Ä–µ–¥–∞–µ–º –≤—Ä–µ–º—è –≤—ã–µ–∑–¥–∞ ===
        parsed.lineStart = shiftRaw.lineStart;
        parsed.lineEnd = shiftRaw.lineEnd;
        // ===============================================
        
        if (shiftRaw.customMentor !== undefined) effectiveSettings.mentor = shiftRaw.customMentor;
        if (shiftRaw.customSenior !== undefined) effectiveSettings.senior = shiftRaw.customSenior;

        return Calculator.calculateShift(parsed, effectiveSettings);
    }

    // –¢–∞–π–º–µ—Ä –∞–Ω–∏–º–∞—Ü–∏–∏
    let animTimer = null;

    function drawProgress(percent, labelValue) { 
        const circle = document.getElementById('circlePath'); 
        const circleOver = document.getElementById('circlePathOver'); 
        const textVal = document.getElementById('chartValue'); 
        
        // 1. –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ç–∞–π–º–µ—Ä (–µ—Å–ª–∏ –±—ã—Å—Ç—Ä–æ —â–µ–ª–∫–∞–ª–∏)
        if (animTimer) clearTimeout(animTimer);

        let mainPercent = percent;
        let overPercent = 0;

        // –†–∞—Å—á–µ—Ç –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤
        if (mainPercent > 100) {
            overPercent = mainPercent - 100; 
            mainPercent = 100; 
            if (overPercent > 100) overPercent = 100; 
        } else {
            if (mainPercent < 0) mainPercent = 0;
        }

        // 2. –†–∏—Å—É–µ–º –û–†–ê–ù–ñ–ï–í–´–ô –∫—Ä—É–≥ (—Å—Ä–∞–∑—É)
        circle.style.transition = 'stroke-dasharray 0.6s ease';
        circle.style.strokeDasharray = `${mainPercent}, 100`; 

        // 3. –†–∏—Å—É–µ–º –ó–ï–õ–ï–ù–´–ô –∫—Ä—É–≥ (—Å –∑–∞–¥–µ—Ä–∂–∫–æ–π)
        if (circleOver) {
            
            // –°–ù–ê–ß–ê–õ–ê: –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ –ø—Ä—è—á–µ–º –∏ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –∑–µ–ª–µ–Ω—ã–π
            circleOver.style.transition = 'none'; // –û—Ç–∫–ª—é—á–∞–µ–º –ø–ª–∞–≤–Ω–æ—Å—Ç—å –¥–ª—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–≥–æ —Å–±—Ä–æ—Å–∞
            circleOver.style.strokeDasharray = `0, 100`;
            circleOver.style.opacity = '0';
            
            if (overPercent > 0) {
                circleOver.style.display = 'block'; 
                
                // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä —Ä–æ–≤–Ω–æ –Ω–∞ –≤—Ä–µ–º—è –∞–Ω–∏–º–∞—Ü–∏–∏ –æ—Ä–∞–Ω–∂–µ–≤–æ–≥–æ (600–º—Å)
                animTimer = setTimeout(() => {
                    // 1. –í–∫–ª—é—á–∞–µ–º –ø–ª–∞–≤–Ω–æ—Å—Ç—å –æ–±—Ä–∞—Ç–Ω–æ
                    circleOver.style.transition = 'stroke-dasharray 0.6s ease, opacity 0.1s ease';
                    
                    // 2. –í–∞–∂–Ω—ã–π —Ö–∞–∫: –∑–∞—Å—Ç–∞–≤–ª—è–µ–º –±—Ä–∞—É–∑–µ—Ä "–æ—Å–æ–∑–Ω–∞—Ç—å" –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º
                    circleOver.getBoundingClientRect(); 

                    // 3. –ó–∞–¥–∞–µ–º –∫–æ–Ω–µ—á–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è (–ø–æ—è–≤–ª—è–µ—Ç—Å—è –∏ —Ä–∞—Å—Ç–µ—Ç)
                    circleOver.style.opacity = '1'; 
                    circleOver.style.strokeDasharray = `${overPercent}, 100`;
                }, 600); 
            } else {
                // –ï—Å–ª–∏ –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∏ –Ω–µ—Ç - —Å–∫—Ä—ã–≤–∞–µ–º –Ω–∞—Å–æ–≤—Å–µ–º
                circleOver.style.display = 'none';
            }
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Ü–∏—Ñ—Ä—É –≤ —Ü–µ–Ω—Ç—Ä–µ
        if (textVal) textVal.innerText = labelValue.toFixed(1); 
    }

    function changeStatsMonth(dir) { statsDate.setMonth(statsDate.getMonth() + dir); renderStats(); }

    function renderStats() {
        Logic.calculateRestIntervals(shifts); // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Ä–∞–∑—Ä—ã–≤—ã
        
        const year = statsDate.getFullYear(); 
        const month = statsDate.getMonth();
        const monthNames = ["–Ø–Ω–≤–∞—Ä—å", "–§–µ–≤—Ä–∞–ª—å", "–ú–∞—Ä—Ç", "–ê–ø—Ä–µ–ª—å", "–ú–∞–π", "–ò—é–Ω—å", "–ò—é–ª—å", "–ê–≤–≥—É—Å—Ç", "–°–µ–Ω—Ç—è–±—Ä—å", "–û–∫—Ç—è–±—Ä—å", "–ù–æ—è–±—Ä—å", "–î–µ–∫–∞–±—Ä—å"];
        document.getElementById('statsMonthDisplay').innerText = `${monthNames[month]} ${year}`;
        
        const monthlyShifts = shifts.filter(s => { 
            const d = new Date(s.date); 
            return d.getFullYear() === year && d.getMonth() === month; 
        });
        
        // –ê–∫–∫—É–º—É–ª—è—Ç–æ—Ä—ã –¥–ª—è —Å–≤–æ–¥–∫–∏
        let total = {
            hours: 0, // –§–∞–∫—Ç
            dirty: 0, // –ì—Ä—è–∑–Ω—ã–º–∏
            
            // –ì—Ä—É–ø–ø—ã –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
            tLine: 0, tRes: 0, tBase: 0, // –¢–∞—Ä–∏—Ñ—ã
            sLine: 0, sRes: 0, sBase: 0, // –†–∞–∑—Ä—ã–≤
            nLine: 0, nRes: 0, nBase: 0, // –ù–æ—á—å
            eLine: 0, eRes: 0, eBase: 0, // –í–µ—á–µ—Ä
            
            class: 0, senior: 0, mentor: 0, tech: 0,
            sick: 0, vacation: 0, donor: 0, med: 0, study: 0,
            
            sickDays: 0
        };

        // 1. –ü—Ä–æ–±–µ–≥–∞–µ–º –ø–æ —Å–º–µ–Ω–∞–º –∏ —Å—É–º–º–∏—Ä—É–µ–º parts
        monthlyShifts.forEach(s => {
            let res = Calculator.calculateShift(s, settings);
            if (!res) return;

            // –ï—Å–ª–∏ —ç—Ç–æ —Å–ø–µ—Ü. —Ç–∏–ø—ã, –æ–Ω–∏ –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç —Ç–æ–ª—å–∫–æ —Ñ–ª–∞–≥–∏ –∏ —Å—É–º–º—ã
            if (res.isSick) { total.sickDays++; total.sick += 0; return; } // –î–µ–Ω—å–≥–∏ –ë–õ —Å—á–∏—Ç–∞—é—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ
            if (res.isVacation) { total.vacation += 0; return; }
            if (res.isDonor) { total.donor += 0; return; }

            // –°—É–º–º–∏—Ä—É–µ–º —á–∞—Å—ã —Ñ–∞–∫—Ç–∞
            total.hours += res.hours;

            // –°—É–º–º–∏—Ä—É–µ–º –¥–µ–Ω—å–≥–∏ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
            total.tLine += res.parts.tariffLine.m;
            total.tRes  += res.parts.tariffRes.m;
            total.tBase += res.parts.tariffBase.m;

            total.sLine += res.parts.splitLine.m;
            total.sRes  += res.parts.splitRes.m;
            total.sBase += res.parts.splitBase.m;

            total.nLine += res.parts.nightLine.m;
            total.nRes  += res.parts.nightRes.m;
            total.nBase += res.parts.nightBase.m;

            total.eLine += res.parts.evLine.m;
            total.eRes  += res.parts.evRes.m;
            total.eBase += res.parts.evBase.m;

            total.class  += res.parts.class;
            total.senior += res.parts.senior;
            total.mentor += res.parts.mentor;
            total.tech   += res.parts.tech;
            total.med    += res.parts.med;
            total.study  += res.parts.study;
        });

        // 2. –†–∞—Å—á–µ—Ç –Ω–æ—Ä–º—ã –∏ –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∏
        let norm = getMonthNorm(year, month);
        // –í—ã—á–µ—Ç –Ω–æ—Ä–º—ã –∑–∞ –±–æ–ª—å–Ω–∏—á–Ω—ã–µ/–æ—Ç–ø—É—Å–∫–∞ (—É–ø—Ä–æ—â–µ–Ω–Ω–æ - 7.2 –∑–∞ –±—É–¥–Ω–∏–π –¥–µ–Ω—å)
        // –¢—É—Ç –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –≤—ã—á–µ—Ç–∞, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ.
        
        const overtime = Math.max(0, total.hours - norm);
        drawProgress((total.hours / norm) * 100, total.hours); // –ö—Ä—É–≥ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞

        // 3. –†–∞—Å—á–µ—Ç –ü–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∏ (–ó–æ–ª–æ—Ç–æ–µ –ø—Ä–∞–≤–∏–ª–æ)
        const otPay = Calculator.calculateOvertimePay(overtime, settings);
        // otPay.money15 –∏ money20 - —ç—Ç–æ –î–û–ü–õ–ê–¢–´. –û—Å–Ω–æ–≤–∞ (1.0) —É–∂–µ —Å–∏–¥–∏—Ç –≤ –¢–∞—Ä–∏—Ñ–µ (tLine/tRes).
        
        // 4. –†–∞—Å—á–µ—Ç –ü–†–ï–ú–ò–ò (35%)
        // –ë–∞–∑–∞: –¢–∞—Ä–∏—Ñ—ã + –†–∞–∑—Ä—ã–≤ + –ù–æ—á—å/–í–µ—á–µ—Ä + –ö–ª–∞—Å—Å + –ë—Ä–∏–≥–∞–¥–∏—Ä
        // –ò–°–ö–õ–Æ–ß–ï–ù–û: –ù–∞—Å—Ç–∞–≤–Ω–∏–∫, –í—ã—Å–ª—É–≥–∞, –ü–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∞(–¥–æ–ø–ª–∞—Ç–∞), –ü—Ä–∞–∑–¥–Ω–∏—á–Ω—ã–µ(–¥–æ–ø–ª–∞—Ç–∞)
        const bonusBase = 
            total.tLine + total.tRes + total.tBase +
            total.sLine + total.sRes + total.sBase +
            total.nLine + total.nRes + total.nBase +
            total.eLine + total.eRes + total.eBase +
            total.class + total.senior;
            
        const premP = parseFloat(settings.premP) || 0;
        const premMoney = bonusBase * (premP / 100);

        // 5. –ò–¢–û–ì –ì–†–Ø–ó–ù–´–ú–ò
        // –°–∫–ª–∞–¥—ã–≤–∞–µ–º –≤–æ–æ–±—â–µ –≤—Å—ë
        total.dirty = 
            bonusBase + premMoney + // –ó–µ–ª–µ–Ω–∞—è –∑–æ–Ω–∞ + —Å–∞–º–∞ –ø—Ä–µ–º–∏—è
            total.mentor + // –ö—Ä–∞—Å–Ω–∞—è –∑–æ–Ω–∞
            otPay.total +  // –î–æ–ø–ª–∞—Ç–∞ –∑–∞ –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫—É
            total.tech + total.med + total.study + total.sick + total.vacation + total.donor;

        // –ù–∞–ª–æ–≥ –∏ –ü—Ä–æ—Ñ—Å–æ—é–∑
        const union = settings.union ? (total.dirty * 0.01) : 0;
        const tax = total.dirty * 0.13;
        const net = total.dirty - union - tax;

        // --- –û–¢–†–ò–°–û–í–ö–ê (RENDER) ---
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–∫—Ä—ã—Ç–∏—è –ø—É—Å—Ç—ã—Ö —Å—Ç—Ä–æ–∫
        const row = (id, val, labelOverride) => {
            const el = document.getElementById(id);
            if (!el) return;
            if (val > 1) {
                el.style.display = 'flex';
                el.querySelector('.stat-val').innerText = fmtMoney(val);
                if (labelOverride) el.querySelector('span:first-child').innerText = labelOverride;
            } else {
                el.style.display = 'none';
            }
        };

        // –û–±–Ω–æ–≤–ª—è–µ–º —à–∞–ø–∫—É —á–∞—Å–æ–≤
        document.getElementById('st_norm').innerText = norm + ' —á';
        document.getElementById('st_hours').innerText = total.hours.toFixed(1) + ' —á';
        document.getElementById('st_over').innerText = overtime > 0 ? `+${overtime.toFixed(1)}` : '0';

        // 1. –¢–ê–†–ò–§–´ (0030, 0031, 0038)
        row('row_tariff', total.tLine, '0030 –¢–∞—Ä–∏—Ñ (–õ–∏–Ω–∏—è):');
        row('row_res', total.tRes, '0031 –¢–∞—Ä–∏—Ñ (–†–µ–∑–µ—Ä–≤):');
        // –î–ª—è –±–∞–∑—ã/–æ—Ç—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å row_study –∏–ª–∏ —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π div –≤ html
        // –ü–æ–∫–∞ –∑–∞–ø–∏—Ö–Ω–µ–º –≤ "–ú–µ–¥.–∫–æ–º" –∏–ª–∏ –¥–æ–±–∞–≤–∏–º –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏, –µ—Å–ª–∏ –≤ html –Ω–µ—Ç —Å–ª–æ—Ç–∞
        
        // 2. –†–ê–ó–†–´–í (0050, 0051)
        // –í HTML —É –Ω–∞—Å –æ–¥–Ω–∞ —Å—Ç—Ä–æ–∫–∞ row_split. –°–ª–æ–∂–∏–º —Ç—É–¥–∞ –≤—Å—ë.
        const splitSum = total.sLine + total.sRes + total.sBase;
        row('row_split', splitSum, '0050 –î–æ–ø–ª–∞—Ç–∞ –∑–∞ —Ä–∞–∑—Ä—ã–≤:');

        // 3. –ü–†–ï–ú–ò–Ø (0090) - –ü–æ–¥–Ω–∏–º–∞–µ–º –Ω–∞–≤–µ—Ä—Ö! 
        // –í HTML –æ–Ω–∞ —Å–µ–π—á–∞—Å –≤–Ω–∏–∑—É. –ú—ã –º–µ–Ω—è–µ–º —Ç–æ–ª—å–∫–æ JS, –Ω–æ –≤–∏–∑—É–∞–ª—å–Ω–æ –æ–Ω–∞ –æ—Å—Ç–∞–Ω–µ—Ç—Å—è –≤–Ω–∏–∑—É.
        // –ß—Ç–æ–±—ã –ø–æ–¥–Ω—è—Ç—å, —Ç–µ–±–µ –Ω—É–∂–Ω–æ –≤ HTML –ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ div id="row_prem" –≤—ã—à–µ.
        row('row_prem', premMoney);
        
        // 4. –í–†–ï–ú–Ø –°–£–¢–û–ö
        const evSum = total.eLine + total.eRes + total.eBase;
        const nightSum = total.nLine + total.nRes + total.nBase;
        row('row_ev', evSum, '0220 –í–µ—á–µ—Ä–Ω–∏–µ (20%):');
        row('row_night', nightSum, '0230 –ù–æ—á–Ω—ã–µ (40%):');

        // 5. –ö–õ–ê–°–°–ù–û–°–¢–¨ (0250)
        row('row_class', total.class);

        // 6. –û–°–¢–ê–õ–¨–ù–û–ï
        row('row_senior', total.senior, '0190 –ë—Ä–∏–≥–∞–¥–∏—Ä/–°—Ç.–º–∞—à:');
        row('row_mentor', total.mentor, '0540 –ù–∞—Å—Ç–∞–≤–Ω–∏–∫:'); // –ö—Ä–∞—Å–Ω–∞—è –∑–æ–Ω–∞
        row('row_tech', total.tech);
        
        // –ü–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∏
        row('row_ot15', otPay.total, '0700 –°–≤–µ—Ä—Ö—É—Ä–æ—á–Ω—ã–µ:');

        // –ò—Ç–æ–≥–∏
        document.getElementById('st_dirty').innerText = fmtMoney(total.dirty);
        document.getElementById('st_union').innerText = '-' + fmtMoney(union);
        document.getElementById('st_tax').innerText = '-' + fmtMoney(tax);
        document.getElementById('st_net').innerText = fmtMoney(net);
        
        // –ë–∞–∑–∞ –ø—Ä–µ–º–∏–∏ –¥–ª—è –∏–Ω—Ñ–æ
        const elBonus = document.getElementById('st_bonus_base');
        if (elBonus) elBonus.innerText = fmtMoney(bonusBase);
    }
function calculateRestIntervals() {
        // –°–æ—Ä—Ç–∏—Ä—É–µ–º —Å–º–µ–Ω—ã
        shifts.sort((a,b) => { 
            let tA = getShiftTimes(a), tB = getShiftTimes(b); 
            if(!tA) return 1; if(!tB) return -1; 
            return tA.start - tB.start; 
        }); 
        
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥–∏
        shifts.forEach(s => { 
            s.autoSplit = false; 
            s.isShortBreak = false; 
            s.gapMinutes = 0;
            s.forceFullNight = false; // –§–ª–∞–≥ –ø–æ–ª–Ω–æ–π –Ω–æ—á–∏
        });

        let processedIndices = new Set();

        for (let i = 0; i < shifts.length; i++) { 
            if (processedIndices.has(i)) continue;

            let curr = shifts[i]; 
            let next = (i + 1 < shifts.length) ? shifts[i+1] : null; 
            
            let tCurr = getShiftTimes(curr); 
            let tNext = next ? getShiftTimes(next) : null; 
            
            let isSplitPair = false;

            if (tCurr && tNext) { 
                let diffMs = tNext.start - tCurr.end; 
                let diffMinutes = Math.floor(diffMs / (1000 * 60)); 

                if (diffMinutes >= 0 && diffMinutes < 480) { 
                    isSplitPair = true;
                    if (diffMinutes < 150) {
                        // –ù–µ—Ä–∞–∑—Ä—ã–≤–Ω–∞—è
                        curr.isShortBreak = true;
                        curr.gapMinutes = diffMinutes;
                        next.isShortBreak = true; 
                    } else {
                        // –†–∞–∑—Ä—ã–≤–Ω–∞—è
                        curr.autoSplit = true; 
                        next.autoSplit = true; 
                    }
                    processedIndices.add(i + 1); 
                } 
            }

            // === –í–û–ó–í–†–ê–©–ê–ï–ú –ü–†–ê–í–ò–õ–û 50% (–ü–†–ê–í–ò–õ–¨–ù–û–ï) ===
            // –°—á–∏—Ç–∞–µ–º % –Ω–æ—á–∏ —Ç–æ–ª—å–∫–æ –æ—Ç –†–ê–ë–û–ß–ï–ì–û –≤—Ä–µ–º–µ–Ω–∏ (–±–µ–∑ —Ä–∞–∑—Ä—ã–≤–∞)
            
            if (isSplitPair) {
                // –ï—Å–ª–∏ —Å–≤—è–∑–∫–∞: –±–µ—Ä–µ–º —Å—É–º–º—É —á–∞—Å–æ–≤ –¥–≤—É—Ö —Å–º–µ–Ω
                let stat1 = getRawNightStats(curr.text, curr.isPostTrip);
                let stat2 = getRawNightStats(next.text, next.isPostTrip);

                let totalWork = stat1.dur + stat2.dur;   // –ß–∏—Å—Ç–∞—è —Ä–∞–±–æ—Ç–∞
                let totalNight = stat1.night + stat2.night; // –ß–∏—Å—Ç–∞—è –Ω–æ—á—å

                // –ï—Å–ª–∏ –Ω–æ—á–Ω—ã—Ö —á–∞—Å–æ–≤ >= 50% –æ—Ç –†–ê–ë–û–¢–´ -> –í–∫–ª—é—á–∞–µ–º —Ä–µ–∂–∏–º
                if (totalWork > 0 && (totalNight / totalWork) >= 0.50) {
                    curr.forceFullNight = true;
                    next.forceFullNight = true;
                }
            } else {
                // –û–¥–∏–Ω–æ—á–Ω–∞—è —Å–º–µ–Ω–∞
                let stat = getRawNightStats(curr.text, curr.isPostTrip);
                if (stat.dur > 0 && (stat.night / stat.dur) >= 0.50) {
                    curr.forceFullNight = true;
                }
            }
        } 
    }

function render(targetDate = null) {
        if (preventRender && !targetDate) return;

        const list = document.getElementById('shiftList');
        if(list.offsetHeight > 0) list.style.minHeight = list.offsetHeight + 'px';
        
        const scrollPos = window.scrollY; 
        
        // –í —Ç–≤–æ–µ–º –∫–æ–¥–µ —ç—Ç–æ –∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ –∏–ª–∏ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è, –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å
        // calculateRestIntervals(); 
        
        const fragment = document.createDocumentFragment();
        shifts.sort((a,b) => new Date(a.date) - new Date(b.date));
        
        const todayStr = getIsoDate(new Date());
        let currentMonthStr = "";

        shifts.forEach((s) => {
            if (!s.text) s.text = ""; 

            const shiftDate = new Date(s.date); 
            const monthYear = shiftDate.toLocaleString('ru', { month: 'long', year: 'numeric' }); 
            const monthYearCap = monthYear.charAt(0).toUpperCase() + monthYear.slice(1);
            
            if(monthYearCap !== currentMonthStr) { 
                currentMonthStr = monthYearCap; 
                const divider = document.createElement('div'); 
                divider.className = 'month-header'; 
                divider.innerText = currentMonthStr; 
                fragment.appendChild(divider); 
            }

            let res = calcShift(s); 
            
            let title = s.text.split(' ')[0]; 
            let details = s.text.substring(title.length).trim();
            let lowerText = s.text.toLowerCase(); 

            const isSpecialType = lowerText.includes('–±–ª') || lowerText.includes('–±–æ–ª—å–Ω–∏—á–Ω—ã–π') || 
                                  lowerText.includes('–æ—Ç–ø—É—Å–∫') || lowerText.includes('–æ—Ç–ø') || 
                                  lowerText.includes('–¥–æ–Ω–æ—Ä') || lowerText.includes('–∫—Ä–æ–≤—å');

            if (isSpecialType) {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º Logic, –∫–∞–∫ —É —Ç–µ–±—è –≤ —Ä–∞–±–æ—á–µ–º –∫–æ–¥–µ
                let val = !Logic.isWeekendOrHoliday(new Date(s.date)) ? 7.2 : 0;
                let hoursInfo = `(${val}—á)`;
                if(details) details += ` ${hoursInfo}`;
                else details = hoursInfo;
            }

            if (res) {
                let extraInfo = "";
                if (res.isFullMed) {
                    extraInfo = `(${res.duration.toFixed(1)}—á)`;
                }
                else if (res.tpHours > 0) {
                     let pureWork = res.duration - res.tpHours;
                     extraInfo = `(${pureWork.toFixed(1)} + ${res.tpHours.toFixed(1)}—á –¢–ü)`;
                }
                else if (res.gapHours > 0) {
                    let pureWork = res.hours - res.gapHours;
                    extraInfo = `(${pureWork.toFixed(1)} + ${res.gapHours.toFixed(1)}—á)`;
                } 
                else if (res.duration > 0 && !isSpecialType) {
                    extraInfo = `(${res.duration.toFixed(1)}—á)`;
                }
                if(details) details += " " + extraInfo;
                else details = extraInfo;
            }
            
            let tags = '';
            
            if (s.isFullMedical) tags += '<span class="tag" style="background:#d32f2f;">‚õî –û–¢–°–¢–†–ê–ù–ï–ù–ò–ï</span> ';
            if (lowerText.includes('–±–ª') || lowerText.includes('–±–æ–ª—å–Ω–∏—á–Ω—ã–π')) tags += '<span class="tag red">–ë–û–õ–¨–ù–ò–ß–ù–´–ô</span> ';
            if (lowerText.includes('–æ—Ç–ø—É—Å–∫') || lowerText.includes('–æ—Ç–ø')) tags += '<span class="tag" style="background: linear-gradient(135deg, #4fc3f7, #2196f3);">–û–¢–ü–£–°–ö</span> ';
            if (lowerText.includes('–¥–æ–Ω–æ—Ä')) tags += '<span class="tag donor" style="background:#ab47bc;">–î–û–ù–û–†</span> ';

            const isNonWork = isSpecialType || lowerText.includes('–≤—ã—Ö–æ–¥–Ω–æ–π') || lowerText.includes('–≤—ã—Ö');

            // –ò—Å–ø–æ–ª—å–∑—É–µ–º Logic.isStateHoliday, –∫–∞–∫ —É —Ç–µ–±—è
            if (Logic.isStateHoliday(new Date(s.date)) && !isNonWork) {
                tags += '<span class="tag" style="background:#e91e63;">üéâ –ü–†–ê–ó–î–ù–ò–ö x2</span> ';
            }

            if (s.isShortBreak) tags += '<span class="tag purple">üîó –ù–ï–†–ê–ó–†–´–í–ù–ê–Ø</span> ';

            if (res) { 
                if (res.isTrain) {
                     if (lowerText.includes('–º–µ–¥.–∫–æ–º') || lowerText.includes('–∫–æ–º–∏—Å—Å–∏—è') || 
                        lowerText.includes('–º–µ–¥ –∫–æ–º') || lowerText.includes('–º–µ–¥–∫–æ–º') || 
                        lowerText.includes('–ø—Å–∏—Ö') || lowerText.includes('–æ—Å–≤–∏–¥')) {
                        tags += '<span class="tag teal" style="background:#00897b">–ú–ï–î. –ö–û–ú–ò–°–°–ò–Ø</span> ';
                    } else {
                        tags += '<span class="tag teal">–û–ë–£–ß–ï–ù–ò–ï</span> ';
                    }
                }
                if (res.isRes) tags += '<span class="tag gray">–†–ï–ó–ï–†–í</span> '; 
                if (s.lineStart) tags += '<span class="tag orange">–í–´–ï–ó–î</span> '; 
                if (res.isTech) tags += '<span class="tag teal">+–£–ß–ï–ë–ê</span> '; 
            }
            if (s.note && s.note.trim() !== "") tags += '<span class="note-icon">üìå</span>'; 

            let div = document.createElement('div'); 
            div.className = 'shift-card'; 
            
            if(s.date === todayStr) { 
                div.classList.add('today'); 
                div.innerHTML = `<div class="today-badge">–°–ï–ì–û–î–ù–Ø</div>`; 
            }
            div.onclick = () => openDayModal(s.date);
            div.id = 'card-' + s.date; 
            
            let isDone = false;
            let now = new Date();
            let todayZero = new Date(now); todayZero.setHours(0,0,0,0);
            let sDateZero = new Date(s.date); sDateZero.setHours(0,0,0,0);

            if (sDateZero < todayZero) {
                isDone = true; 
            } else if (sDateZero.getTime() === todayZero.getTime()) {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º Logic.parseShift –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤—Ä–µ–º–µ–Ω–∏
                let parsedForTime = Logic.parseShift(s.text, s.date);
                if (parsedForTime && parsedForTime.endTimestamp && now > parsedForTime.endTimestamp) {
                    isDone = true;
                }
            }

            let moneyHTML = ''; 
            
            // === –í–û–¢ –ó–î–ï–°–¨ –ú–´ –°–ö–†–´–í–ê–ï–ú +0 ===
            // –ë—ã–ª–æ: if (res) ...
            // –°—Ç–∞–ª–æ: if (res && res.net > 0) ...
            
            if (res && res.net > 0) { 
                const moneyClass = isDone ? 'money-val' : 'money-val future'; 
                moneyHTML = `<div class="${moneyClass}">+${res.net}</div>`; 
            }
            // ==================================
            
            let d = new Date(s.date);
            div.innerHTML += `<div class="date-box"><span class="date-day">${d.getDate()}</span><span class="date-dow">${d.toLocaleString('ru',{weekday:'short'})}</span></div><div class="shift-info"><div class="shift-title">${title} ${tags}</div><div class="shift-sub">${details}</div></div><div style="text-align:right">${moneyHTML}</div>`;
            fragment.appendChild(div);
        });
        
        list.innerHTML = '';
        list.appendChild(fragment);
        renderStats();

        setTimeout(() => {
            list.style.minHeight = ''; 
            if (targetDate) {
                const el = document.getElementById('card-' + targetDate);
                if(el) el.scrollIntoView({block: "center", behavior: "auto"});
            } 
            else if (isFirstLoad) {
                const todayEl = document.querySelector('.shift-card.today');
                if (todayEl) todayEl.scrollIntoView({ block: "center", behavior: "auto" });
                isFirstLoad = false; 
            } else {
                window.scrollTo(0, scrollPos);
            }
        }, 50);
    }
    
    function addShift() { 
        let d = document.getElementById('inpDate').value; 
        let t = document.getElementById('inpText').value;
        let n = document.getElementById('inpNote').value; 
        let low = t.trim().toLowerCase();

        // –ê–≤—Ç–æ–∑–∞–º–µ–Ω—ã
        if (low === '–æ—Ç–ø') t = '–æ—Ç–ø—É—Å–∫';
        if (low.includes('–æ—Ö—Ä')) t = '–û—Ö—Ä–∞–Ω–∞ —Ç—Ä—É–¥–∞';
        else if (low.includes('–∫–æ—Ä–ø')) t = '–ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–π —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç';
        else if (low.includes('–æ–±—É—á–µ–Ω–∏–µ')) t = '–û–±—É—á–µ–Ω–∏–µ';
        else if (low.includes('–ø–æ–≤—ã—à')) t = '–ü–æ–≤—ã—à–µ–Ω–∏–µ –∫–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏–∏';
        else if (low.includes('–∫—É–ª—å—Ç—É—Ä')) t = '–ö—É–ª—å—Ç—É—Ä–∞ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è';
        else if (low === '—É–ø—Ü') t = '–£–ü–¶';
        else if (low.includes('–º–µ–¥.–∫–æ–º') || low.includes('–º–µ–¥ –∫–æ–º') || low.includes('–º–µ–¥–∫–æ–º')) t = '–ú–µ–¥. –∫–æ–º–∏—Å—Å–∏—è';
        
        // –ë–û–õ–¨–ù–ò–ß–ù–´–ô
        if (t.toLowerCase().includes('–±–ª') || t.toLowerCase().includes('–±–æ–ª—å–Ω–∏—á–Ω—ã–π')) {
            const years = getSickYears(d);
            const inc1 = safeFloat(document.getElementById('sickInc1').value);
            const inc2 = safeFloat(document.getElementById('sickInc2').value);
            const perc = parseInt(document.getElementById('sickPercent').value);
            if (!settings.sickData) settings.sickData = {};
            settings.sickData[years[0]] = inc1;
            settings.sickData[years[1]] = inc2;
            settings.sickPercent = perc;
            localStorage.setItem('metro_settings', JSON.stringify(settings));
            touchMeta('metro_settings');
        }

        let sRate = safeFloat(document.getElementById('shiftRate').value); 
        let sPrem = safeFloat(document.getElementById('shiftPrem').value); 
        let sMentor = document.getElementById('shiftMentor').checked; 
        let sSenior = document.getElementById('shiftSenior').checked; 
        let sClass = parseInt(document.getElementById('shiftClassSelect').value); 
        let sSen = getSeniorityPercent(settings.startDate); 
        let sTech = document.getElementById('shiftTech').checked; 
        let sPost = document.getElementById('shiftPostTrip').checked; 
        let sFullMed = document.getElementById('shiftFullMedical').checked;

        let sTpStart = document.getElementById('tpStart').value;
        let sTpEnd = document.getElementById('tpEnd').value;

        // === –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ó–ê–©–ò–¢–ê –¢–ï–†–ê–ü–ï–í–¢–ò–ß–ï–°–ö–û–ì–û –ü–£–ù–ö–¢–ê ===
        // –ï—Å–ª–∏ –≤—Ä–µ–º—è –Ω–µ —É–∫–∞–∑–∞–Ω–æ –ò–õ–ò –ù–∞—á–∞–ª–æ == –ö–æ–Ω–µ—Ü (–Ω–∞–ø—Ä–∏–º–µ—Ä 00:00 - 00:00)
        // –¢–æ –º—ã –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Å—Ç–∏—Ä–∞–µ–º —ç—Ç–∏ –¥–∞–Ω–Ω—ã–µ.
        if (!sTpStart || !sTpEnd || sTpStart === sTpEnd) {
            sTpStart = null;
            sTpEnd = null;
        }
        // ====================================================

        let lStart = document.getElementById('lineStart').value; 
        let lEnd = document.getElementById('lineEnd').value; 

        // –ó–ê–©–ò–¢–ê –í–´–ï–ó–î–ê (–∫–æ—Ç–æ—Ä—É—é –º—ã –¥–µ–ª–∞–ª–∏ —Ä–∞–Ω—å—à–µ)
        if (!t.toLowerCase().includes('—Ä–µ–∑')) {
            lStart = null;
            lEnd = null;
        } else {
            if (!lStart || !lEnd || lStart === lEnd) {
                lStart = null;
                lEnd = null;
            }
        }

        let checkText = t.toLowerCase();
        if (checkText.includes('–æ—Ç–ø—É—Å–∫') || checkText.includes('–æ—Ç–ø') || 
            checkText.includes('–±–ª') || checkText.includes('–±–æ–ª—å–Ω–∏—á–Ω—ã–π') || 
            checkText.includes('–¥–æ–Ω–æ—Ä')) {
            sFullMed = false; 
        }
        
        if(d && t) { 
            preventRender = true; 
            shifts = shifts.filter(s => s.date !== d); 
            shifts.push({ 
                date:d, text:t, note: n, 
                customRate: sRate, customMentor: sMentor, 
                customSenior: sSenior, customClass: sClass, customSen: sSen, 
                customPrem: sPrem, 
                
                lineStart: lStart, 
                lineEnd: lEnd,     
                
                isTech: sTech, isPostTrip: sPost,
                
                // –¢–µ–ø–µ—Ä—å sTpStart –±—É–¥–µ—Ç null, –µ—Å–ª–∏ –æ–Ω –ø—É—Å—Ç–æ–π –∏–ª–∏ –∫—Ä–∏–≤–æ–π
                tpStart: sTpStart, 
                tpEnd: sTpEnd, 
                isFullMedical: sFullMed
            });

            const targetDate = new Date(d);
            const targetMonth = targetDate.getMonth();
            const targetYear = targetDate.getFullYear();
            const lowerText = t.toLowerCase();
            const isSpecialType = lowerText.includes('–±–ª') || lowerText.includes('–æ—Ç–ø—É—Å–∫') || lowerText.includes('–¥–æ–Ω–æ—Ä');
            if (!isSpecialType && sRate > 0) {
                settings.rate = sRate;
                settings.premP = sPrem;
                shifts.forEach(s => {
                    const sd = new Date(s.date);
                    if (sd.getMonth() === targetMonth && sd.getFullYear() === targetYear) {
                        const sTxt = s.text.toLowerCase();
                        if (!sTxt.includes('–±–ª') && !sTxt.includes('–±–æ–ª—å–Ω–∏—á–Ω—ã–π') && 
                            !sTxt.includes('–æ—Ç–ø—É—Å–∫') && !sTxt.includes('–¥–æ–Ω–æ—Ä')) {
                            s.customRate = sRate;
                            s.customPrem = sPrem;
                        }
                    }
                });
            }
            touchMeta(getMonthKey(d));
            saveData(); 
            if(document.getElementById('calendarModal').classList.contains('open')) {
                renderCalendar();
                renderStats();
            } else {
                render(d); 
            }
            closeModal('addModal'); 
            setTimeout(() => { 
                preventRender = false; 
                const el = document.getElementById('card-' + d);
                if(el) el.scrollIntoView({block: "center", behavior: "auto"});
            }, 100);
        } 
    }
    
    function openModal() {
        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –¥–µ—Ç–∞–ª–∏, –µ—Å–ª–∏ –±—ã–ª–∏ –æ—Ç–∫—Ä—ã—Ç—ã
        const detailsBox = document.getElementById('shiftDetailsBox');
        if (detailsBox) detailsBox.open = false;

        document.body.classList.add('modal-open');
        document.getElementById('addModal').classList.add('open');
        setAutoDate();
        
        // –û—á–∏—â–∞–µ–º –ø–æ–ª—è
        document.getElementById('inpText').value = '';
        document.getElementById('inpNote').value = '';
        document.getElementById('modalTitle').innerText = '–ù–æ–≤–∞—è —Å–º–µ–Ω–∞';
        document.getElementById('btnSaveShift').innerText = '–î–æ–±–∞–≤–∏—Ç—å';
        document.getElementById('btnDeleteShift').style.display = 'none';
        
        // –°—Ç–∞–≤–∫–∞
        let showRate = (settings.rate > 0) ? settings.rate : 546.18;
        document.getElementById('shiftRate').value = String(showRate).replace('.', ',');

        // –ß–µ–∫–±–æ–∫—Å—ã
        document.getElementById('shiftMentor').checked = settings.mentor;
        document.getElementById('shiftSenior').checked = settings.senior || false;
        document.getElementById('shiftTech').checked = false;
        document.getElementById('shiftPostTrip').checked = false;
        document.getElementById('tpStart').value = '';
        document.getElementById('tpEnd').value = '';
        document.getElementById('shiftFullMedical').checked = false;
        
        // –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞
        document.getElementById('shiftMentor').disabled = false;
        document.getElementById('shiftSenior').disabled = false;
        document.getElementById('shiftPostTrip').disabled = false;

        // –ö–ª–∞—Å—Å
        document.getElementById('shiftClassSelect').value = (settings.classP === false) ? 0 : settings.classP;

        // === –ì–õ–ê–í–ù–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –£–ú–ù–ê–Ø –ü–†–ï–ú–ò–Ø ===
        let showPrem = settings.premP;

        // –ï—Å–ª–∏ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö 0 –∏–ª–∏ –ø—É—Å—Ç–æ ‚Äî –∏—â–µ–º –≤ –∏—Å—Ç–æ—Ä–∏–∏ —Å–º–µ–Ω –ø–æ—Å–ª–µ–¥–Ω—é—é –Ω–µ–ø—É—Å—Ç—É—é –ø—Ä–µ–º–∏—é
        if (!showPrem || parseFloat(showPrem) === 0) {
            // –ò—â–µ–º —Å –∫–æ–Ω—Ü–∞ —Å–ø–∏—Å–∫–∞ (–ø–æ—Å–ª–µ–¥–Ω—é—é –¥–æ–±–∞–≤–ª–µ–Ω–Ω—É—é)
            const lastShift = [...shifts].reverse().find(s => s.customPrem && parseFloat(s.customPrem) > 0);
            
            if (lastShift) {
                showPrem = lastShift.customPrem; // –ù–∞—à–ª–∏! –ë–µ—Ä–µ–º –µ—ë.
            } else {
                // –ï—Å–ª–∏ –∏—Å—Ç–æ—Ä–∏–∏ –Ω–µ—Ç –≤–æ–æ–±—â–µ (—Å–æ–≤—Å–µ–º –Ω–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å), –º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –ø—É—Å—Ç–æ
                // –∏–ª–∏ –ø–æ—Å—Ç–∞–≤–∏—Ç—å 35 (–∫–∞–∫ —Å—Ç–∞–Ω–¥–∞—Ä—Ç). –î–∞–≤–∞–π –æ—Å—Ç–∞–≤–∏–º –ø—É—Å—Ç–æ, –µ—Å–ª–∏ —Å–æ–≤—Å–µ–º –Ω–∏—á–µ–≥–æ –Ω–µ—Ç.
                showPrem = ''; 
            }
        }
        
        // –í—Å—Ç–∞–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –≤ –ø–æ–ª–µ
        document.getElementById('shiftPrem').value = showPrem ? String(showPrem).replace('.', ',') : '';
        // ===========================================

        checkShiftText();
        document.getElementById('inpText').focus();
    }
    // 1. –§–£–ù–ö–¶–ò–Ø –û–¢–ö–†–´–¢–ò–Ø –û–ö–ù–ê (–ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø)
    function openDayModal(dateStr) {
        const details = document.getElementById('shiftDetailsBox');
        if(details) details.open = false;

        document.body.classList.add('modal-open');
        document.getElementById('sickInc1').value = ''; 
        document.getElementById('sickInc2').value = '';
        document.getElementById('inpDate').value = dateStr;
        const shift = shifts.find(s => s.date === dateStr);
        const delBtn = document.getElementById('btnDeleteShift');
        const saveBtn = document.getElementById('btnSaveShift');
        const title = document.getElementById('modalTitle');
        
        // --- –°–ë–†–û–° –ü–û–õ–ï–ô (–ß–¢–û–ë–´ –ù–ï –ó–ê–õ–ò–ü–ê–õ–ò) ---
        // 1. –°–±—Ä–∞—Å—ã–≤–∞–µ–º –í—ã–µ–∑–¥
        document.getElementById('lineStart').value = '';
        document.getElementById('lineEnd').value = '';
        
        // 2. –°–±—Ä–∞—Å—ã–≤–∞–µ–º –¢–µ—Ä–∞–ø–µ–≤—Ç–∏—á–µ—Å–∫–∏–π –ø—É–Ω–∫—Ç –∏ –û—Ç—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ
        document.getElementById('tpStart').value = '';
        document.getElementById('tpEnd').value = '';
        document.getElementById('shiftFullMedical').checked = false;
        // ---------------------------------------

        const currentProfileRate = (settings.rate > 0) ? settings.rate : 546.18;

        if (shift) {
            // === –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï ===
            document.getElementById('inpText').value = shift.text;
            document.getElementById('inpNote').value = shift.note || '';
            
            let showRate = (shift.customRate !== undefined) ? shift.customRate : currentProfileRate;
            document.getElementById('shiftRate').value = String(showRate).replace('.', ',');

            document.getElementById('shiftMentor').checked = shift.customMentor !== undefined ? shift.customMentor : settings.mentor;
            document.getElementById('shiftSenior').checked = shift.customSenior !== undefined ? shift.customSenior : (settings.senior || false);
            document.getElementById('shiftTech').checked = shift.isTech !== undefined ? shift.isTech : false;
            document.getElementById('shiftPostTrip').checked = shift.isPostTrip !== undefined ? shift.isPostTrip : false;
            
            // –ó–∞–ø–æ–ª–Ω—è–µ–º –¢–ü, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å –≤ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–π —Å–º–µ–Ω–µ
            if (shift.tpStart) document.getElementById('tpStart').value = shift.tpStart;
            if (shift.tpEnd) document.getElementById('tpEnd').value = shift.tpEnd;
            document.getElementById('shiftFullMedical').checked = (shift.isFullMedical === true);

            let defaultClass = (settings.classP === false) ? 0 : settings.classP;
            document.getElementById('shiftClassSelect').value = (shift.customClass !== undefined) ? shift.customClass : defaultClass;
            
            let premVal = (shift.customPrem !== undefined) ? shift.customPrem : settings.premP;
            document.getElementById('shiftPrem').value = String(premVal).replace('.', ',');
            
            if (shift.lineStart) document.getElementById('lineStart').value = shift.lineStart;
            if (shift.lineEnd) document.getElementById('lineEnd').value = shift.lineEnd;
            
            title.innerText = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ';
            saveBtn.innerText = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
            delBtn.style.display = 'block';
        } else {
            // === –ù–û–í–ê–Ø –°–ú–ï–ù–ê ===
            document.getElementById('inpText').value = '';
            document.getElementById('inpNote').value = '';
            document.getElementById('shiftRate').value = String(currentProfileRate).replace('.', ',');
            
            document.getElementById('shiftMentor').checked = settings.mentor;
            document.getElementById('shiftSenior').checked = settings.senior || false;
            document.getElementById('shiftTech').checked = false;
            document.getElementById('shiftPostTrip').checked = false;
            
            // –ó–¥–µ—Å—å –ø–æ–ª—è –¢–ü –∏ –í—ã–µ–∑–¥–∞ —É–∂–µ —á–∏—Å—Ç—ã–µ (–º—ã –æ—á–∏—Å—Ç–∏–ª–∏ –∏—Ö –≤ –Ω–∞—á–∞–ª–µ —Ñ—É–Ω–∫—Ü–∏–∏)

            document.getElementById('shiftClassSelect').value = (settings.classP === false) ? 0 : settings.classP;
            document.getElementById('shiftPrem').value = String(settings.premP).replace('.', ',');
            
            title.innerText = '–ù–æ–≤–∞—è —Å–º–µ–Ω–∞';
            saveBtn.innerText = '–î–æ–±–∞–≤–∏—Ç—å';
            delBtn.style.display = 'none';
        }
        checkShiftText(); 
        document.getElementById('addModal').classList.add('open');
        document.getElementById('inpText').focus();
    }

    // 2. –§–£–ù–ö–¶–ò–Ø –ü–†–û–í–ï–†–ö–ò –¢–ï–ö–°–¢–ê –ò –ë–õ–û–ö–ò–†–û–í–ö–ò (–ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø)
    function checkShiftText() {
        const txt = document.getElementById('inpText').value.toLowerCase();
        const dateVal = document.getElementById('inpDate').value;
        const isSick = txt.includes('–±–ª') || txt.includes('–±–æ–ª—å–Ω–∏—á–Ω—ã–π');
        
        // –ü–æ–ª—É—á–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã
        const details = document.getElementById('shiftDetailsBox');
        const sickBox = document.getElementById('sickDetailsBox'); 
        const lineBlock = document.getElementById('lineWorkContainer');
        const rateHint = document.getElementById('rateHint');

        // –ß–µ–∫–±–æ–∫—Å—ã
        // –í–ù–ò–ú–ê–ù–ò–ï: –¢—É—Ç —Ç–µ–ø–µ—Ä—å shiftFullMedical –≤–º–µ—Å—Ç–æ shiftMedical
        const chkFullMed = document.getElementById('shiftFullMedical');
        const chkMentor = document.getElementById('shiftMentor');
        const chkSenior = document.getElementById('shiftSenior');
        const chkPost = document.getElementById('shiftPostTrip'); 

        // 1. –õ–û–ì–ò–ö–ê –ë–õ–û–ö–ò–†–û–í–ö–ò –ü–†–ò –ù–ï–î–û–ü–£–°–ö–ï
        if (chkFullMed && chkFullMed.checked) {
            // –ï—Å–ª–∏ –ü–æ–ª–Ω–æ–µ –°–Ω—è—Ç–∏–µ: –æ—Ç–∫–ª—é—á–∞–µ–º –Ω–∞–¥–±–∞–≤–∫–∏
            chkMentor.checked = false;
            chkSenior.checked = false;
            chkPost.checked = false;
            
            chkMentor.disabled = true;
            chkSenior.disabled = true;
            chkPost.disabled = true;
        } else {
            // –ï—Å–ª–∏ –¥–æ–ø—É—Å–∫–∞–µ—Ç—Å—è: —Ä–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º
            chkMentor.disabled = false;
            chkSenior.disabled = false;
            chkPost.disabled = false;
        }

        // 2. –û–°–¢–ê–õ–¨–ù–ê–Ø –õ–û–ì–ò–ö–ê –í–ò–î–ò–ú–û–°–¢–ò
        if (isSick) {
            if(details) details.style.display = 'none';
            if(sickBox) sickBox.style.display = 'block';
            
            const years = getSickYears(dateVal);
            const lbl1 = document.getElementById('lbl_year_1');
            const lbl2 = document.getElementById('lbl_year_2');
            if (lbl1) lbl1.innerText = `–î–æ—Ö–æ–¥ –∑–∞ ${years[0]} –≥–æ–¥`;
            if (lbl2) lbl2.innerText = `–î–æ—Ö–æ–¥ –∑–∞ ${years[1]} –≥–æ–¥`;

            let field1 = document.getElementById('sickInc1');
            if (settings.sickData && settings.sickData[years[0]] && field1.value === '') {
                field1.value = settings.sickData[years[0]];
            }
            let field2 = document.getElementById('sickInc2');
            if (settings.sickData && settings.sickData[years[1]] && field2.value === '') {
                field2.value = settings.sickData[years[1]];
            }
        } else {
            if(sickBox) sickBox.style.display = 'none';
            
            if (txt.includes('–≤—ã—Ö') || txt.includes('–¥–æ–Ω–æ—Ä') || txt.includes('–æ—Ç–ø—É—Å–∫') || txt.includes('–æ—Ç–ø')) {
                if(details) details.style.display = 'none';
            } else {
                if(details) details.style.display = 'block';
            }
            
            if (txt.includes('—Ä–µ–∑')) {
                if(lineBlock) lineBlock.style.display = 'block';
                if(rateHint) rateHint.style.display = 'block';
            } else {
                if(lineBlock) lineBlock.style.display = 'none';
                if(rateHint) rateHint.style.display = 'none';
            }
        }
    }
    
    
    let wipeTimeout;
    
    function wipeCurrentMonth() {
        const btn = document.querySelector('.month-selector .month-btn[title="–û—á–∏—Å—Ç–∏—Ç—å –º–µ—Å—è—Ü"]');
        
        // –ï—Å–ª–∏ —ç—Ç–æ –ø–µ—Ä–≤–æ–µ –Ω–∞–∂–∞—Ç–∏–µ
        if (!btn.classList.contains('confirm-state')) {
            btn.classList.add('confirm-state');
            btn.innerHTML = "–¢–æ—á–Ω–æ?"; // –ú–µ–Ω—è–µ–º –∏–∫–æ–Ω–∫—É –Ω–∞ –≤–æ–ø—Ä–æ—Å
            btn.style.color = "#d32f2f"; // –î–µ–ª–∞–µ–º –∫—Ä–∞—Å–Ω–æ–π
            
            // –ï—Å–ª–∏ –∑–∞ 3 —Å–µ–∫—É–Ω–¥—ã –Ω–µ –Ω–∞–∂–∞–ª —Å–Ω–æ–≤–∞ ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–∞–∫ –±—ã–ª–æ
            wipeTimeout = setTimeout(() => {
                btn.classList.remove('confirm-state');
                btn.innerHTML = "üóëÔ∏è";
                btn.style.color = "#e53935";
            }, 3000);
            return;
        }

        // –ï—Å–ª–∏ —ç—Ç–æ –í–¢–û–†–û–ï –Ω–∞–∂–∞—Ç–∏–µ (–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ)
        clearTimeout(wipeTimeout);
        
        // --- –õ–û–ì–ò–ö–ê –£–î–ê–õ–ï–ù–ò–Ø ---
        const year = statsDate.getFullYear();
        const month = statsDate.getMonth() + 1;
        const mStr = String(month).padStart(2, '0');
        
        shifts = shifts.filter(s => !s.date.startsWith(`${year}-${mStr}`));
        touchMeta(`s_${year}_${mStr}`);
        saveData(); 
        render(); 
        // -----------------------

        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–Ω–æ–ø–∫—É –≤ –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        btn.classList.remove('confirm-state');
        btn.innerHTML = "üóëÔ∏è";
        btn.style.color = "#e53935";
    }

    function openImportModal() { 
        document.body.classList.add('modal-open'); 
        document.getElementById('importModal').classList.add('open'); 
        
        // –í–æ—Ç —ç—Ç–∏ –¥–≤–µ —Å—Ç—Ä–æ–∫–∏ —Ä–µ—à–∞—Ç –ø—Ä–æ–±–ª–µ–º—É:
        document.getElementById('importText').value = ''; // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –æ—Ç —Å—Ç–∞—Ä–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
        document.getElementById('importText').focus();    // –°—Ä–∞–∑—É —Å—Ç–∞–≤–∏–º –∫—É—Ä—Å–æ—Ä, —á—Ç–æ–±—ã —É–¥–æ–±–Ω–æ –±—ã–ª–æ –≤—Å—Ç–∞–≤–∏—Ç—å
    }
    
    function closeModal(id) { 
        document.body.classList.remove('modal-open'); 
        document.getElementById(id).classList.remove('open');
        if (id === 'calendarModal') render(); 
    }

    function processImport() { 
        const text = document.getElementById('importText').value; 
        if(!text) return; 
        
        const lines = text.split('\n'); 
        let addedCount = 0; 
        let errorCount = 0;
        
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∏
        // –í–ê–ñ–ù–û: –ï—Å–ª–∏ —Å—Ç–∞–≤–∫–∞ –≤ –ø—Ä–æ—Ñ–∏–ª–µ 0, –±–µ—Ä–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç 546.18
        const profileRate = safeFloat(settings.rate);
        const defRate = profileRate > 0 ? profileRate : 546.18; 
        
        const defMent = settings.mentor; 
        const defSen = settings.senior || false; 
        const defClass = settings.classP; 
        const defExp = getSeniorityPercent(settings.startDate); 
        const defPrem = settings.premP;
        
        const now = new Date();
        const currentYear = now.getFullYear();
        const currentMonth = now.getMonth(); 

        lines.forEach(line => { 
            line = line.trim(); 
            if(!line) return; 

            // 1. –î–ò–ê–ü–ê–ó–û–ù
            const rangeRegex = /^\s*(\d{1,2})[\.\/,\-](\d{1,2})[\.\/,\-](\d{2,4})\s*-\s*(\d{1,2})[\.\/,\-](\d{1,2})[\.\/,\-](\d{2,4})/;
            const rangeMatch = line.match(rangeRegex);

            if (rangeMatch) {
                let d1 = parseInt(rangeMatch[1]), m1 = parseInt(rangeMatch[2]) - 1, y1 = parseInt(rangeMatch[3]);
                let d2 = parseInt(rangeMatch[4]), m2 = parseInt(rangeMatch[5]) - 1, y2 = parseInt(rangeMatch[6]);
                
                if(y1 < 100) y1 += 2000; 
                if(y2 < 100) y2 += 2000;

                let current = new Date(y1, m1, d1);
                const end = new Date(y2, m2, d2);
                
                let desc = line.replace(rangeMatch[0], '').trim();
                if (desc.toLowerCase().includes('–±–æ–ª—å–Ω–∏—á–Ω—ã–π')) desc = "–ë–õ";
                if (desc.toLowerCase() === '–æ—Ç–ø') desc = "–æ—Ç–ø—É—Å–∫";

                // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ú—ã –í–°–ï–ì–î–ê –±–µ—Ä–µ–º –ø–æ–ª–Ω—É—é —Å—Ç–∞–≤–∫—É.
                // –ù–µ–≤–∞–∂–Ω–æ, —Ä–µ–∑–µ—Ä–≤ —ç—Ç–æ –∏–ª–∏ –Ω–µ—Ç. –ü—Ä–æ–≥—Ä–∞–º–º–∞ —Å–∞–º–∞ –ø–æ—Ç–æ–º –ø–æ—Å—á–∏—Ç–∞–µ—Ç 8% –≤—Ä–µ–¥–Ω–æ—Å—Ç–∏.
                let impRate = defRate; 

                while (current <= end) {
                    const iso = getIsoDate(current);
                    shifts = shifts.filter(s => s.date !== iso);
                    
                    shifts.push({ 
                        date: iso, text: desc, customRate: impRate, 
                        customMentor: defMent, customSenior: defSen, 
                        customClass: defClass, customSen: defExp, customPrem: defPrem 
                    });
                    
                    addedCount++;
                    current.setDate(current.getDate() + 1);
                }

            } else {
                // 2. –û–î–ò–ù–û–ß–ù–ê–Ø –î–ê–¢–ê
                const dateRegex = /^\s*(\d{1,2})[\.\/,\-](\d{1,2})(?:[\.\/,\-](\d{2,4}))?/;
                const dateMatch = line.match(dateRegex);

                if(dateMatch) { 
                    let day = parseInt(dateMatch[1]); 
                    let month = parseInt(dateMatch[2]); 
                    let year = currentYear;

                    if (dateMatch[3]) {
                        year = parseInt(dateMatch[3]);
                    } else {
                        if (currentMonth >= 9 && month <= 2) {
                            year += 1;
                        }
                    }
                    if(year < 100) year += 2000;

                    const isoDate = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    
                    let desc = line.replace(dateMatch[0], '').trim(); 
                    if (desc.toLowerCase().includes('–±–æ–ª—å–Ω–∏—á–Ω—ã–π')) desc = "–ë–õ";
                    if (desc.toLowerCase() === '–æ—Ç–ø') desc = "–æ—Ç–ø—É—Å–∫";
        
                    shifts = shifts.filter(s => s.date !== isoDate); 
                    
                    // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –¢—É—Ç —Ç–æ–∂–µ —É–±–∏—Ä–∞–µ–º —É—Å–ª–æ–≤–∏–µ –ø—Ä–æ "—Ä–µ–∑". –í—Å–µ–≥–¥–∞ –ø–æ–ª–Ω–∞—è —Å—Ç–∞–≤–∫–∞.
                    let impRate = defRate; 
                    
                    shifts.push({ 
                        date: isoDate, text: desc, customRate: impRate, 
                        customMentor: defMent, customSenior: defSen, 
                        customClass: defClass, customSen: defExp, customPrem: defPrem 
                    }); 
                    addedCount++; 
                } else {
                    console.warn("–ü—Ä–æ–ø—É—â–µ–Ω–∞ —Å—Ç—Ä–æ–∫–∞:", line);
                    errorCount++;
                }
            }
        }); 
        
        if(addedCount > 0) { 
            saveData(); 
            render(); 
            
            // 1. –ù–∞—Ö–æ–¥–∏–º –∫–Ω–æ–ø–∫—É –∏ –º–µ–Ω—è–µ–º –µ—ë –≤–∏–¥
            const btn = document.querySelector('#importModal .btn-save');
            const originalText = btn.innerText;
            const originalColor = btn.style.background;
            
            btn.innerText = `–î–æ–±–∞–≤–ª–µ–Ω–æ: ${addedCount} ‚úÖ`;
            btn.style.background = "#4caf50"; // –ó–µ–ª–µ–Ω—ã–π —Ü–≤–µ—Ç —É—Å–ø–µ—Ö–∞
            
            // 2. –ñ–¥–µ–º 1.5 —Å–µ–∫—É–Ω–¥—ã, —á—Ç–æ–±—ã —Ç—ã —É–≤–∏–¥–µ–ª —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            setTimeout(() => {
                closeModal('importModal');
                
                // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–Ω–æ–ø–∫–µ –ø—Ä–µ–∂–Ω–∏–π –≤–∏–¥ (–¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ —Ä–∞–∑–∞)
                btn.innerText = originalText;
                btn.style.background = originalColor;
            }, 1500);
            
        } else { 
            // –û—à–∏–±–∫–∞: –ö–Ω–æ–ø–∫–∞ –∫—Ä–∞—Å–Ω–µ–µ—Ç (–∫–∞–∫ –º—ã –¥–µ–ª–∞–ª–∏ —Ä–∞–Ω—å—à–µ)
            const btn = document.querySelector('#importModal .btn-save');
            const originalText = btn.innerText;
            const originalColor = btn.style.background;
            
            btn.innerText = "–ù–µ—Ç –¥–∞—Ç ‚ö†Ô∏è"; 
            btn.style.background = "#e53935"; 
            
            setTimeout(() => {
                btn.innerText = originalText;
                btn.style.background = originalColor;
            }, 1500);
        }
    }
    
    function renderCalendar() {
        const grid = document.getElementById('calGrid');
        grid.innerHTML = '';
        ['–ü–ù', '–í–¢', '–°–†', '–ß–¢', '–ü–¢', '–°–ë', '–í–°'].forEach(d => grid.innerHTML += `<div class="cal-day-name">${d}</div>`);
        const year = calDate.getFullYear();
        const month = calDate.getMonth();
        const monthNames = ["–Ø–Ω–≤–∞—Ä—å", "–§–µ–≤—Ä–∞–ª—å", "–ú–∞—Ä—Ç", "–ê–ø—Ä–µ–ª—å", "–ú–∞–π", "–ò—é–Ω—å", "–ò—é–ª—å", "–ê–≤–≥—É—Å—Ç", "–°–µ–Ω—Ç—è–±—Ä—å", "–û–∫—Ç—è–±—Ä—å", "–ù–æ—è–±—Ä—å", "–î–µ–∫–∞–±—Ä—å"];
        document.getElementById('calTitle').innerText = `${monthNames[month]} ${year}`;
        let firstDay = new Date(year, month, 1).getDay();
        firstDay = (firstDay === 0 ? 6 : firstDay - 1);
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const todayStr = getIsoDate(new Date());
        for (let i = 0; i < firstDay; i++) grid.innerHTML += `<div class="cal-cell empty"></div>`;
        for (let d = 1; d <= daysInMonth; d++) {
            const currentIso = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
            const shift = shifts.find(s => s.date === currentIso);
            const dateObj = new Date(currentIso);
            
            // 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º, "–ö—Ä–∞—Å–Ω—ã–π" –ª–∏ —ç—Ç–æ –¥–µ–Ω—å –∫–∞–ª–µ–Ω–¥–∞—Ä—è? (–í—ã—Ö–æ–¥–Ω–æ–π, –ü—Ä–∞–∑–¥–Ω–∏–∫ –∏–ª–∏ –ü–µ—Ä–µ–Ω–æ—Å)
            // Logic.isWeekendOrHoliday —Å–∞–º–∞ –∑–Ω–∞–µ—Ç –ø—Ä–æ —Ä–∞–±–æ—á–∏–µ —Å—É–±–±–æ—Ç—ã –∏ –ø–µ—Ä–µ–Ω–æ—Å—ã.
            const isRedDay = Logic.isWeekendOrHoliday(dateObj);
            
            // 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ì–û–°. –ü–†–ê–ó–î–ù–ò–ö –ª–∏ —ç—Ç–æ (–¥–ª—è —Ñ–æ–Ω–∞ x2)
            const isStateHol = Logic.isStateHoliday(dateObj);
            
            let cellClass = '';

            // –ï—Å–ª–∏ —ç—Ç–æ –≤—ã—Ö–æ–¥–Ω–æ–π –¥–µ–Ω—å (–ª—é–±–æ–π) - –¥–µ–ª–∞–µ–º —Ü–∏—Ñ—Ä—É –∫—Ä–∞—Å–Ω–æ–π
            if (isRedDay) cellClass += ' weekend';

            // –ï—Å–ª–∏ —ç—Ç–æ –ò–ú–ï–ù–ù–û –ü—Ä–∞–∑–¥–Ω–∏–∫ (1 –º–∞—è, 9 –º–∞—è –∏ —Ç.–¥.) - –¥–æ–±–∞–≤–ª—è–µ–º —Å–ø–µ—Ü. –∫–ª–∞—Å—Å –¥–ª—è —Ñ–æ–Ω–∞
            if (isStateHol) cellClass += ' state-holiday';

            let content = `<div class="cal-num">${d}</div>`;
            
           if (shift) {
                let text = shift.text.toLowerCase();
                let typeClass = 'type-work';
                
                // –ï—Å–ª–∏ –û–¢–°–¢–†–ê–ù–ï–ù–ò–ï ‚Äî –∫—Ä–∞—Å–∏–º –∫–∞–∫ –±–æ–ª—å–Ω–∏—á–Ω—ã–π (–∂–µ–ª—Ç—ã–π —Ñ–æ–Ω)
                if (shift.isFullMedical) typeClass = 'type-sick';
                
                else if (text.includes('–±–ª')) typeClass = 'type-sick';
                else if (text.includes('–¥–æ–Ω–æ—Ä')) typeClass = 'type-donor';
                else if (text.includes('–æ—Ç–ø—É—Å–∫') || text.includes('–æ—Ç–ø')) typeClass = 'type-vacation';
                else if (text.includes('–≤—ã—Ö')) typeClass = 'type-off';
                else if (text.includes('—É–ø—Ü') || text.includes('—É—á–µ–±–∞') || text.includes('–æ–±—É—á–µ–Ω–∏–µ')) typeClass = 'type-train';
                
                cellClass += ` has-shift ${typeClass}`;
                
                if (shift.note && shift.note.trim() !== "") {
                    cellClass += ' has-note';
                }
                
                if (shift.isTech) {
                    content += `<div style="position:absolute; top:3px; left:4px; font-size:10px; line-height:1;" title="–¢–µ—Ö. —É—á–µ–±–∞">üéì</div>`;
                }

                let fullText = shift.text.toLowerCase();
                let title = "";

                // –°–ª–æ–≤–∞—Ä—å –∑–∞–º–µ–Ω (–º–æ–∂–µ—à—å –¥–æ–±–∞–≤–∏—Ç—å —Å–≤–æ–∏)
                if (fullText.includes("–æ—Ö—Ä–∞–Ω–∞") || fullText.includes("–æ—Ö—Ä")) title = "–û–•–†";
                else if (fullText.includes("–º–µ–¥.") || fullText.includes("–∫–æ–º–∏—Å—Å")) title = "–ú–ï–î";
                else if (fullText.includes("—É–ø—Ü")) title = "–£–ü–¶";
                else if (fullText.includes("—Ç–µ—Ö.") || fullText.includes("—Ç–µ—Ö —É—á–µ–±–∞")) title = "–¢–ï–•";
                else if (fullText.includes("–∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤") || fullText.includes("–∫–æ—Ä–ø")) title = "–ö–û–†–ü";
                else if (fullText.includes("–ø–æ–≤—ã—à–µ–Ω–∏–µ") || fullText.includes("–∫–≤–∞–ª–∏—Ñ")) title = "–ü–û–í";
                else if (fullText.includes("–ø—Å–∏—Ö") || fullText.includes("–æ—Å–≤–∏–¥")) title = "–ü–°–ò–•";
                else if (fullText.includes("–≤—ã—Ö–æ–¥–Ω–æ–π") || fullText.includes("–≤—ã—Ö")) title = "–í–´–•";
                else if (fullText.includes("–æ—Ç–ø—É—Å–∫") || fullText.includes("–æ—Ç–ø")) title = "–û–¢–ü";
                else if (fullText.includes("–±–æ–ª—å–Ω–∏—á–Ω—ã–π") || fullText.includes("–±–ª")) title = "–ë–õ";
                else if (fullText.includes("–¥–æ–Ω–æ—Ä")) title = "–î–û–ù";
                else {
                    // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –≤ —Å–ª–æ–≤–∞—Ä–µ - –±–µ—Ä–µ–º –ø–µ—Ä–≤–æ–µ —Å–ª–æ–≤–æ
                    let firstWord = shift.text.split(' ')[0];
                    // –ï—Å–ª–∏ —ç—Ç–æ –º–∞—Ä—à—Ä—É—Ç (–º70, –ø2) - –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å
                    // –ï—Å–ª–∏ –¥–ª–∏–Ω–Ω–æ–µ —Å–ª–æ–≤–æ - —Ä–µ–∂–µ–º –∞–∫–∫—É—Ä–∞—Ç–Ω–µ–µ (–¥–æ 5 –±—É–∫–≤ –±–µ–∑ —Ç–æ—á–∫–∏)
                    if (firstWord.length > 6) title = firstWord.substr(0, 5); 
                    else title = firstWord;
                }

                content += `<div class="cal-shift">${title}</div>`;
            }
            
            if (currentIso === todayStr) cellClass += ' today';
            
            // –í–ê–ñ–ù–û: –î–æ–±–∞–≤–∏–ª –æ–±—Ä–∞–±–æ—Ç–∫—É —Å–≤–∞–π–ø–∞ –≤–Ω—É—Ç—Ä—å onclick, —á—Ç–æ–±—ã –Ω–µ –º–µ—à–∞–ª
            grid.innerHTML += `<div class="cal-cell ${cellClass}" onclick="openDayModal('${currentIso}')">${content}</div>`;
        }
    }
    
    function changeMonth(dir) { calDate.setMonth(calDate.getMonth() + dir); renderCalendar(); }
    function openCalendarModal() { document.body.classList.add('modal-open'); document.getElementById('calendarModal').classList.add('open'); renderCalendar(); }
    function setAutoDate() { if (shifts.length === 0) { document.getElementById('inpDate').valueAsDate = new Date(); return; } let maxTime = 0; shifts.forEach(s => { let time = new Date(s.date).getTime(); if (time > maxTime) maxTime = time; }); let nextDay = new Date(maxTime); nextDay.setDate(nextDay.getDate() + 1); document.getElementById('inpDate').valueAsDate = nextDay; }
    const FSS_LIMITS = { 2023: 1917000, 2024: 2225000, 2025: 2753000 };

    // –ü–æ–ª—É—á–∏—Ç—å –¥–≤–∞ —Ä–∞—Å—á–µ—Ç–Ω—ã—Ö –≥–æ–¥–∞ –¥–ª—è –¥–∞—Ç—ã –±–æ–ª—å–Ω–∏—á–Ω–æ–≥–æ
    function getSickYears(dateStr) {
        let d = dateStr ? new Date(dateStr) : new Date();
        let y = d.getFullYear();
        return [y - 2, y - 1];
    }
    function openDonation() {
    const donationUrl = "https://pay.cloudtips.ru/p/1b8ab64d"; 

    if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.openLink) {
        // –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –º–µ—Ç–æ–¥ –¥–ª—è Telegram: –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –≤–æ –≤–Ω–µ—à–Ω–µ–º –±—Ä–∞—É–∑–µ—Ä–µ
        window.Telegram.WebApp.openLink(donationUrl);
    } else {
        // –ó–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç –¥–ª—è –æ–±—ã—á–Ω–æ–≥–æ –±—Ä–∞—É–∑–µ—Ä–∞
        window.open(donationUrl, '_blank');
    }
}    
    init();
    
    function pasteFromClipboard() {
        const input = document.getElementById('inpText');
        
        if (navigator.clipboard && navigator.clipboard.readText) {
            navigator.clipboard.readText()
                .then(text => {
                    input.value = text;
                    checkShiftText();
                    // –£—Å–ø–µ—Ö - –∑–µ–ª–µ–Ω–∞—è –≤—Å–ø—ã—à–∫–∞
                    input.style.borderColor = '#4caf50';
                    setTimeout(() => input.style.borderColor = '', 300);
                })
                .catch(err => {
                    // –û—à–∏–±–∫–∞ - –∫—Ä–∞—Å–Ω–∞—è –≤—Å–ø—ã—à–∫–∞ (–±–µ–∑ —Ç–µ–∫—Å—Ç–∞)
                    console.error(err);
                    input.style.borderColor = '#d32f2f';
                    input.placeholder = "–û—à–∏–±–∫–∞ –≤—Å—Ç–∞–≤–∫–∏. –ñ–º–∏ Ctrl+V";
                    setTimeout(() => {
                        input.style.borderColor = '';
                        input.placeholder = "–ù–∞–ø—Ä–∏–º–µ—Ä: –º75 14:00-22:00 –∏–ª–∏ –ë–õ";
                    }, 2000);
                });
        } else {
            // –°—Ç–∞—Ä—ã–π –±—Ä–∞—É–∑–µ—Ä - –∫—Ä–∞—Å–Ω–∞—è –≤—Å–ø—ã—à–∫–∞
            input.style.borderColor = '#d32f2f';
            setTimeout(() => input.style.borderColor = '', 300);
        }
    }
</script>

</body>
</html>