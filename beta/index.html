<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ì—Ä–∞—Ñ–∏–∫–ë—Ä–æ v1.1 Fix</title>

    <script type="text/javascript" >
       (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
       m[i].l=1*new Date();
       for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
       k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
       (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");

       ym(105574700, "init", {
           clickmap:true,
           trackLinks:true,
           accurateTrackBounce:true,
           webvisor:true
       });
    </script>
    <noscript><div><img src="https://mc.yandex.ru/watch/105574700" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <script>
        if (!window.Telegram || !window.Telegram.WebApp || !window.Telegram.WebApp.initData) {
            console.warn("‚ö†Ô∏è –ó–ê–ü–£–°–ö –í –ë–†–ê–£–ó–ï–†–ï: –í–∫–ª—é—á–µ–Ω —Ä–µ–∂–∏–º —ç–º—É–ª—è—Ü–∏–∏ Telegram.");
            window.Telegram = {
                WebApp: {
                    initData: "user_id=123&first_name=Tester",
                    initDataUnsafe: { user: { id: 999999, first_name: "BrowserUser", username: "tester" } },
                    colorScheme: 'light',
                    themeParams: { bg_color: "#ffffff", text_color: "#000000" },
                    isExpanded: true,
                    viewportHeight: window.innerHeight,
                    ready: function() { console.log('[MockTG] App Ready'); },
                    expand: function() { console.log('[MockTG] App Expanded'); },
                    close: function() { console.log('[MockTG] Close command'); },
                    CloudStorage: {
                        getItem: function(key, callback) { setTimeout(() => { const val = localStorage.getItem('mock_cloud_' + key); if (callback) callback(null, val); }, 100); },
                        setItem: function(key, value, callback) { setTimeout(() => { localStorage.setItem('mock_cloud_' + key, value); if (callback) callback(null, true); }, 100); },
                        getItems: function(keys, callback) { setTimeout(() => { const result = {}; keys.forEach(k => { const v = localStorage.getItem('mock_cloud_' + k); if (v) result[k] = v; }); if (callback) callback(null, result); }, 100); },
                        getKeys: function(callback) { setTimeout(() => { const keys = []; for (let i = 0; i < localStorage.length; i++) { const k = localStorage.key(i); if (k.startsWith('mock_cloud_')) { keys.push(k.replace('mock_cloud_', '')); } } if (callback) callback(null, keys); }, 100); }
                    }
                }
            };
        }
    </script>
    <style>
        :root {
            --primary: #37474f; --accent: #ffab00; --bg: #f5f7fa; --card: #ffffff; --text: #263238;
            --nav-inactive: #90a4ae;
            --col-work-bg: #e8f5e9; --col-work-txt: #2e7d32;
            --col-sick-bg: #fff9c4; --col-sick-txt: #fbc02d; --col-sick-border: #fff59d;
            --col-donor-bg: #f3e5f5; --col-donor-txt: #ab47bc; --col-donor-border: #e1bee7;
            --col-train-bg: #e0f7fa; --col-train-txt: #006064; --col-train-border: #b2ebf2;
            --col-weekend-txt: #e53935; --col-holiday-bg: #ffebee; --col-holiday-border: #ef5350; 
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Roboto", sans-serif; background-color: var(--bg); margin: 0; padding: 0; color: var(--text); padding-bottom: 90px; padding-top: 60px; -webkit-tap-highlight-color: transparent; }
        body.modal-open { overflow: hidden; touch-action: none; }

        header { background-color: var(--card); color: var(--text); height: 60px; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); position: fixed; top: 0; left: 0; right: 0; z-index: 100; }
        h1 { font-size: 22px; font-weight: 800; letter-spacing: -0.5px; margin: 0; color: var(--primary); }
        .header-btn { background: #f0f2f5; border: none; cursor: pointer; color: var(--primary); padding: 10px; border-radius: 12px; transition: 0.2s; } .header-btn:active { transform: scale(0.95); } .header-btn svg { width: 24px; height: 24px; fill: currentColor; }
        #loader { position: fixed; top:0; left:0; right:0; bottom:0; background: var(--bg); z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: opacity 0.3s; pointer-events: none; opacity: 0;}
        .spinner { width: 40px; height: 40px; border: 4px solid #cfd8dc; border-top: 4px solid var(--accent); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .loader-text { margin-top: 15px; font-weight: 600; color: var(--primary); font-size: 14px; }
        .loader-active { opacity: 1 !important; pointer-events: all !important; }
        .page { display: none; padding: 20px; animation: fadeIn 0.3s ease; } .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .hero-widget { border-radius: 24px; padding: 25px; color: white; box-shadow: 0 15px 30px rgba(0,0,0,0.15); margin-bottom: 20px; position: relative; overflow: hidden; }
        .theme-work { background: linear-gradient(135deg, #263238 0%, #37474f 100%); }
        .theme-rest { background: linear-gradient(135deg, #0288d1 0%, #26c6da 100%); }
        .widget-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; opacity: 0.9; }
        .widget-title { font-size: 13px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; }
        .widget-main-value { font-size: 52px; font-weight: 800; letter-spacing: -1px; line-height: 1; margin-bottom: 5px; }
        .widget-sub-value { font-size: 15px; opacity: 0.9; font-weight: 600; background: rgba(255,255,255,0.2); padding: 4px 10px; border-radius: 8px; display: inline-block; margin-bottom: 15px;}
        .progress-track { background: rgba(255,255,255,0.2); height: 6px; border-radius: 4px; margin-top: 20px; overflow: hidden; }
        .progress-fill { height: 100%; border-radius: 4px; transition: width 1s linear; background: white; }
        .theme-work .progress-fill { background: var(--accent); }
        .progress-labels { display: flex; justify-content: space-between; margin-top: 8px; font-size: 12px; font-weight: 600; opacity: 0.9; }
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .info-card { background: white; padding: 15px; border-radius: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); text-align: center; }
        .info-label { font-size: 11px; color: #90a4ae; font-weight: 700; text-transform: uppercase; margin-bottom: 6px; }
        .info-val { font-size: 17px; font-weight: 700; color: var(--primary); }
        .month-header { font-size: 14px; font-weight: 800; color: var(--nav-inactive); margin: 10px 0 15px 5px; text-transform: uppercase; letter-spacing: 1px; }
        .shift-card { background: white; border-radius: 16px; padding: 15px; margin-bottom: 12px; display: flex; align-items: center; box-shadow: 0 2px 8px rgba(0,0,0,0.04); cursor: pointer; transition: transform 0.1s; position: relative; overflow: hidden;}
        .shift-card:active { transform: scale(0.98); }
        .shift-card.today { border: 2px solid var(--accent); background-color: #fffde7; }
        .today-badge { position: absolute; top: 0; right: 0; background: var(--accent); color: white; font-size: 10px; padding: 3px 8px; border-bottom-left-radius: 10px; font-weight: bold; z-index: 10; }
        .date-box { background: #f0f2f5; min-width: 50px; height: 50px; border-radius: 12px; display: flex; flex-direction: column; align-items: center; justify-content: center; margin-right: 16px; color: var(--primary); }
        .date-day { font-size: 20px; font-weight: 800; line-height: 1; }
        .date-dow { font-size: 11px; text-transform: uppercase; margin-top: 3px; font-weight: 600; color: #78909c;}
        .shift-info { flex-grow: 1; min-width: 0; }
        .shift-title { font-weight: 700; font-size: 16px; display: flex; align-items: center; gap: 8px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .shift-sub { font-size: 13px; color: #78909c; margin-top: 4px; font-weight: 500; }
        .money-val { color: #2e7d32; font-weight: 800; font-size: 16px; }
        .money-val.future { color: #90a4ae; font-weight: 600; }
        .cal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .cal-title { font-size: 18px; font-weight: 700; }
        .cal-btn { background: none; border: none; font-size: 24px; color: var(--primary); cursor: pointer; padding: 5px 15px; }
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; width: 100%; }
        .cal-day-name { text-align: center; font-size: 11px; color: #b0bec5; font-weight: 700; padding-bottom: 10px; }
        .cal-cell { background: #f7f9fc; border-radius: 10px; height: 55px; display: flex; flex-direction: column; align-items: center; padding-top: 4px; font-size: 12px; position: relative; border: 2px solid transparent; cursor: pointer; min-width: 0; }
        .cal-num { font-weight: 700; font-size: 12px; margin-bottom: 2px; color: #546e7a; }
        .cal-shift { font-size: 9px; text-align: center; line-height: 1.1; width: 100%; overflow: hidden; text-overflow: ellipsis; padding: 0 2px; font-weight: 600;}
        .cal-cell.today { border-color: var(--accent); background: #fff; }
        .cal-cell.today .cal-num { color: var(--accent); }
        .cal-cell.weekend .cal-num { color: var(--col-weekend-txt); }
        .cal-cell.state-holiday { background: var(--col-holiday-bg); border-color: var(--col-holiday-border) !important; }
        .cal-cell.state-holiday.has-shift.type-work { background: var(--col-work-bg); border-color: var(--col-holiday-border); }
        .cal-cell.state-holiday.has-shift.type-work .cal-num { color: var(--col-weekend-txt); font-weight: 900; }
        .cal-cell.state-holiday.today { border-color: var(--accent) !important; box-shadow: 0 0 10px rgba(255, 171, 0, 0.4); }
        .cal-cell.type-work { background: var(--col-work-bg); color: var(--col-work-txt); }
        .cal-cell.type-off { background: white; color: #cfd8dc; }
        .cal-cell.type-sick { background: var(--col-sick-bg) !important; color: #f9a825 !important; border-color: var(--col-sick-border); }
        .cal-cell.type-train { background: var(--col-train-bg) !important; color: var(--col-train-txt) !important; border-color: var(--col-train-border); }
        .cal-cell.type-donor { background: var(--col-donor-bg) !important; color: var(--col-donor-txt) !important; border-color: var(--col-donor-border); }
        .cal-cell.holiday { background: var(--col-holiday-bg); border-color: var(--col-holiday-border); }
        .cal-cell.holiday .cal-num { color: var(--col-weekend-txt); } 
        .cal-cell.holiday.has-shift.type-work { background: var(--col-work-bg); border-color: var(--col-holiday-border); }
        .cal-cell.holiday.has-shift.type-work .cal-num { color: var(--col-weekend-txt); font-weight: 900; }
        .cal-cell.empty { background: transparent; cursor: default; }
        .cal-cell.has-note::after { content: ''; position: absolute; top: 4px; right: 4px; width: 8px; height: 8px; background-color: #ff1744; border-radius: 50%; box-shadow: 0 0 0 1px #fff; border: none;}
        .note-icon { font-size: 14px; margin-left: 6px; cursor: help; text-decoration: none; }
        .cal-cell.type-vacation { background: #fff3e0 !important; color: #e65100 !important; border-color: #ffe0b2 !important; }
        .cal-cell.type-vacation .cal-num { color: #ef6c00 !important; }
        .tag { font-size: 9px; padding: 3px 8px; border-radius: 6px; color: white; font-weight: bold; letter-spacing: 0.5px; display:inline-block; margin-left:2px;}
        .tag.gray { background: #90a4ae; } .tag.orange { background: var(--accent); } .tag.teal { background: #009688; } .tag.indigo { background: #5c6bc0; } .tag.red { background: #e53935; } .tag.purple { background: #7e57c2; }
        .fab-container { position: fixed; bottom: 90px; right: 20px; display: flex; align-items: center; gap: 15px; z-index: 2000; pointer-events: auto; }
        .fab-main { background: var(--accent); color: white; width: 60px; height: 60px; border-radius: 50%; display: flex; justify-content: center; align-items: center; box-shadow: 0 8px 20px rgba(255, 171, 0, 0.4); cursor: pointer; border: none; transition: transform 0.2s; -webkit-tap-highlight-color: transparent; } .fab-main:active { transform: scale(0.9); } .fab-main svg { width: 30px; height: 30px; fill: white; pointer-events: none; }
        .fab-secondary { background: white; color: var(--primary); width: 50px; height: 50px; border-radius: 50%; display: flex; justify-content: center; align-items: center; box-shadow: 0 5px 15px rgba(0,0,0,0.1); cursor: pointer; border: none; transition: transform 0.2s; -webkit-tap-highlight-color: transparent;} .fab-secondary:active { transform: scale(0.9); } .fab-secondary svg { width: 24px; height: 24px; fill: currentColor; pointer-events: none; }
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; height: 70px; background: white; border-top: 1px solid #f0f0f0; display: flex; justify-content: space-around; align-items: center; z-index: 1000; padding-bottom: env(safe-area-inset-bottom); box-shadow: 0 -5px 20px rgba(0,0,0,0.03); }
        .nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--nav-inactive); font-size: 10px; font-weight: 600; width: 100%; height: 100%; cursor: pointer; transition: all 0.2s; } .nav-item.active { color: var(--primary); transform: translateY(-2px); } .nav-item svg { width: 26px; height: 26px; fill: currentColor; margin-bottom: 4px; }
        .chart-container { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px 0; position: relative; }
        .circular-chart { display: block; margin: 0 auto; max-width: 80%; max-height: 250px; }
        .circle-bg { fill: none; stroke: #eee; stroke-width: 3.8; }
        .circle { fill: none; stroke-width: 3.8; stroke-linecap: butt; transition: stroke-dasharray 0.6s ease; }
        .chart-text-group { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -40%); text-align: center; }
        .chart-val { font-size: 32px; font-weight: 800; color: var(--primary); display: block; line-height: 1;}
        .chart-label { font-size: 12px; color: #90a4ae; font-weight: 600; text-transform: uppercase; margin-top: 5px; display: block;}
        .stat-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #f0f0f0; font-size: 14px;} .stat-row:last-child { border-bottom: none; }
        .stat-val { font-weight: 700; color: var(--primary); }
        .stat-sub-val { font-size: 12px; color:#90a4ae; font-weight: 600; margin-right: 8px;}
        .card { background: var(--card); border-radius: 20px; padding: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); margin-bottom: 15px; }
        .month-selector { display: flex; align-items: center; justify-content: center; background: #f0f2f5; border-radius: 12px; padding: 4px 8px; min-width: 160px; gap: 15px; }
        .month-btn { background: none; border: none; padding: 8px; cursor: pointer; color: var(--primary); font-size: 20px; font-weight: bold; flex-shrink: 0; display: flex; align-items: center; justify-content: center; }
        .month-display { font-size: 14px; font-weight: 700; text-align: center; white-space: nowrap; min-width: 110px; }
        input[type="text"], input[type="number"], textarea, select { width: 100%; padding: 14px; border: 1px solid #e0e0e0; border-radius: 12px; box-sizing: border-box; font-size: 16px; margin-top: 8px; background: #f9f9f9; font-family: inherit; font-weight: 500;}
        input:focus, textarea:focus, select:focus { outline: none; border-color: var(--primary); background: white; }
        label { font-size: 11px; color: #78909c; font-weight: 800; text-transform: uppercase; margin-top: 18px; display: block; letter-spacing: 0.5px;}
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(38, 50, 56, 0.8); backdrop-filter: blur(4px); display: none; justify-content: center; align-items: center; z-index: 5000; touch-action: none;}
        #addModal { z-index: 6000; }
        #confirmModal { z-index: 7000; }
        .modal-overlay.open { display: flex; animation: fadeIn 0.2s; }
        .modal-box { background: white; padding: 25px; border-radius: 24px; width: 90%; max-width: 360px; min-width: 300px; box-shadow: 0 20px 60px rgba(0,0,0,0.4); max-height: 85vh; overflow-y: auto; position: relative; z-index: 6001; transform: translate3d(0,0,0);}
        .btn-row { display: flex; justify-content: flex-end; margin-top: 25px; gap: 10px; }
        .btn { padding: 12px 24px; border-radius: 12px; border: none; font-weight: 700; cursor: pointer; font-size: 15px; transition: 0.2s;} .btn:active { transform: scale(0.96); }
        .btn-cancel { background: transparent; color: #78909c; } .btn-save { background: var(--primary); color: white; } .btn-delete { background: #ffebee; color: #d32f2f; }
        .btn-text { background: none; border: none; color: var(--accent); font-size: 11px; font-weight: bold; cursor: pointer; text-decoration: underline; margin-top: 5px; display: block; text-align: right;}
        details { margin-top: 15px; border: 1px solid #eee; border-radius: 12px; padding: 15px; } summary { font-size: 13px; font-weight: 700; color: var(--primary); cursor: pointer; outline: none; }
        .detail-row { display: flex; justify-content: space-between; align-items: center; margin-top: 12px; } .detail-row label { margin: 0; font-size: 13px; color: #455a64; font-weight: 500;} .detail-row input[type="checkbox"] { width: 24px; height: 24px; margin: 0; accent-color: var(--accent);} .detail-row input[type="text"] { width: 90px; padding: 8px; font-size: 14px; margin: 0; } .line-input-row { display: flex; gap: 10px; margin-top: 5px; }
    </style>
</head>
<body>

    <div id="loader">
        <div class="spinner"></div>
        <div class="loader-text">–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è...</div>
    </div>

    <header>
        <h1 id="headerTitle">–ú–æ–∏ —Å–º–µ–Ω—ã</h1>
        <button class="header-btn" onclick="openImportModal()" title="–ò–º–ø–æ—Ä—Ç"><svg viewBox="0 0 24 24"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg></button>
    </header>

    <div id="tab-today" class="page"><div id="todayContent"></div></div>

    <div id="tab-home" class="page active">
        <div id="shiftList"></div>
        <div class="fab-container">
            <button class="fab-secondary" onclick="openCalendarModal()"><svg viewBox="0 0 24 24"><path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20a2 2 0 0 0 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V10h14v10zM9 14H7v-2h2v2zm4 0h-2v-2h2v2zm4 0h-2v-2h2v2zm-8 4H7v-2h2v2zm4 0h-2v-2h2v2zm4 0h-2v-2h2v2z"/></svg></button>
            <button class="fab-main" onclick="openModal()"><svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6V13z"/></svg></button>
        </div>
    </div>
    
    <div id="tab-stats" class="page">
        <div class="card">
            <h3 style="margin-top:0; color:var(--primary); display:flex; justify-content:space-between; align-items:center;">
                <span>üìä –°–≤–æ–¥–∫–∞</span>
                <div class="month-selector">
                    <button class="month-btn" onclick="changeStatsMonth(-1)">&#8249;</button>
                    <div class="month-display" id="statsMonthDisplay"></div>
                    <button class="month-btn" onclick="changeStatsMonth(1)">&#8250;</button>
                    <button class="month-btn" style="color: #e53935; margin-left: 5px;" onclick="wipeCurrentMonth()" title="–û—á–∏—Å—Ç–∏—Ç—å –º–µ—Å—è—Ü">üóëÔ∏è</button>
                </div>
            </h3>
            <div class="chart-container">
                <svg viewBox="0 0 36 36" class="circular-chart">
                    <path class="circle-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                    <path class="circle" stroke="#ffab00" stroke-dasharray="0, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" id="circlePath" />
                    <path class="circle" stroke="#00c853" stroke-dasharray="0, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" id="circlePathOver" style="display:none;" />
                </svg>
                <div class="chart-text-group"><span class="chart-val" id="chartValue">0</span><span class="chart-label">–ß–∞—Å–æ–≤</span></div>
            </div>
            <div class="stat-row"><span>–ù–æ—Ä–º–∞:</span> <span class="stat-val" id="st_norm">0</span></div>
            <div class="stat-row"><span>–û—Ç—Ä–∞–±–æ—Ç–∞–Ω–æ:</span> <span class="stat-val" id="st_hours">0</span></div>
            <div class="stat-row" style="background:#fff3e0; margin:0 -10px; padding:10px; border-radius:8px; margin-bottom:5px;"><span>–ü–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∞:</span> <span class="stat-val" id="st_over" style="font-size:16px;">0</span></div>
        </div>
        <div class="card">
            <h3 style="margin-top:0; color:var(--primary)">üí∞ –†–∞—Å—á–µ—Ç</h3>

            <div class="stat-row" id="row_tariff"><span>–û–ø–ª–∞—Ç–∞ –ø–æ —Ç–∞—Ä–∏—Ñ—É:</span> <span class="stat-val" id="st_tariff_money">0 ‚ÇΩ</span></div>
            <div class="stat-row" id="row_res"><span>–†–µ–∑–µ—Ä–≤:</span> <span class="stat-val" id="st_res_money">0 ‚ÇΩ</span></div>
           
            <div class="stat-row" id="row_ev"><span>–í–µ—á–µ—Ä–Ω–∏–µ (20%):</span> <div style="text-align:right"><span class="stat-sub-val" id="st_ev_hours">0—á</span><span class="stat-val" id="st_ev_money">0 ‚ÇΩ</span></div></div>
            <div class="stat-row" id="row_night"><span>–ù–æ—á–Ω—ã–µ (40%):</span> <div style="text-align:right"><span class="stat-sub-val" id="st_night_hours">0—á</span><span class="stat-val" id="st_night_money">0 ‚ÇΩ</span></div></div>
            <div class="stat-row" id="row_split"><span>–†–∞–∑—Ä—ã–≤–Ω—ã–µ (30%):</span> <div style="text-align:right"><span class="stat-sub-val" id="st_split_hours">0—á</span><span class="stat-val" id="st_split_money">0 ‚ÇΩ</span></div></div>
            <div class="stat-row" id="row_holiday" style="display:none;"><span>–ü—Ä–∞–∑–¥–Ω–∏—á–Ω—ã–µ (x2):</span> <div style="text-align:right"><span class="stat-sub-val" id="st_holiday_hours">0—á</span><span class="stat-val" id="st_holiday_money">0 ‚ÇΩ</span></div></div>
            <div class="stat-row" id="row_ot15"><span>–ü–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∞ (1.5—Ö):</span> <div style="text-align:right"><span class="stat-sub-val" id="st_ot15_hours">0—á</span><span class="stat-val" id="st_ot15_money">0 ‚ÇΩ</span></div></div>
            <div class="stat-row" id="row_ot20"><span>–ü–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∞ (2.0—Ö):</span> <div style="text-align:right"><span class="stat-sub-val" id="st_ot20_hours">0—á</span><span class="stat-val" id="st_ot20_money">0 ‚ÇΩ</span></div></div>

            <div style="margin-top:5px;"></div> 

            <div class="stat-row" id="row_sick" style="display:none;">
                <span>üöë –ë–æ–ª—å–Ω–∏—á–Ω—ã–π:</span> 
                <div style="text-align:right">
                    <span class="stat-sub-val" id="st_sick_days">0 –¥–Ω.</span>
                    <span class="stat-val" id="st_sick_money">0 ‚ÇΩ</span>
                </div>
            </div>
            <div class="stat-row" id="row_vacation" style="display:none;"><span>üèñÔ∏è –û—Ç–ø—É—Å–∫–Ω—ã–µ:</span> <span class="stat-val" id="st_vacation_money">0 ‚ÇΩ</span></div>
            <div class="stat-row" id="row_donor" style="display:none;"><span>ü©∏ –î–æ–Ω–æ—Ä—Å–∫–∏–µ:</span> <span class="stat-val" id="st_donor_money">0 ‚ÇΩ</span></div>
            <div class="stat-row" id="row_med" style="display:none;"><span>ü©∫ –ú–µ–¥. –∫–æ–º–∏—Å—Å–∏—è:</span> <span class="stat-val" id="st_med_money">0 ‚ÇΩ</span></div>
            <div class="stat-row" id="row_study" style="display:none;"><span>üéì –£—á–µ–±–∞ (–£–ü–¶):</span> <span class="stat-val" id="st_study_money">0 ‚ÇΩ</span></div>

            <div style="border-top:1px solid #eee; margin:8px 0;"></div>

            <div class="stat-row" id="row_class"><span id="lbl_class">–ö–ª–∞—Å—Å–Ω–æ—Å—Ç—å:</span> <span class="stat-val" id="st_class_money">0 ‚ÇΩ</span></div>
            <div class="stat-row" id="row_sen"><span id="lbl_sen">–í—ã—Å–ª—É–≥–∞:</span> <span class="stat-val" id="st_sen_money">0 ‚ÇΩ</span></div>
            <div class="stat-row" id="row_senior" style="display:none;"><span id="lbl_senior">–°—Ç. –º–∞—à–∏–Ω–∏—Å—Ç:</span> <span class="stat-val" id="st_senior_money">0 ‚ÇΩ</span></div>
            <div class="stat-row" id="row_mentor" style="display:none;"><span id="lbl_mentor">–ù–∞—Å—Ç–∞–≤–Ω–∏–∫:</span> <div style="text-align:right"><span class="stat-sub-val" id="st_mentor_hours">0—á</span><span class="stat-val" id="st_mentor_money">0 ‚ÇΩ</span></div></div>

            <div class="stat-row" id="row_prem"><span id="lbl_prem">–ü—Ä–µ–º–∏—è:</span> <span class="stat-val" id="st_prem_money">0 ‚ÇΩ</span></div>
            <div class="stat-row" id="row_tech" style="display:none;"><span>–¢–µ—Ö. —É—á–µ–±–∞:</span> <span class="stat-val" id="st_tech_money">0 ‚ÇΩ</span></div>
            
            <div style="border-top:2px solid #eee; margin:10px 0;"></div>

            <div class="stat-row"><span>–ù–∞—á–∏—Å–ª–µ–Ω–æ:</span> <span class="stat-val" id="st_dirty">0 ‚ÇΩ</span></div>
            <div class="stat-row"><span>–ü—Ä–æ—Ñ—Å–æ—é–∑ (1%):</span> <span class="stat-val" id="st_union" style="color:#e53935">0 ‚ÇΩ</span></div>
            <div class="stat-row"><span id="lbl_tax">–ù–∞–ª–æ–≥ (13%):</span> <span class="stat-val" id="st_tax" style="color:#e57373">0 ‚ÇΩ</span></div>
            <div id="rich_alert" style="text-align:right; font-size:10px; color:#d32f2f; font-weight:800; display:none; margin-top:-8px; margin-bottom:8px; opacity:0.8;"></div>

            <div class="stat-row" id="row_bonus_base">
                <span style="color:#90a4ae;">üè¶ –°—É–º–º–∞ –¥–ª—è –≥–æ–¥–æ–≤–æ–π –ø—Ä–µ–º–∏–∏:</span> 
                <span class="stat-val" id="st_bonus_base">0 ‚ÇΩ</span>
            </div>

            <div class="stat-row" style="font-size:20px; border-top:2px solid #eee; margin-top:10px; padding-top:15px"><span>–ù–∞ —Ä—É–∫–∏:</span> <span class="stat-val" id="st_net" style="color:#2e7d32">0 ‚ÇΩ</span></div>
        </div>
    </div>

    <div id="tab-settings" class="page">
        <div class="card">
            <h3 style="margin-top:0; color:var(--primary)">‚öôÔ∏è –ü—Ä–æ—Ñ–∏–ª—å</h3>
            <label>–¢–∞—Ä–∏—Ñ (–û—Å–Ω–æ–≤–Ω–æ–π)</label><input type="text" inputmode="decimal" id="set_rate" onchange="saveAll()">
            <label>–ö–ª–∞—Å—Å –∫–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏–∏</label><select id="set_class" onchange="saveAll()"><option value="0">–ë–µ–∑ –∫–ª–∞—Å—Å–∞</option><option value="30">1 –∫–ª–∞—Å—Å (30%)</option><option value="20">2 –∫–ª–∞—Å—Å (20%)</option><option value="10">3 –∫–ª–∞—Å—Å (10%)</option></select>
            <label>–î–∞—Ç–∞ —Ç—Ä—É–¥–æ—É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</label><input type="date" id="set_start_date" onchange="saveAll()">
            <div style="font-size:13px; color:var(--primary); margin-top:8px; text-align:right; font-weight:600;" id="set_exp_text"></div>
            <label>–ü—Ä–µ–º–∏—è (%)</label><input type="text" inputmode="decimal" id="set_prem" onchange="saveAll()">
            <div style="margin-top:25px; display:flex; align-items:center; padding:12px; background:#e3f2fd; border-radius:12px;"><input type="checkbox" id="set_mentor" style="width:24px; height:24px; margin:0;" onchange="saveAll()"><span style="margin-left:12px; font-weight:700; color:#1565c0; font-size:14px;">–ù–∞—Å—Ç–∞–≤–Ω–∏–∫ (+15%)</span></div>
            <div style="margin-top:10px; display:flex; align-items:center; padding:12px; background:#e3f2fd; border-radius:12px;"><input type="checkbox" id="set_senior" style="width:24px; height:24px; margin:0;" onchange="saveAll()"><span style="margin-left:12px; font-weight:700; color:#1565c0; font-size:14px;">–°—Ç. –º–∞—à–∏–Ω–∏—Å—Ç (+10%)</span></div>
            <div style="margin-top:10px; display:flex; align-items:center; padding:12px; background:#e3f2fd; border-radius:12px;"><input type="checkbox" id="set_union" style="width:24px; height:24px; margin:0;" onchange="saveAll()"><span style="margin-left:12px; font-weight:700; color:#1565c0; font-size:14px;">–ß–ª–µ–Ω –ø—Ä–æ—Ñ—Å–æ—é–∑–∞ (-1%)</span></div>
            
            <div style="margin-top:30px; padding:15px; background:#fff3e0; border-radius:12px; text-align:center;">
                <div id="cloudStatus" style="font-size:12px; font-weight:bold; color:#f57c00; margin-bottom:10px;">–°—Ç–∞—Ç—É—Å –æ–±–ª–∞–∫–∞: –ü—Ä–æ–≤–µ—Ä–∫–∞...</div>
                <button onclick="forcePushToCloud()" style="background:#ff9800; color:white; border:none; padding:10px 15px; border-radius:10px; font-weight:bold; width:100%;">üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ –û–±–ª–∞–∫–æ</button>
                <div style="font-size:10px; color:#8d6e63; margin-top:5px;">–ù–∞–∂–º–∏, –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ –µ—Å—Ç—å, –∞ –Ω–∞ –ü–ö –Ω–µ—Ç.</div>
            </div>
        </div>
        <div class="card" style="background: linear-gradient(135deg, #263238 0%, #37474f 100%); color: white; text-align: center; margin-top: 15px;">
            <h3 style="margin-top:0; margin-bottom: 8px; color:white; font-size: 16px;">ü§ù –†–∞–∑–≤–∏—Ç–∏–µ –ø—Ä–æ–µ–∫—Ç–∞</h3>
            <div style="font-size:12px; opacity:0.8; margin-bottom:15px; line-height: 1.4;">
                –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –±–µ—Å–ø–ª–∞—Ç–Ω–æ–µ. –ï—Å–ª–∏ –æ–Ω–æ –ø–æ–º–æ–≥–∞–µ—Ç –≤ —Ä–∞–±–æ—Ç–µ ‚Äî –±—É–¥—É –±–ª–∞–≥–æ–¥–∞—Ä–µ–Ω –∑–∞ –ø–æ–¥–¥–µ—Ä–∂–∫—É.
            </div>
            <button onclick="openDonation()" style="background: var(--accent); color: white; border: none; padding: 12px 20px; border-radius: 12px; font-weight: 800; width: 100%; font-size: 14px; box-shadow: 0 4px 15px rgba(255, 171, 0, 0.3);">
                –ü–æ–¥–¥–µ—Ä–∂–∞—Ç—å
            </button>
        </div>
        <div style="text-align:center; font-size:11px; color:#b0bec5; margin-top:20px;">–ì—Ä–∞—Ñ–∏–∫–ë—Ä–æ v1.1 (Fix)</div>
    </div>

    <div class="modal-overlay" id="addModal">
        <div class="modal-box">
            <h3 style="margin-top:0; color:var(--primary)" id="modalTitle">–ù–æ–≤–∞—è —Å–º–µ–Ω–∞</h3>
            <label>–î–∞—Ç–∞</label><input type="date" id="inpDate">
            <label>–¢–µ–∫—Å—Ç –∏–∑ –≥—Ä–∞—Ñ–∏–∫–∞</label>
            <div style="position: relative; display: flex; align-items: center;">
                <input type="text" id="inpText" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –º75 14:00-22:00 –∏–ª–∏ –ë–õ" oninput="checkShiftText()" style="padding-right: 40px; margin-top: 8px;">
                <button onclick="pasteFromClipboard()" title="–í—Å—Ç–∞–≤–∏—Ç—å" style="position: absolute; right: 5px; top: 50%; transform: translateY(-30%); background: none; border: none; cursor: pointer; font-size: 18px; padding: 5px; z-index: 10;">üìã</button>
            </div>
            <label>–ó–∞–º–µ—Ç–∫–∞</label><textarea id="inpNote" rows="2" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –∑–∞–π—Ç–∏ –≤ –∫–∞–¥—Ä—ã, –Ω–æ–º–µ—Ä–∞ –≤–∞–≥–æ–Ω–æ–≤..."></textarea>
            
            <div id="sickDetailsBox" style="display:none; background:#e8f5e9; padding:15px; border-radius:12px; margin-top:15px; border:1px solid #c8e6c9;">
                <h4 style="margin:0 0 10px 0; color:#2e7d32;">üöë –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –±–æ–ª—å–Ω–∏—á–Ω–æ–≥–æ</h4>
                <label id="lbl_year_1">–î–æ—Ö–æ–¥ –∑–∞ –ø—Ä–æ—à–ª—ã–π –≥–æ–¥</label><input type="text" inputmode="decimal" id="sickInc1">
                <label id="lbl_year_2">–î–æ—Ö–æ–¥ –∑–∞ –ø–æ–∑–∞–ø—Ä–æ—à–ª—ã–π –≥–æ–¥</label><input type="text" inputmode="decimal" id="sickInc2">
                <label>–°—Ç–∞–∂</label><select id="sickPercent"><option value="100">100%</option><option value="80">80%</option><option value="60">60%</option></select>
            </div>

            <details id="shiftDetailsBox">
                <summary>‚öôÔ∏è –ü–∞—Ä–∞–º–µ—Ç—Ä—ã</summary>
                <div class="detail-row"><label>–°—Ç–∞–≤–∫–∞ (‚ÇΩ/—á–∞—Å)</label><input type="text" inputmode="decimal" id="shiftRate"></div>
                <div id="rateHint" style="display:none; font-size:9px; color:#ef6c00; margin-top:4px; font-weight:700;">üìâ –†–µ–∑–µ—Ä–≤ (–≤—Ä–µ–¥–Ω–æ—Å—Ç—å 8%)</div>
                <div class="detail-row"><label>–ü—Ä–µ–º–∏—è (%)</label><input type="text" inputmode="decimal" id="shiftPrem"></div>
                <div class="detail-row"><label>–ö–ª–∞—Å—Å</label><select id="shiftClassSelect"><option value="0">–ë–µ–∑ –∫–ª–∞—Å—Å–∞</option><option value="30">1 –∫–ª–∞—Å—Å</option><option value="20">2 –∫–ª–∞—Å—Å</option><option value="10">3 –∫–ª–∞—Å—Å</option></select></div>
                <div id="lineWorkContainer" style="display:none;"><div class="line-input-row" style="margin-top:15px;"><input type="time" id="lineStart"><span style="align-self:center">-</span><input type="time" id="lineEnd"></div><div style="font-size:10px; color:#90a4ae; margin-top:5px;">–í—Ä–µ–º—è –Ω–∞ –ª–∏–Ω–∏–∏</div></div>
                <div style="margin-top:15px; background:#e3f2fd; padding:10px; border-radius:12px; border:1px solid #bbdefb;">
                    <label style="color:#1565c0; margin-top:0; font-size:12px; font-weight:800; display:block; margin-bottom:5px;">üè• –¢–ü / –û—Ç—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ</label>
                    <div class="line-input-row"><input type="time" id="tpStart"><span style="align-self:center">-</span><input type="time" id="tpEnd"></div>
                    <div class="detail-row" style="margin-top:8px;"><label style="color:#c62828; font-weight:bold; font-size:12px;">‚õî –ü–æ–ª–Ω–æ–µ —Å–Ω—è—Ç–∏–µ</label><input type="checkbox" id="shiftFullMedical" style="width:20px; height:20px; margin:0;"></div>
                </div>
                <div class="detail-row" style="margin-top:15px;"><label style="flex:1;">–¢–µ—Ö. —É—á–µ–±–∞</label><input type="checkbox" id="shiftTech"></div>
                <div class="detail-row"><label style="flex:1;">–ü–æ—Å–ª–µ—Ä–µ–π—Å–æ–≤—ã–π</label><input type="checkbox" id="shiftPostTrip"></div>
                <div class="detail-row" style="margin-top:15px;"><label>–ù–∞—Å—Ç–∞–≤–Ω–∏–∫</label><input type="checkbox" id="shiftMentor"></div>
                <div class="detail-row"><label>–°—Ç. –ú–∞—à–∏–Ω–∏—Å—Ç</label><input type="checkbox" id="shiftSenior"></div>
            </details>

            <div class="btn-row">
                <button class="btn btn-delete" id="btnDeleteShift" onclick="deleteCurrentShift()" style="display:none; margin-right:auto;">–£–¥–∞–ª–∏—Ç—å</button>
                <button class="btn btn-cancel" onclick="closeModal('addModal')">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn btn-save" id="btnSaveShift" onclick="addShift()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>
    <div class="modal-overlay" id="confirmModal"><div class="modal-box"><h3 style="margin-top:0">–£–¥–∞–ª–µ–Ω–∏–µ</h3><div>–¢–æ—á–Ω–æ —É–¥–∞–ª–∏—Ç—å?</div><div class="btn-row"><button class="btn btn-cancel" onclick="closeModal('confirmModal')">–ù–µ—Ç</button><button class="btn btn-delete" onclick="commitDelete()">–î–∞</button></div></div></div>
    <div class="modal-overlay" id="importModal"><div class="modal-box"><h3 style="margin-top:0">–ò–º–ø–æ—Ä—Ç</h3><textarea id="importText" rows="8"></textarea><div class="btn-row"><button class="btn btn-cancel" onclick="closeModal('importModal')">–û—Ç–º–µ–Ω–∞</button><button class="btn btn-save" onclick="processImport()">–û–ö</button></div></div></div>
    <div class="modal-overlay" id="calendarModal"><div class="modal-box" style="max-width: 400px;" id="calModalBox"><div class="cal-header"><button class="cal-btn" onclick="changeMonth(-1)">&#8249;</button><div class="cal-title" id="calTitle"></div><button class="cal-btn" onclick="changeMonth(1)">&#8250;</button></div><div class="cal-grid" id="calGrid"></div><div class="btn-row"><button class="btn btn-cancel" onclick="closeModal('calendarModal')">–ó–∞–∫—Ä—ã—Ç—å</button></div></div></div>

    <nav class="bottom-nav">
        <div class="nav-item" id="nav-today" onclick="switchTab('today')"><svg viewBox="0 0 24 24"><path d="M13 3c-4.97 0-9 4.03-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42C8.27 19.99 10.51 21 13 21c4.97 0 9-4.03 9-9s-4.03-9-9-9zm-1 5v5l4.28 2.54.72-1.21-3.5-2.08V8H12z"/></svg><span>–°–µ–≥–æ–¥–Ω—è</span></div>
        <div class="nav-item active" id="nav-home" onclick="switchTab('home')"><svg viewBox="0 0 24 24"><path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20a2 2 0 0 0 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V10h14v10zM9 14H7v-2h2v2zm4 0h-2v-2h2v2zm4 0h-2v-2h2v2zm-8 4H7v-2h2v2zm4 0h-2v-2h2v2zm4 0h-2v-2h2v2z"/></svg><span>–ö–∞–ª–µ–Ω–¥–∞—Ä—å</span></div>
        <div class="nav-item" onclick="switchTab('stats')"><svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/></svg><span>–°–≤–æ–¥–∫–∞</span></div>
        <div class="nav-item" onclick="switchTab('settings')"><svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/></svg><span>–ü—Ä–æ—Ñ–∏–ª—å</span></div>
    </nav>

    <script src="calc_logic.js"></script>
    <script src="calculator.js"></script>

    <script>
        // --- –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ---
        let shifts = JSON.parse(localStorage.getItem('metro_shifts')) || [];
        let settings = JSON.parse(localStorage.getItem('metro_settings')) || { 
            rate: 546.18, classP: 0, premP: 35, mentor: false, senior: false, 
            startDate: "", union: true, sickData: {}, sickPercent: 100 
        };
        let syncMeta = JSON.parse(localStorage.getItem('metro_sync_meta')) || {};
        let calDate = new Date();
        let statsDate = new Date();
        let preventRender = false;
        let isFirstLoad = true;
        const tg = window.Telegram.WebApp;

        // --- –§–£–ù–ö–¶–ò–ò-–û–ë–ï–†–¢–ö–ò (–ú–´ –£–ë–†–ê–õ–ò –î–£–ë–õ–ò–†–£–Æ–©–£–Æ –õ–û–ì–ò–ö–£) ---
        
        function calcShift(shiftRaw) {
            if (!shiftRaw || !shiftRaw.text) return null;
            
            // 1. –ü–∞—Ä—Å–∏–º —Ç–µ–∫—Å—Ç (Logic)
            let parsed = Logic.parseShift(shiftRaw.text, shiftRaw.date);
            
            // 2. –ü–µ—Ä–µ–Ω–æ—Å–∏–º —Ñ–ª–∞–≥–∏, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥–ª–∏ –±—ã—Ç—å –ø–æ—Å—á–∏—Ç–∞–Ω—ã —Ä–∞–Ω–µ–µ
            // (–ù–æ –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏ –ª—É—á—à–µ —Å—á–∏—Ç–∞—Ç—å –≤—Å—ë –∑–¥–µ—Å—å)
            
            // 3. –ü–æ–¥—Ç—è–≥–∏–≤–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Å–º–µ–Ω—ã
            let effectiveSettings = JSON.parse(JSON.stringify(settings));
            if (shiftRaw.customRate !== undefined) effectiveSettings.rate = shiftRaw.customRate;
            if (shiftRaw.customClass !== undefined) effectiveSettings.classP = shiftRaw.customClass;
            if (shiftRaw.customPrem !== undefined) effectiveSettings.premP = shiftRaw.customPrem;
            if (shiftRaw.customMentor !== undefined) effectiveSettings.mentor = shiftRaw.customMentor;
            if (shiftRaw.customSenior !== undefined) effectiveSettings.senior = shiftRaw.customSenior;

            // 4. –ü–µ—Ä–µ–¥–∞–µ–º —Ä—É—á–Ω—ã–µ —É—Ç–æ—á–Ω–µ–Ω–∏—è
            parsed.lineStart = shiftRaw.lineStart;
            parsed.lineEnd = shiftRaw.lineEnd;
            parsed.tpStart = shiftRaw.tpStart;
            parsed.tpEnd = shiftRaw.tpEnd;
            parsed.isFullMedical = (shiftRaw.isFullMedical === true);
            parsed.isTech = (shiftRaw.isTech === true);
            parsed.isPostTrip = (shiftRaw.isPostTrip === true);

            // 5. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä
            return Calculator.calculateShift(parsed, effectiveSettings);
        }

        function calculateRestIntervals() {
            // –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è —Ç–µ–ø–µ—Ä—å –ø—Ä–æ—Å—Ç–æ –≤—ã–∑—ã–≤–∞–µ—Ç –ª–æ–≥–∏–∫—É –∏–∑ calc_logic.js, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
            // –ù–æ calc_logic.js —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –º–∞—Å—Å–∏–≤–æ–º.
            // –ü–æ–∫–∞ –æ—Å—Ç–∞–≤–∏–º –ø—É—Å—Ç—ã–º, —Ç–∞–∫ –∫–∞–∫ calculator.js —Å—á–∏—Ç–∞–µ—Ç —Å–º–µ–Ω—É –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ,
            // –ê –ø—Ä–∞–≤–∏–ª–æ 50% –º—ã –º–æ–∂–µ–º —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø–æ–∑–∂–µ, –µ—Å–ª–∏ –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è —Å—É–ø–µ—Ä-—Ç–æ—á–Ω–æ—Å—Ç—å.
            // –î–ª—è "–ó–µ–ª–µ–Ω–æ–π –∑–æ–Ω—ã" (–ø–æ –∫–≤–∏—Ç–∫—É) —ç—Ç–æ –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ.
        }

        // --- –†–ï–ù–î–ï–† –°–í–û–î–ö–ò (–ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô) ---
        function renderStats() {
            // 1. –ó–∞–≥–æ–ª–æ–≤–æ–∫ –º–µ—Å—è—Ü–∞
            const year = statsDate.getFullYear();
            const month = statsDate.getMonth();
            const monthNames = ["–Ø–Ω–≤–∞—Ä—å", "–§–µ–≤—Ä–∞–ª—å", "–ú–∞—Ä—Ç", "–ê–ø—Ä–µ–ª—å", "–ú–∞–π", "–ò—é–Ω—å", "–ò—é–ª—å", "–ê–≤–≥—É—Å—Ç", "–°–µ–Ω—Ç—è–±—Ä—å", "–û–∫—Ç—è–±—Ä—å", "–ù–æ—è–±—Ä—å", "–î–µ–∫–∞–±—Ä—å"];
            document.getElementById('statsMonthDisplay').innerText = `${monthNames[month]} ${year}`;

            // 2. –§–∏–ª—å—Ç—Ä —Å–º–µ–Ω
            const monthlyShifts = shifts.filter(s => {
                const d = new Date(s.date);
                return d.getFullYear() === year && d.getMonth() === month;
            });

            // 3. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
            let totalHours = 0; // –§–∞–∫—Ç (–¥–ª—è –∫—Ä—É–≥–∞)
            let dirty = 0;
            
            // --- –ù–û–í–´–ô –ü–û–î–•–û–î: –ü–†–Ø–ú–û–ï –°–£–ú–ú–ò–†–û–í–ê–ù–ò–ï –ò–ó CALCULATOR.JS ---
            // –ú—ã —Å–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç-–∞–∫–∫—É–º—É–ª—è—Ç–æ—Ä, –ø–æ–≤—Ç–æ—Ä—è—é—â–∏–π —Å—Ç—Ä—É–∫—Ç—É—Ä—É details
            let acc = {
                tariffLine: 0, tariffRes: 0, tariffBase: 0,
                split: 0, ev: 0, night: 0,
                class: 0, senior: 0, mentor: 0, tech: 0, prem: 0,
                sick: 0, vacation: 0, donor: 0, med: 0, study: 0
            };
            
            let sickDeduction = 0; // –î–ª—è —Å–Ω–∏–∂–µ–Ω–∏—è –Ω–æ—Ä–º—ã

            monthlyShifts.forEach(s => {
                const res = calcShift(s);
                if (!res) return;

                // –°–Ω–∏–∂–µ–Ω–∏–µ –Ω–æ—Ä–º—ã (–ë–õ, –û—Ç–ø—É—Å–∫)
                if (res.isSick || res.isVacation || (res.isDonor && !Logic.isWeekendOrHoliday(new Date(s.date)))) {
                    if (!Logic.isWeekendOrHoliday(new Date(s.date))) {
                        sickDeduction += 7.2;
                    }
                }

                // –°—É–º–º–∏—Ä—É–µ–º –¥–µ–Ω—å–≥–∏ "–ì—Ä—è–∑–Ω—ã–º–∏" (–æ–±—â–∞—è –∫—É—á–∞)
                if (res.dirty) dirty += res.dirty;

                // –°—É–º–º–∏—Ä—É–µ–º —á–∞—Å—ã (–§–∞–∫—Ç)
                // –í–ù–ò–ú–ê–ù–ò–ï: –î–ª—è –≥—Ä–∞—Ñ–∏–∫–∞ –±–µ—Ä–µ–º —á–∞—Å—ã —Ç–æ–ª—å–∫–æ –†–ê–ë–û–ß–ò–• —Å–º–µ–Ω (–≥–¥–µ –ø–ª–∞—Ç—è—Ç —Ç–∞—Ä–∏—Ñ)
                if (!res.isSick && !res.isVacation && !res.isDonor) {
                    totalHours += (res.hours || 0);
                }

                // –°—É–º–º–∏—Ä—É–µ–º –¥–µ—Ç–∞–ª–∏ (–µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å)
                if (res.parts) {
                    acc.tariffLine += (res.parts.tariffLine.m || 0);
                    acc.tariffRes += (res.parts.tariffRes.m || 0);
                    acc.tariffBase += (res.parts.tariffBase.m || 0);
                    
                    acc.split += (res.parts.splitLine.m + res.parts.splitRes.m + res.parts.splitBase.m);
                    
                    acc.ev += (res.parts.evLine.m + res.parts.evRes.m + res.parts.evBase.m);
                    acc.night += (res.parts.nightLine.m + res.parts.nightRes.m + res.parts.nightBase.m);
                    
                    acc.class += (res.parts.class || 0);
                    acc.senior += (res.parts.senior || 0);
                    acc.mentor += (res.parts.mentor || 0);
                    acc.tech += (res.parts.tech || 0);
                    
                    acc.med += (res.parts.med || 0);
                    acc.study += (res.parts.study || 0);
                }
                
                // –°–ø–µ—Ü. —Ç–∏–ø—ã (–¥–µ–Ω—å–≥–∏ –ª–µ–∂–∞—Ç –≤ dirty, –Ω–æ –¥–ª—è –∫—Ä–∞—Å–æ—Ç—ã —Ä–∞–∑–ª–æ–∂–∏–º)
                if (res.isSick) acc.sick += res.dirty;
                if (res.isVacation) acc.vacation += res.dirty;
                if (res.isDonor) acc.donor += res.dirty;
            });

            // 4. –†–∞—Å—á–µ—Ç –ù–æ—Ä–º—ã –∏ –ü–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∏
            let norm = Logic.getMonthNorm(year, month);
            if (sickDeduction > 0) norm -= sickDeduction;
            norm = Math.max(0, parseFloat(norm.toFixed(1)));
            
            const overtime = Math.max(0, totalHours - norm);
            
            // –†–∞—Å—á–µ—Ç –¥–æ–ø–ª–∞—Ç—ã –∑–∞ –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫—É
            const otPay = Calculator.calculateOvertimePay(overtime, settings);
            dirty += otPay.total; // –î–æ–±–∞–≤–ª—è–µ–º –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫—É –∫ –∏—Ç–æ–≥—É

            // 5. –†–∞—Å—á–µ—Ç –ü–†–ï–ú–ò–ò (–ó–¥–µ—Å—å, –≤ –∫–æ–Ω—Ü–µ –º–µ—Å—è—Ü–∞!)
            // –ë–∞–∑–∞: –¢–∞—Ä–∏—Ñ—ã + –†–∞–∑—Ä—ã–≤ + –ù–æ—á—å/–í–µ—á–µ—Ä + –ö–ª–∞—Å—Å + –ë—Ä–∏–≥–∞–¥–∏—Ä
            const bonusBase = 
                acc.tariffLine + acc.tariffRes + acc.tariffBase +
                acc.split +
                acc.ev + acc.night +
                acc.class + acc.senior;
            
            // –ï—Å–ª–∏ –±—ã–ª–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–º–µ–Ω—ã, –±–µ—Ä–µ–º —Å—Ä–µ–¥–Ω–∏–π –∏–ª–∏ –ø–æ—Å–ª–µ–¥–Ω–∏–π? 
            // –î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –±–µ—Ä–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π % (–∏–ª–∏ –º–æ–∂–Ω–æ —É—Å–ª–æ–∂–Ω–∏—Ç—å)
            const premMoney = bonusBase * (settings.premP / 100);
            
            // –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–µ–º–∏—é –≤ –æ–±—â—É—é –∫—É—á—É
            dirty += premMoney;
            acc.prem = premMoney; // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è

            // 6. –ù–∞–ª–æ–≥–∏
            const union = settings.union ? (dirty * 0.01) : 0;
            const tax = dirty * 0.13;
            const net = dirty - union - tax;

            // 7. –í–´–í–û–î –ù–ê –≠–ö–†–ê–ù (DOM)
            document.getElementById('st_norm').innerText = norm + ' —á';
            document.getElementById('st_hours').innerText = totalHours.toFixed(1) + ' —á';
            
            const overEl = document.getElementById('st_over');
            overEl.innerText = (overtime > 0 ? "+" : "") + overtime.toFixed(1);
            overEl.style.color = overtime > 0 ? "#2e7d32" : "#90a4ae";

            // –ö—Ä—É–≥
            const percent = (norm > 0) ? (totalHours / norm) * 100 : 0;
            drawProgress(percent, totalHours);

            // –¢–∞–±–ª–∏—Ü–∞ (—Ñ—É–Ω–∫—Ü–∏—è helper)
            const row = (id, val) => {
                const el = document.getElementById(id);
                if(el) {
                    el.style.display = (val > 1) ? 'flex' : 'none';
                    const vEl = el.querySelector('.stat-val');
                    if(vEl) vEl.innerText = fmtMoney(val);
                }
            };

            row('row_tariff', acc.tariffLine);
            row('row_res', acc.tariffRes + acc.tariffBase); // –†–µ–∑–µ—Ä–≤ + –ë–∞–∑–∞
            row('row_split', acc.split);
            
            // –ü–†–ï–ú–ò–Ø (–í—Å—Ç–∞–≤–ª—è–µ–º –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ)
            const elPrem = document.getElementById('st_prem_money');
            if(elPrem) elPrem.innerText = fmtMoney(acc.prem);
            // –ï—Å–ª–∏ 0, –º–æ–∂–Ω–æ —Å–∫—Ä—ã—Ç—å —Å—Ç—Ä–æ–∫—É, –Ω–æ –ª—É—á—à–µ –æ—Å—Ç–∞–≤–∏—Ç—å
            
            row('row_ev', acc.ev);
            row('row_night', acc.night);
            
            row('row_class', acc.class);
            row('row_senior', acc.senior);
            row('row_mentor', acc.mentor); // –ö—Ä–∞—Å–Ω–∞—è –∑–æ–Ω–∞ (–≤–Ω–∏–∑—É)
            row('row_tech', acc.tech);
            
            row('row_ot15', otPay.total); // –ü–æ–∫–∞ –ø—Ä–æ—Å—Ç–æ –æ–±—â–∞—è —Å—É–º–º–∞
            
            // –°–ø–µ—Ü. —Ç–∏–ø—ã
            row('row_sick', acc.sick);
            row('row_vacation', acc.vacation);
            row('row_donor', acc.donor);
            row('row_med', acc.med);
            row('row_study', acc.study);

            // –ò—Ç–æ–≥–∏
            document.getElementById('st_dirty').innerText = fmtMoney(dirty);
            document.getElementById('st_union').innerText = '-' + fmtMoney(union);
            document.getElementById('st_tax').innerText = '-' + fmtMoney(tax);
            document.getElementById('st_net').innerText = fmtMoney(net);
            
            // –ë–∞–∑–∞ –¥–ª—è 13-–π (–ì—Ä—è–∑–Ω—ã–µ –º–∏–Ω—É—Å –∫—Ä–∞—Å–Ω–∞—è –∑–æ–Ω–∞)
            const yearBase = dirty - acc.mentor - acc.sick - acc.vacation - acc.donor - acc.med - acc.study - acc.tech;
            document.getElementById('st_bonus_base').innerText = fmtMoney(yearBase);
        }

        // --- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (–æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å) ---
        function touchMeta(key) { syncMeta[key] = new Date().getTime(); localStorage.setItem('metro_sync_meta', JSON.stringify(syncMeta)); }
        function getMonthKey(dateStr) { if (!dateStr) return null; return `s_${dateStr.substring(0, 4)}_${dateStr.substring(5, 7)}`; }
        function safeFloat(val) { if (!val) return 0; let n = parseFloat(String(val).replace(/\s/g, '').replace(',', '.')); return isFinite(n) ? n : 0; }
        function getIsoDate(d) { if(!d) return ""; const y = d.getFullYear(); const m = String(d.getMonth()+1).padStart(2,'0'); const day = String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${day}`; }
        function fmtMoney(val) { return Math.round(val || 0).toLocaleString() + ' ‚ÇΩ'; }
        function updateCloudStatus(msg, err) { const el = document.getElementById('cloudStatus'); if(el) { el.innerText = "–û–±–ª–∞–∫–æ: " + msg; el.style.color = err ? "#e53935" : "#2e7d32"; } }
        function showLoader() { document.getElementById('loader').classList.add('loader-active'); }
        function hideLoader() { document.getElementById('loader').classList.remove('loader-active'); }
        function normalizeOne(s) { 
            if(s.d) return { date: s.d, text: s.t, note: s.n, customRate: s.cr, customMentor: s.cm, customSenior: s.cs, customClass: s.cc, customSen: s.ce, customPrem: s.cp, lineStart: s.ls, lineEnd: s.le, tpStart: s.tps, tpEnd: s.tpe, isTech: !!s.it, isPostTrip: !!s.ip, isFullMedical: !!s.ifm }; 
            if(s.isMedical) { s.isFullMedical = true; delete s.isMedical; } return s; 
        }
        function normalizeShifts() { shifts = shifts.map(normalizeOne); }
        function scrollToToday() { setTimeout(() => { const el = document.querySelector('.shift-card.today'); if(el) el.scrollIntoView({block:'center',behavior:'auto'}); }, 100); }
        function switchTab(t) { document.querySelectorAll('.page').forEach(p=>p.classList.remove('active')); document.getElementById('tab-'+t).classList.add('active'); document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active')); document.getElementById('nav-'+t)?.classList.add('active'); if(t==='home') scrollToToday(); if(t==='stats') renderStats(); }
        function changeStatsMonth(d) { statsDate.setMonth(statsDate.getMonth()+d); renderStats(); }
        function getSickYears(dStr) { const y = new Date(dStr || new Date()).getFullYear(); return [y-2, y-1]; }
        function setAutoDate() { document.getElementById('inpDate').valueAsDate = new Date(); }
        
        // --- –ó–ê–ü–£–°–ö ---
        function init() {
            if(shifts.length>0) {
                // –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è
                const map = new Map(); shifts.forEach(s => { if(s.date) map.set(s.date.substring(0,10), s); }); shifts = Array.from(map.values()); localStorage.setItem('metro_shifts', JSON.stringify(shifts));
            }
            normalizeShifts();
            render();
            updateUI();
            tg.ready(); tg.expand();
            if(tg.CloudStorage) { showLoader(); syncWithCloud(); } else { hideLoader(); }
            // –°–≤–∞–π–ø—ã –∏ –ø—Ä–æ—á–µ–µ
            document.addEventListener('touchstart', e => { touchStartX = e.changedTouches[0].screenX; touchStartY = e.changedTouches[0].screenY; }, {passive: false});
            document.addEventListener('touchend', e => { 
                if(document.body.classList.contains('modal-open')) return;
                let dx = e.changedTouches[0].screenX - touchStartX; 
                let dy = e.changedTouches[0].screenY - touchStartY;
                if(Math.abs(dx) > 70 && Math.abs(dy) < Math.abs(dx)) {
                    const tabs = ['today', 'home', 'stats', 'settings'];
                    let idx = tabs.indexOf(document.querySelector('.page.active').id.replace('tab-', ''));
                    if(dx < 0 && idx < 3) switchTab(tabs[idx+1]);
                    if(dx > 0 && idx > 0) switchTab(tabs[idx-1]);
                }
            }, {passive: false});
        }

        // –û—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ UI (addShift, openModal, etc) –æ—Å—Ç–∞–ª–∏—Å—å –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π, 
        // —Ç–∞–∫ –∫–∞–∫ –æ–Ω–∏ –ø—Ä–æ—Å—Ç–æ –≤—ã–∑—ã–≤–∞—é—Ç HTML —ç–ª–µ–º–µ–Ω—Ç—ã. 
        // –Ø –∏—Ö –Ω–µ –¥—É–±–ª–∏—Ä—É—é –∑–¥–µ—Å—å, —á—Ç–æ–±—ã –Ω–µ —Ä–∞–∑–¥—É–≤–∞—Ç—å –æ—Ç–≤–µ—Ç, 
        // –æ–Ω–∏ —É–∂–µ –µ—Å—Ç—å –≤ —Ç–≤–æ–µ–º —Ñ–∞–π–ª–µ. –ì–ª–∞–≤–Ω–æ–µ - –º—ã –∏—Å–ø—Ä–∞–≤–∏–ª–∏ renderStats –∏ calcShift.
        
        // –í–ù–ò–ú–ê–ù–ò–ï: –§—É–Ω–∫—Ü–∏–∏ render(), addShift(), openModal(), saveData(), syncWithCloud() 
        // –∏ –ø—Ä–æ—á–∏–µ –Ω—É–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —Ñ–∞–π–ª–∞ –∏–ª–∏ —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—é–¥–∞. 
        // –Ø —Å–æ–∫—Ä–∞—Ç–∏–ª –∏—Ö –∑–¥–µ—Å—å –¥–ª—è —è—Å–Ω–æ—Å—Ç–∏, –Ω–æ –≤ —Ä–µ–∞–ª—å–Ω–æ–º —Ñ–∞–π–ª–µ –æ–Ω–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å!
        
        // –ü–æ–ª–Ω—ã–π –∫–æ–¥ —ç—Ç–∏—Ö —Ñ—É–Ω–∫—Ü–∏–π –µ—Å—Ç—å –≤ —Ç–≤–æ–µ–º –∏—Å—Ö–æ–¥–Ω–∏–∫–µ. 
        // –ö–ª—é—á–µ–≤–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –≤—ã—à–µ - —ç—Ç–æ function calcShift –∏ function renderStats.
        
        function updateUI() {
            document.getElementById('set_rate').value = String(settings.rate).replace('.',',');
            document.getElementById('set_prem').value = String(settings.premP).replace('.',',');
            document.getElementById('set_class').value = settings.classP;
            document.getElementById('set_mentor').checked = settings.mentor;
            document.getElementById('set_senior').checked = settings.senior;
            document.getElementById('set_union').checked = settings.union;
            document.getElementById('set_start_date').value = settings.startDate;
            calcExpDisplay();
        }
        
        function saveAll() {
            settings.rate = safeFloat(document.getElementById('set_rate').value);
            settings.premP = safeFloat(document.getElementById('set_prem').value);
            settings.classP = parseInt(document.getElementById('set_class').value);
            settings.mentor = document.getElementById('set_mentor').checked;
            settings.senior = document.getElementById('set_senior').checked;
            settings.union = document.getElementById('set_union').checked;
            settings.startDate = document.getElementById('set_start_date').value;
            localStorage.setItem('metro_settings', JSON.stringify(settings));
            touchMeta('metro_settings');
            render();
        }
        
        function render(targetDate = null) {
        if (preventRender && !targetDate) return;

        const list = document.getElementById('shiftList');
        if(list.offsetHeight > 0) list.style.minHeight = list.offsetHeight + 'px';
        
        const scrollPos = window.scrollY; 
        
        const fragment = document.createDocumentFragment();
        shifts.sort((a,b) => new Date(a.date) - new Date(b.date));
        
        const todayStr = getIsoDate(new Date());
        let currentMonthStr = "";

        shifts.forEach((s) => {
            if (!s.text) s.text = ""; 

            const shiftDate = new Date(s.date); 
            const monthYear = shiftDate.toLocaleString('ru', { month: 'long', year: 'numeric' }); 
            const monthYearCap = monthYear.charAt(0).toUpperCase() + monthYear.slice(1);
            
            if(monthYearCap !== currentMonthStr) { 
                currentMonthStr = monthYearCap; 
                const divider = document.createElement('div'); 
                divider.className = 'month-header'; 
                divider.innerText = currentMonthStr; 
                fragment.appendChild(divider); 
            }

            let res = calcShift(s); 
            
            // --- 1. –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–ï –¢–ï–ö–°–¢–ê –ò –í–†–ï–ú–ï–ù–ò ---
            let title = s.text.split(' ')[0]; 
            let details = s.text.substring(title.length).trim();
            let lowerText = s.text.toLowerCase(); 

            // –°–ø–µ—Ü. —Ç–∏–ø—ã (–ë–õ, –û—Ç–ø—É—Å–∫...)
            const isSpecialType = lowerText.includes('–±–ª') || lowerText.includes('–±–æ–ª—å–Ω–∏—á–Ω—ã–π') || 
                                  lowerText.includes('–æ—Ç–ø—É—Å–∫') || lowerText.includes('–æ—Ç–ø') || 
                                  lowerText.includes('–¥–æ–Ω–æ—Ä') || lowerText.includes('–∫—Ä–æ–≤—å');

            if (isSpecialType) {
                // –ï—Å–ª–∏ –≤—ã—Ö–æ–¥–Ω–æ–π/–ø—Ä–∞–∑–¥–Ω–∏–∫ ‚Äî 0 —á–∞—Å–æ–≤ –≤—ã—á–µ—Ç–∞. –ï—Å–ª–∏ –±—É–¥–Ω–∏ ‚Äî 7.2.
                let val = !Logic.isWeekendOrHoliday(new Date(s.date)) ? 7.2 : 0;
                let hoursInfo = `(${val}—á)`;
                
                if(details) details += ` ${hoursInfo}`;
                else details = hoursInfo;
            }

            // –†–∞–±–æ—á–∏–µ —Å–º–µ–Ω—ã: –¥–æ–±–∞–≤–ª—è–µ–º (X.X—á) –≤ –∫–æ–Ω–µ—Ü —Å—Ç—Ä–æ–∫–∏
            if (res) {
                let extraInfo = "";

                if (res.isFullMed) {
                    extraInfo = `(${res.duration.toFixed(1)}—á)`;
                }
                else if (res.tpHours > 0) {
                     let pureWork = res.duration - res.tpHours;
                     extraInfo = `(${pureWork.toFixed(1)} + ${res.tpHours.toFixed(1)}—á –¢–ü)`;
                }
                else if (res.gapHours > 0) {
                    let pureWork = res.hours - res.gapHours;
                    extraInfo = `(${pureWork.toFixed(1)} + ${res.gapHours.toFixed(1)}—á)`;
                } 
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±—ã—á–Ω—É—é –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –¢–û–õ–¨–ö–û –µ—Å–ª–∏ —ç—Ç–æ –ù–ï —Å–ø–µ—Ü. —Ç–∏–ø (—á—Ç–æ–±—ã –Ω–µ –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å)
                else if (res.duration > 0 && !isSpecialType) {
                    extraInfo = `(${res.duration.toFixed(1)}—á)`;
                }
                
                if(details) details += " " + extraInfo;
                else details = extraInfo;
            }
            
            // --- 2. –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–ï –¢–ï–ì–û–í ---
            let tags = '';
            
            if (s.isFullMedical) {
                tags += '<span class="tag" style="background:#d32f2f;">‚õî –û–¢–°–¢–†–ê–ù–ï–ù–ò–ï</span> ';
            }
            if (lowerText.includes('–±–ª') || lowerText.includes('–±–æ–ª—å–Ω–∏—á–Ω—ã–π')) {
                tags += '<span class="tag red">–ë–û–õ–¨–ù–ò–ß–ù–´–ô</span> ';
            }
            if (lowerText.includes('–æ—Ç–ø—É—Å–∫') || lowerText.includes('–æ—Ç–ø')) {
                tags += '<span class="tag" style="background: linear-gradient(135deg, #4fc3f7, #2196f3);">–û–¢–ü–£–°–ö</span> ';
            }
            if (lowerText.includes('–¥–æ–Ω–æ—Ä') || lowerText.includes('–∫—Ä–æ–≤—å')) {
                tags += '<span class="tag donor" style="background:#ab47bc;">–î–û–ù–û–†</span> ';
            }

            // –ü—Ä–∞–∑–¥–Ω–∏–∫–∏ (–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ —Å—Ç—Ä–æ–∫–µ –¥–∞—Ç—ã, —á—Ç–æ–±—ã –Ω–µ –∑–∞–≤–∏—Å–µ—Ç—å –æ—Ç –ø–æ—è—Å–æ–≤)
            const md = s.date.substring(5, 10); // "01-01"
            const isNonWork = isSpecialType || lowerText.includes('–≤—ã—Ö–æ–¥–Ω–æ–π') || lowerText.includes('–≤—ã—Ö');
            
            if (Logic.holidaysData.fixed.includes(md) && !isNonWork) {
                tags += '<span class="tag" style="background:#e91e63;">üéâ –ü–†–ê–ó–î–ù–ò–ö x2</span> ';
            }

            if (s.isShortBreak) tags += '<span class="tag purple">üîó –ù–ï–†–ê–ó–†–´–í–ù–ê–Ø</span> ';

            if (res) { 
                if (res.isTrain) {
                     if (lowerText.includes('–º–µ–¥') || lowerText.includes('–∫–æ–º–∏—Å—Å') || lowerText.includes('–ø—Å–∏—Ö')) {
                        tags += '<span class="tag teal" style="background:#00897b">–ú–ï–î. –ö–û–ú–ò–°–°–ò–Ø</span> ';
                    } else {
                        tags += '<span class="tag teal">–û–ë–£–ß–ï–ù–ò–ï</span> ';
                    }
                }
                // –†–µ–∑–µ—Ä–≤ (–∏—Å–∫–ª—é—á–∞–µ–º –ø–æ–ª–Ω–æ–µ –æ—Ç—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –¥–≤—É—Ö —Ç–µ–≥–æ–≤)
                if (res.isRes && !res.isFullMed) tags += '<span class="tag gray">–†–ï–ó–ï–†–í</span> '; 
                if (s.lineStart) tags += '<span class="tag orange">–í–´–ï–ó–î</span> '; 
                if (res.isTech) tags += '<span class="tag teal">+–£–ß–ï–ë–ê</span> '; 
            }
            if (s.note && s.note.trim() !== "") tags += '<span class="note-icon">üìå</span>'; 

            let div = document.createElement('div'); 
            div.className = 'shift-card'; 
            
            if(s.date === todayStr) { 
                div.classList.add('today'); 
                div.innerHTML = `<div class="today-badge">–°–ï–ì–û–î–ù–Ø</div>`; 
            }
            div.onclick = () => openDayModal(s.date);
            div.id = 'card-' + s.date; 
            
            // –õ–æ–≥–∏–∫–∞ "–ë—É–¥—É—â–µ–µ/–ü—Ä–æ—à–ª–æ–µ" –¥–ª—è —Ü–≤–µ—Ç–∞ –¥–µ–Ω–µ–≥
            let isDone = false;
            let now = new Date();
            let todayZero = new Date(now); todayZero.setHours(0,0,0,0);
            let sDateZero = new Date(s.date); sDateZero.setHours(0,0,0,0);

            if (sDateZero < todayZero) {
                isDone = true; 
            } else if (sDateZero.getTime() === todayZero.getTime()) {
                // –ï—Å–ª–∏ —Å–µ–≥–æ–¥–Ω—è - –ø—Ä–æ–≤–µ—Ä—è–µ–º –≤—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è
                let parsedT = Logic.parseShift(s.text, s.date);
                if (parsedT && parsedT.endTimestamp && now > parsedT.endTimestamp) isDone = true;
            }

            let moneyHTML = ''; 
            if (res && res.net > 0) { 
                const moneyClass = isDone ? 'money-val' : 'money-val future'; 
                moneyHTML = `<div class="${moneyClass}">+${res.net}</div>`; 
            }
            
            let d = new Date(s.date);
            
            // –í—Å—Ç–∞–≤–ª—è–µ–º –≤—Å—ë –Ω–∞ –º–µ—Å—Ç–æ
            div.innerHTML += `
                <div class="date-box">
                    <span class="date-day">${d.getDate()}</span>
                    <span class="date-dow">${d.toLocaleString('ru',{weekday:'short'})}</span>
                </div>
                <div class="shift-info">
                    <div class="shift-title">${title} ${tags}</div>
                    <div class="shift-sub">${details}</div>
                </div>
                <div style="text-align:right">${moneyHTML}</div>`;
                
            fragment.appendChild(div);
        });
        
        list.innerHTML = '';
        list.appendChild(fragment);
        renderStats();

        setTimeout(() => {
            list.style.minHeight = ''; 
            if (targetDate) {
                const el = document.getElementById('card-' + targetDate);
                if(el) el.scrollIntoView({block: "center", behavior: "auto"});
            } 
            else if (isFirstLoad) {
                const todayEl = document.querySelector('.shift-card.today');
                if (todayEl) todayEl.scrollIntoView({ block: "center", behavior: "auto" });
                isFirstLoad = false; 
            } else {
                window.scrollTo(0, scrollPos);
            }
        }, 50);
    }

        // –ó–∞–ø—É—Å–∫
        init();
    </script>
</body>
</html>